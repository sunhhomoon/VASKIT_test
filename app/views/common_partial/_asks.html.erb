<script type="text/template" id="ask-template">
  <div id="ask_box_{{=ask.id}}" class="ask_box">
    <div id="ask_{{=ask.id}}" class="content_box" style="margin:15px 12px;">
      <div id="ask_{{=ask.id}}_category" class="table_div" style="margin-bottom:0px;">
        <a class="more_icon" href="#" onclick="show_menu({{=ask.id}}); return false;"><i class="fa fa-chevron-down" style="font-size:10px; color:#998674;"></i></a>
        {{ if (ask.category) { }}
          <span class="category" onclick="if (!is_card_opened && !is_show_opened) category_on(); return false;">{{= ask.category.name }}</span>
        {{ }else{ }}
          <span class="category none" onclick="if (!is_card_opened && !is_show_opened) category_on(); return false;">관심사 미설정</span>
        {{ } }}
        {{ var already_like_ask = $.grep(my_like_ask, function(obj) { return obj.ask_id === ask.id }) }}
        <span class="like_icon" onclick="ask_like({{=ask.id}}); return false;" onmouseover="$(this).children().animateCss('tada');">
          공감해요&nbsp;<i id="ask_{{=ask.id}}_like_icon" class="fa {{= already_like_ask.length == 1 ? 'fa-heart' : 'fa-heart-o'}}"></i>
        </span>
      </div>
      <div id="ask_{{=ask.id}}_menu" class="table_div" style="display:none; margin-bottom:0; background-color:oldlace;"></div>
      <div id="ask_{{=ask.id}}_user" class="table_div" style="margin-bottom:0; height:30px; line-height:30px; padding:0 10px; background-color:ghostwhite; border-top:1px solid #dbdbdb; border-bottom:1px solid #dbdbdb;">
        {{ if (ask.user) { }}
          {{ if (ask.user.id == 1) { }}
            <span style="margin:0px 5px 0px 0px; font-size:10px; float:left; font-weight:bold; opacity:0.8; color:#ee6e01;">
              <i class="fa fa-star" style="margin-right:2px;"></i>운영자
            </span>
          {{ }else if (ask.user.id == current_user_id) { }}
            <span style="margin:0px 5px 0px 0px; font-size:10px; float:left; font-weight:bold; opacity:0.8; color:#ee6e01;">
              <i class="fa fa-user" style="margin-right:2px;"></i>my
            </span>
          {{ } else { }}
            <span style="margin:0px 5px 0px 0px; font-size:10px; float:left; font-weight:bold; opacity:0.8; {{= !ask.user.gender ? 'color:#ea065e;' : 'color:#0389ed;' }}">
              {{ if (ask.user.gender){ }}
                <i class="fa fa-male" style="margin-right:-2px;"></i>
              {{ }else{ }}
                <i class="fa fa-female" style="margin-right:-2px;"></i>
              {{ } }}
              {{= get_user_ages(ask.user.birthday) }}
            </span>
          {{ } }}
          <a href="#" onclick="go_url('/?keyword={{= ask.user.string_id }}&type=user'); return false;">
            <span style="color:#998674; font-size:14px; float:left; max-width:150px; overflow:hidden; text-overflow:ellipsis;">{{= ask.user.string_id }}</span>
          </a>
          <span style="float:right; color:#9d9ea1; font-size:12px;">
            <i class="fa fa-heart" style="font-size:12px; margin:0 3px;"></i><span id="ask_{{=ask.id}}_like_count" style="display:inline-block;">{{= ask.like_count }}공감</span>
            <i class="fa fa-check-circle-o" style="font-size:13px; margin:0 3px;"></i><span id="ask_{{=ask.id}}_vote_count" style="display:inline-block;">{{= ask.left_ask_deal.vote_count + ask.right_ask_deal.vote_count}}표</span>
            <i class="fa fa-clock-o" style="font-size:13px; margin:0 3px;"></i>{{= get_past_time(ask.created_at) }}
          </span>
        {{ } }}
      </div>
      <div id="ask_deal_{{=ask.id}}" class="table_div" style="margin-bottom:0px;">
        {{= askDealTemplate({my_votes: my_votes, ask: ask}) }}
      </div>
      {{ if (ask.be_completed == true) { }}
        <div style="color:#fff; background-color:#4b3d3d; padding:5px; font-size: 12px;">종료된 투표입니다</div>
      {{ } }}
      <div id="detail_vote_count_{{=ask.id}}" class="table_div" style="display:none; margin-bottom:0px; background-color:#f0f2f4; color:#666; font-size: 12px; border-bottom:1px solid #dbdbdb; height:50px; overflow:hidden;">
        <i class="fa fa-spinner fa-spin" style="font-size:15px; line-height:50px;"></i>
      </div>
      <div id="ask_deal_{{=ask.id}}_table" class="table_div" style="display:none; margin-bottom:0px; border-bottom:1px solid #dbdbdb;">
        {{= askDealTableTemplate({ask: ask}) }}
      </div>
      <div id="ask_{{=ask.id}}_message" class="table_div" style="margin-bottom:0px; color:#383838; font-size:13px; line-height:2; padding:15px;">
        <div id="ask_{{=ask.id}}_message_text">
          {{ if(ask.message){ }}
            {{ var ask_message = ask.message.replace(new RegExp('<', 'g'), '&lt;').replace(new RegExp('\r?\n', 'g'), '<br>') }}
            {{= ask_message }}
          {{ }else{ }}
            저의 결정장애 극복을 도와주세요! 둘 중에 뭐를 사야 하죠?
          {{ } }}
        </div>
        <span id="ask_{{=ask.id}}_message_text_shorten" style="display:none;"></span>
        <a id="ask_{{=ask.id}}_message_more" href="#" style="float:right; margin:0px 5px; color:#998674; cursor:pointer; display:none;" onclick="$('#ask_{{=ask.id}}_message_text').show(); $('#ask_{{=ask.id}}_message_text_shorten').hide(); $(this).hide(); return false;"><i class="fa fa-angle-down">&nbsp;more</i></a>
      </div>
      <div id="ask_{{=ask.id}}_comment" class="table_div" style="display:none; margin-bottom:0px; overflow:hidden;"></div>
      <div id="ask_{{=ask.id}}_detail_btn" class="table_div" style="margin-bottom:0px;">
        {{= askDetailBtnTemplate({ask: ask}) }}
      </div>
    </div>
  </div>
</script>

<script type="text/template" id="ask-menu-template">
  {{ var already_vote = $.grep(my_votes, function(obj) { return obj.ask_id === ask.id }) }}
  <div style="padding:15px 0 8px 0; border-top:1px solid #dbdbdb;">
    {{ if (ask.user.id == current_user_id) { }}
      <p id="share_icon_{{=ask.id}}" style="color:#666; font-size:13px; margin:0; padding:0 0 10px 0;"><i class="fa fa-send-o"></i>&nbsp;친구들에게 질문을 공유해보세요!</p>
    {{ } else { }}
      <p id="share_icon_{{=ask.id}}" style="color:#666; font-size:13px; margin:0; padding:0 0 10px 0;"><i class="fa fa-send-o"></i>&nbsp;흥미로운 질문을 공유해보세요!</p>
    {{ } }}
    <table style="width:100%; height:100%; text-align:center; color:#fff;">
      <tr style="vertical-align:bottom;">
        <td style="width:45%;">
          <span id="share_facebook_btn_{{ask.id}}" onclick="share_facebook({{=ask.id}}); hide_menu({{=ask.id}}); return false;" style="display:inline-block; width:60px; height:60px; line-height:75px; background-color:#4267b2; border-radius:10px; margin:0px; vertical-align:top; cursor:pointer;">
            <i class="fa fa-facebook" style="font-size:30px;"></i>
          </span>
        </td>
        <td style="width:10%;">
          <span id="share_katalk_btn_{{=ask.id}}" onclick="share_katalk({{=ask.id}}); hide_menu({{=ask.id}}); return false;" style="display:inline-block; width:60px; height:60px; line-height:70px; background-color:#fae100; border-radius:10px; margin:0px; vertical-align:top; cursor:pointer;">
            <img src="/images/logo/share_kakaotalk.png" alt="" style="width:38px; margin:13px auto 0px;">
          </span>
        </td>
        <td style="width:45%;">
          <span id="share_url_btn_{{=ask.id}}" onclick="copy_url({{=ask.id}}); hide_menu({{=ask.id}}); return false;" style="display:inline-block; width:60px; height:60px; line-height:70px; background-color:#9d9ea1; border-radius:10px; margin:0px; vertical-align:top; cursor:pointer;">
            <i class="fa fa-link" style="font-size:24px;"></i>
          </span>
        </td>
      </tr>
      <tr style="vertical-align:top;">
        <td><span onclick="share_facebook({{=ask.id}}); return false;" style="color:#4267b2; font-size:13px; cursor:pointer; font-weight:bold;">페이스북</span></td>
        <td><span onclick="share_katalk({{=ask.id}}); return false;" style="color:#fae100; font-size:13px; cursor:pointer; font-weight:bold;">카카오톡</span></td>
        <td><span onclick="copy_url({{=ask.id}}); return false;" style="color:#9d9ea1; font-size:13px; cursor:pointer; font-weight:bold;">주소복사</span></td>
      </tr>
    </table>
    <input id="share_url_{{=ask.id}}" style="position:fixed; top:100%; left:100%;" value="http://vaskit.kr/asks/{{=ask.id}}"/>
  </div>
  {{ if (ask.user.id == current_user_id) { }}
    {{ if (ask.be_completed == false) { }}
      <a id="ask_edit_btn_{{=ask.id}}" href="#" onclick="go_url('/asks/{{=ask.id}}/edit'); return false;" style="display:block; line-height:40px; border-top:1px solid #dbdbdb; color:#666; font-size:13px; width:50%; float:left; margin-right:-1px; border-right:1px solid #dbdbdb;"><i class="fa fa-edit" style="color:#9d9ea1;"></i>&nbsp;수정하기</a>
      <a id="ask_complete_btn_{{=ask.id}}" href="#" onclick="go_url('/asks/{{=ask.id}}/ask_complete'); return false;" style="display:block; line-height:40px; border-top:1px solid #dbdbdb; color:#666; font-size:13px; width:50%; float:left;"><i class="fa fa-paperclip" style="color:#9d9ea1;"></i>&nbsp;질문 종료하기</a>
    {{ } else { }}
      <a id="ask_edit_btn_{{=ask.id}}" href="#" onclick="notify('이미 종료하신 투표는 수정하실 수 없습니다'); hide_menu({{=ask.id}}); return false;" style="display:block; line-height:40px; border-top:1px solid #dbdbdb; color:#666; font-size:13px; width:50%; float:left; margin-right:-1px; border-right:1px solid #dbdbdb;"><i class="fa fa-edit" style="color:#9d9ea1;"></i>&nbsp;수정하기</a>
      <a id="ask_complete_btn_{{=ask.id}}" href="#" onclick="notify('이미 종료하신 투표입니다'); hide_menu({{=ask.id}}); return false;" style="display:block; line-height:40px; border-top:1px solid #dbdbdb; color:#666; font-size:13px; width:50%; float:left;"><i class="fa fa-paperclip" style="color:#9d9ea1;"></i>&nbsp;질문 종료하기</a>
    {{ } }}
  {{ } else { }}
    <a id="ask_report_btn_{{=ask.id}}" href="#" onclick="show_report_popup('ask', {{=ask.id}}); return false;" style="display:block; line-height:40px; border-top:1px solid #dbdbdb; color:#666; font-size:13px; width:50%; float:left; margin-right:-1px; border-right:1px solid #dbdbdb;"><i class="fa fa-cab" style="color:#9d9ea1; font-size:12px;"></i>&nbsp;신고하기</a>
    {{ if (already_vote.length > 0) { }}
      <a id="vote_modify_btn_{{=ask.id}}" href="#" onclick="vote_modify({{=ask.id}}); return false;" style="display:block; line-height:40px; border-top:1px solid #dbdbdb; color:#666; font-size:13px; width:50%; float:left;"><i class="fa fa-rotate-left" style="color:#9d9ea1;"></i>&nbsp;투표 실행취소</a>
    {{ } else { }}
      <a id="vote_modify_btn_{{=ask.id}}" href="#" onclick="notify('투표에 먼저 참여해주세요!'); hide_menu({{=ask.id}}); return false;" style="display:block; line-height:40px; border-top:1px solid #dbdbdb; color:#666; font-size:13px; width:50%; float:left;"><i class="fa fa-rotate-left" style="color:#9d9ea1;"></i>&nbsp;투표 실행취소</a>
    {{ } }}
  {{ } }}
</script>

<script type="text/template" id="ask-deal-template">
	{{ var left_ask_deal = ask.left_ask_deal }}
	{{ var right_ask_deal = ask.right_ask_deal }}
	{{ var already_vote = $.grep(my_votes, function(obj) { return obj.ask_id === ask.id }) }}
	<div class="table_div" style="margin-bottom:0;">
		<div class="table_div" style="margin-bottom:0; width:50%; overflow:hidden; float:left;">
			<a href="#" onclick="ask_image_on({{=ask.id}}, {{=ask.left_ask_deal_id}}, true); return false;">
				<img src='{{= get_image_url(left_ask_deal, "ask_deals", "normal") }}' class="card_image_{{=ask.id}} card_image left_card_image" onerror="imgError(this);"/>
				<span class="card_image_hover_{{=ask.id}} card_image_hover left_card_image_hover" style="position:absolute; top:0; left:0; width:100%; height:100%; background-color:#ffe4a9; opacity:0.5; display:none;"></span>
				<p class="card_image_expander"><i class="fa fa-expand"></i></p>
			</a>
			{{ if( ask.user_id == current_user_id || already_vote.length != 0 || ask.be_completed){ }}
				{{ if ((ask.user_id == current_user_id || ask.be_completed) || ask.right_ask_deal_id == already_vote[0].ask_deal_id){ }}
					<a href="#" onclick="ask_image_on({{=ask.id}}, {{=ask.left_ask_deal_id}}, true); return false;" class="card_image_overlay_{{=ask.id}} card_image_overlay_lose card_image_overlay"></a>
				{{ }else if(ask.left_ask_deal_id == already_vote[0].ask_deal_id){ }}
					<a href="#" onclick="ask_image_on({{=ask.id}}, {{=ask.left_ask_deal_id}}, true); return false;" class="card_image_overlay_{{=ask.id}} card_image_overlay_win card_image_overlay">
            <i class="fa fa-check-circle" style="position:absolute; width:80px; height:80px; top:50%; left:50%; margin-top:-38px; margin-left:-40px; font-size:80px; color:#fff; font-weight:bold;"></i>
					</a>
				{{ } }}
			{{ } }}
			{{ if( ask.user_id != current_user_id && already_vote.length == 0 && ask.be_completed == false ){ }}
				<a class="vote_btn_{{=ask.id}} vote_btn left_btn" href="#" onclick="vote_ask_deal({{=ask.id}}, {{=left_ask_deal.id}}, true); return false;"><i class="fa fa-caret-left"></i><i class="fa fa-caret-left"></i><i class="fa fa-caret-left"></i>&nbsp;투표하기</a>
			{{ } }}
		</div>
		<div class="table_div" style="margin-bottom:0; width:50%; overflow:hidden; float:right;">
			<a href="#" onclick="ask_image_on({{=ask.id}}, {{=ask.right_ask_deal_id}}, false); return false;">
				<img src='{{= get_image_url(right_ask_deal, "ask_deals", "normal") }}' class="card_image_{{=ask.id}} card_image right_card_image" onerror="imgError(this);"/>
				<span class="card_image_hover_{{=ask.id}} card_image_hover right_card_image_hover" style="position:absolute; top:0; left:0; width:100%; height:100%; background-color:#ffe4a9; opacity:0.5; display:none;"></span>
				<p class="card_image_expander"><i class="fa fa-expand"></i></p>
			</a>
			{{ if( ask.user_id == current_user_id || already_vote.length != 0 || ask.be_completed){ }}
				{{ if ((ask.user_id == current_user_id || ask.be_completed) || ask.left_ask_deal_id == already_vote[0].ask_deal_id){ }}
					<a href="#" onclick="ask_image_on({{=ask.id}}, {{=ask.right_ask_deal_id}}, false); return false;" class="card_image_overlay_{{=ask.id}} card_image_overlay_lose card_image_overlay"></a>
				{{ }else if(ask.right_ask_deal_id == already_vote[0].ask_deal_id){ }}
					<a href="#" onclick="ask_image_on({{=ask.id}}, {{=ask.right_ask_deal_id}}, false ); return false;" class="card_image_overlay_{{=ask.id}} card_image_overlay_win card_image_overlay">
						<i class="fa fa-check-circle" style="position:absolute; width:80px; height:80px; top:50%; left:50%; margin-top:-38px; margin-left:-40px; font-size:80px; color:#fff; font-weight:bold;"></i>
					</a>
				{{ } }}
			{{ } }}
			{{ if( ask.user_id != current_user_id && already_vote.length == 0 && ask.be_completed == false ){ }}
				<a class="vote_btn_{{=ask.id}} vote_btn right_btn" href="#" onclick="vote_ask_deal({{=ask.id}}, {{=right_ask_deal.id}}, false); return false;" style="border-left:1px solid #fff;">투표하기&nbsp;<i class="fa fa-caret-right"></i><i class="fa fa-caret-right"></i><i class="fa fa-caret-right"></i></a>
			{{ } }}
		</div>
	</div>
	{{ if( ask.user_id == current_user_id || already_vote.length != 0 || ask.be_completed){ }}
		<div id="main_vote_count_{{=ask.id}}">
			{{ var total_count = ask.left_ask_deal.vote_count + ask.right_ask_deal.vote_count }}
			{{ if (ask.user_id == current_user_id && total_count == 0){ }}
				{{ var left_ratio = 0 }}
				{{ var left_ratio_full = 0 }}
				{{ var right_ratio = 0 }}
				{{ var right_ratio_full = 0 }}
			{{ }else{ }}
				{{ var left_ratio = Math.round(ask.left_ask_deal.vote_count/total_count * 80) }}
				{{ var left_ratio_full = Math.round(ask.left_ask_deal.vote_count/total_count * 100) }}
				{{ var right_ratio = Math.round(ask.right_ask_deal.vote_count/total_count * 80) }}
				{{ var right_ratio_full = Math.round(ask.right_ask_deal.vote_count/total_count * 100) }}
			{{ } }}

			{{ var left_background = "#ffcc5a" }}
			{{ var left_font_weight = "bold" }}
			{{ var right_background = "#ffcc5a" }}
			{{ var right_font_weight = "bold" }}
			{{ if (left_ratio > right_ratio){ }}
				{{ right_background = "#fff" }}
				{{ right_font_weight = "normal" }}
			{{ }else if(left_ratio < right_ratio){ }}
				{{ left_background = "#fff" }}
				{{ left_font_weight = "normal" }}
			{{ } }}
			<table cellspacing="0" cellpadding="0" style="width:100%; background-color:rgba(75,61,61,0.9); color:#fff; font-size:12px; font-weight:bold; height:40px;">
				<tr>
					<td class="vote-result-td">
						<span id="left_bar_{{=ask.id}}" class="vote-result-bar-left" style="width:{{=left_ratio}}%; background-color:{{=left_background}};">&nbsp;</span>
						<span id="left_num_{{=ask.id}}" class="vote-result-num-left" style="float:right; margin-right:3px; font-weight:{{=left_font_weight}}; color:{{=left_background}};">{{=left_ratio_full}}%</span>
					</td>
					<td class="vote-result-td-title">
						A vs B
					</td>
					<td class="vote-result-td">
						<span id="right_bar_{{=ask.id}}" class="vote-result-bar-right" style="width:{{=right_ratio}}%; background-color:{{=right_background}};">&nbsp;</span>
						<span id="right_num_{{=ask.id}}" class="vote-result-num-right" style="float:left; margin-left:3px; font-weight:{{=right_font_weight}}; color:{{=right_background}};">{{=right_ratio_full}}%</span>
					</td>
				</tr>
			</table>
		</div>
	{{ } }}
  {{ if( ask.user_id != current_user_id && already_vote.length != 0){ }}
    {{ if(ask.left_ask_deal_id == already_vote[0].ask_deal_id){ }}
      {{ var ask_deal_id = ask.left_ask_deal_id }}
      {{ var is_left = true }}
    {{ }else{ }}
      {{ var ask_deal_id = ask.right_ask_deal_id }}
      {{ var is_left = false }}
    {{ } }}
    <div id="mini_new_comment_{{=ask.id}}" class="table_div" style="background-color:#f18b33; text-align:left; margin-bottom:0; display:none;">
      <div id="mini_comment_input_box_{{=ask.id}}" style="border:1px solid #ee6e01; background-color:#fff; transition:all .5s; transform:rotateX(180deg); -webkit-transform:rotateX(180deg); -webkit-backface-visibility:hidden; backface-visibility:hidden;">
        <textarea id="mini_comment_input_{{=ask.id}}" class="comment_box" placeholder="<% if current_user %>고민해결사 <%= current_user.string_id %>님! 한마디 부탁해요!<% else %>회원가입하시고 의견을 남겨주세요!<% end %>" style="display:block; padding:10px 70px 10px 40px; width:100%; min-width:100%; max-width:100%; height:40px; box-sizing:border-box; border:none; color:#383838; background-color:#fff; border-radius:0; font-size:13px; line-height:20px; text-align:{{=is_left ? 'left' : 'right'}};"></textarea>
        <a id="mini_ask_deal_id_change_{{=ask.id}}" onclick="mini_ask_deal_id_change({{=ask.id}}, {{=ask.left_ask_deal_id}}, {{=ask.right_ask_deal_id}}, {{=is_left}}); return false;" href="#" style="position:absolute; top:0px; left:0px; width:40px; height:40px; line-height:40px; text-align:center; color:#ee6e01; background-color:#fff; font-size:14px;"><i class="fa fa-align-left {{=is_left ? '' : 'fa-flip-horizontal'}}" style="transition:transform .5s;"></i></a>
        <a id="mini_send_comment_btn_{{=ask.id}}" class="comment_update_btn" href="#" onclick="mini_send_comment({{=ask.id}}, {{=ask_deal_id}}, {{=is_left}}); return false;" style="position:absolute; top:0; right:0; display:block; width:60px; height:40px; background-color:#dbdbdb; color:#fff; text-align:center; line-height:40px; font-size:12px; border-radius:0; transition:all .5s;">보내기</a>
      </div>
      <div id="mini_comment_notify_{{=ask.id}}" class="comment_title already_vote" style="position:absolute; top:0; left:0; width:100%; height:100%; background-color:#f3994d; transition:all .5s; transform:rotateX(0deg); -webkit-transform:rotateX(0deg); -webkit-backface-visibility:hidden; backface-visibility:hidden;">당신의 의견을 남겨주세요&nbsp;<i class="fa fa-keyboard-o" style="font-size:16px;"></i></div>
    </div>
  {{ } }}
</script>

<script type="text/template" id="detail-vote-count-template">
	{{ var gender_total_count = detail_vote_count.left.male_count + detail_vote_count.left.female_count + detail_vote_count.right.male_count + detail_vote_count.right.female_count }}
	{{ if ( gender_total_count == 0 ){ }}
		{{ var male_left_ratio = 0 }}
		{{ var male_right_ratio = 0 }}
		{{ var female_left_ratio = 0 }}
		{{ var female_right_ratio = 0 }}
	{{ }else{ }}
		{{ var male_left_ratio = Math.round(detail_vote_count.left.male_count/gender_total_count * 80) }}
		{{ var male_right_ratio = Math.round(detail_vote_count.right.male_count/gender_total_count * 80) }}
		{{ var female_left_ratio = Math.round(detail_vote_count.left.female_count/gender_total_count * 80) }}
		{{ var female_right_ratio = Math.round(detail_vote_count.right.female_count/gender_total_count * 80) }}
	{{ } }}

	{{ var gender_male_css = "" }}
	{{ var gender_female_css = "" }}
	{{ var gender_male_background_css = "" }}
	{{ var gender_female_background_css = "" }}
	{{ if( (gender_total_count != 0 && (detail_vote_count.left.male_count + detail_vote_count.right.male_count) <= (detail_vote_count.left.female_count + detail_vote_count.right.female_count)) ){ }}
		{{ gender_female_css = "color:#ffcc5a; font-weight:bold;" }}
		{{ gender_female_background_css = "background-color:rgba(255,228,169,0.7);" }}
  {{ } }}
	{{ if( (gender_total_count != 0 && (detail_vote_count.left.male_count + detail_vote_count.right.male_count) >= (detail_vote_count.left.female_count + detail_vote_count.right.female_count)) ){ }}
		{{ gender_male_css = "color:#ffcc5a; font-weight:bold;" }}
		{{ gender_male_background_css = "background-color:rgba(255,228,169,0.7);" }}
	{{ } }}
	<table cellspacing="0" cellpadding="1" class="graph" style="padding:10px; border-top:1px solid #dbdbdb; border-bottom:1px solid #dbdbdb;">
		<tbody>
			<tr style="{{=gender_male_background_css}}">
				<td class="vote-result-td">
					<span class="vote-result-bar-left" style="width:{{= Math.round(male_left_ratio)}}%; background-color:{{= (male_left_ratio >= male_right_ratio) ? '#ffcc5a;' : '#cbcbcb;' }}">&nbsp;</span>
					<span class="vote-result-num-left" style="float:right; margin-right:3px; font-size:11px; padding-top:1px; {{= (male_left_ratio >= male_right_ratio) ? 'color:#ffcc5a;' : 'color:#cbcbcb;' }}">{{= (detail_vote_count.left.male_count ==0) ? "-" : detail_vote_count.left.male_count+"명"}}</span>
				</td>
				<td class="vote-result-td-title" style="{{=gender_male_css}}">
					남자
				</td>
				<td class="vote-result-td">
					<span class="vote-result-bar-right" style="width:{{= Math.round(male_right_ratio) }}%; background-color:{{= (male_left_ratio <= male_right_ratio) ? '#ffcc5a;' : '#cbcbcb;' }};">&nbsp;</span>
					<span class="vote-result-num-right" style="float:left; margin-left:3px; font-size:11px; padding-top:1px; {{= (male_left_ratio <= male_right_ratio) ? 'color:#ffcc5a;' : 'color:#cbcbcb;' }}">{{= (detail_vote_count.right.male_count ==0) ? "-" : detail_vote_count.right.male_count+"명"}}</span>
				</td>
			</tr>
			<tr style="{{=gender_female_background_css}}">
				<td class="vote-result-td">
					<span class="vote-result-bar-left" style="width:{{= Math.round(female_left_ratio) }}%; background-color:{{= (female_left_ratio >= female_right_ratio) ? '#ffcc5a;' : '#cbcbcb;' }};">&nbsp;</span>
					<span class="vote-result-num-left" style="float:right; margin-right:3px; font-size:11px; padding-top:1px; {{= (female_left_ratio >= female_right_ratio) ? 'color:#ffcc5a;' : 'color:#cbcbcb;' }}">{{= (detail_vote_count.left.female_count ==0) ? "-" : detail_vote_count.left.female_count+"명"}}</span>
				</td>
				<td class="vote-result-td-title" style="{{=gender_female_css}}">
					여자
				</td>
				<td class="vote-result-td">
					<span class="vote-result-bar-right" style="width:{{= Math.round(female_right_ratio) }}%; background-color: {{= (female_left_ratio <= female_right_ratio) ? '#ffcc5a;' : '#cbcbcb;' }};">&nbsp;</span>
					<span class="vote-result-num-right" style="float:left; margin-left:3px; font-size:11px; padding-top:1px; {{= (female_left_ratio <= female_right_ratio) ? 'color:#ffcc5a;' : 'color:#cbcbcb;' }}">{{= (detail_vote_count.right.female_count ==0) ? "-" : detail_vote_count.right.female_count+"명"}}</span>
				</td>
			</tr>
		</tbody>
	</table>
	{{ var age_total_count = detail_vote_count.left.age_20_1_count + detail_vote_count.left.age_20_2_count + detail_vote_count.left.age_20_3_count + detail_vote_count.left.age_30_1_count + detail_vote_count.left.age_30_2_count + detail_vote_count.left.age_30_3_count + detail_vote_count.left.etc_count + detail_vote_count.right.age_20_1_count + detail_vote_count.right.age_20_2_count + detail_vote_count.right.age_20_3_count + detail_vote_count.right.age_30_1_count + detail_vote_count.right.age_30_2_count + detail_vote_count.right .age_30_3_count + detail_vote_count.right.etc_count }}
	{{ if ( age_total_count == 0 ){ }}
		{{ var age_20_1_left_ratio = 0 }}
		{{ var age_20_1_right_ratio = 0 }}
		{{ var age_20_2_left_ratio = 0 }}
		{{ var age_20_2_right_ratio = 0 }}
		{{ var age_20_3_left_ratio = 0 }}
		{{ var age_20_3_right_ratio = 0 }}
		{{ var age_30_1_left_ratio = 0 }}
		{{ var age_30_1_right_ratio = 0 }}
		{{ var age_30_2_left_ratio = 0 }}
		{{ var age_30_2_right_ratio = 0 }}
		{{ var age_30_3_left_ratio = 0 }}
		{{ var age_30_3_right_ratio = 0 }}
		{{ var etc_left_ratio = 0 }}
		{{ var etc_right_ratio = 0 }}
	{{ }else{ }}
		{{ var age_20_1_left_ratio = Math.round(detail_vote_count.left.age_20_1_count/age_total_count * 80) }}
		{{ var age_20_1_right_ratio = Math.round(detail_vote_count.right.age_20_1_count/age_total_count * 80) }}
		{{ var age_20_2_left_ratio = Math.round(detail_vote_count.left.age_20_2_count/age_total_count * 80) }}
		{{ var age_20_2_right_ratio = Math.round(detail_vote_count.right.age_20_2_count/age_total_count * 80) }}
		{{ var age_20_3_left_ratio = Math.round(detail_vote_count.left.age_20_3_count/age_total_count * 80) }}
		{{ var age_20_3_right_ratio = Math.round(detail_vote_count.right.age_20_3_count/age_total_count * 80) }}
		{{ var age_30_1_left_ratio = Math.round(detail_vote_count.left.age_30_1_count/age_total_count * 80) }}
		{{ var age_30_1_right_ratio = Math.round(detail_vote_count.right.age_30_1_count/age_total_count * 80) }}
		{{ var age_30_2_left_ratio = Math.round(detail_vote_count.left.age_30_2_count/age_total_count * 80) }}
		{{ var age_30_2_right_ratio = Math.round(detail_vote_count.right.age_30_2_count/age_total_count * 80) }}
		{{ var age_30_3_left_ratio = Math.round(detail_vote_count.left.age_30_3_count/age_total_count * 80) }}
		{{ var age_30_3_right_ratio = Math.round(detail_vote_count.right.age_30_3_count/age_total_count * 80) }}
		{{ var etc_left_ratio = Math.round(detail_vote_count.left.etc_count/age_total_count * 80) }}
		{{ var etc_right_ratio = Math.round(detail_vote_count.right.etc_count/age_total_count * 80) }}
	{{ } }}

	{{ var age_20_1_css = "" }}
	{{ var age_20_2_css = "" }}
	{{ var age_20_3_css = "" }}
	{{ var age_30_1_css = "" }}
	{{ var age_30_2_css = "" }}
	{{ var age_30_3_css = "" }}
	{{ var etc_css = "" }}
	{{ var age_20_1_background_css = "" }}
	{{ var age_20_2_background_css = "" }}
	{{ var age_20_3_background_css = "" }}
	{{ var age_30_1_background_css = "" }}
	{{ var age_30_2_background_css = "" }}
	{{ var age_30_3_background_css = "" }}
	{{ var etc_background_css = "" }}
	{{ var age_20_1_count = detail_vote_count.left.age_20_1_count + detail_vote_count.right.age_20_1_count }}
	{{ var age_20_2_count = detail_vote_count.left.age_20_2_count + detail_vote_count.right.age_20_2_count }}
	{{ var age_20_3_count = detail_vote_count.left.age_20_3_count + detail_vote_count.right.age_20_3_count }}
	{{ var age_30_1_count = detail_vote_count.left.age_30_1_count + detail_vote_count.right.age_30_1_count }}
	{{ var age_30_2_count = detail_vote_count.left.age_30_2_count + detail_vote_count.right.age_30_2_count }}
	{{ var age_30_3_count = detail_vote_count.left.age_30_3_count + detail_vote_count.right.age_30_3_count }}
	{{ var etc_count = detail_vote_count.left.etc_count + detail_vote_count.right.etc_count }}
	{{ var age_count_arr = [ age_20_1_count, age_20_2_count, age_20_3_count, age_30_1_count, age_30_2_count, age_30_3_count, etc_count] }}
	{{ var max_count = Math.max.apply(window,age_count_arr) }}
  {{ var max_count_index_array = [] }}
  {{ for(i=0; i < age_count_arr.length; i++) { }}
    {{ if (max_count !=0 && age_count_arr[i] == max_count) max_count_index_array.push(i) }}
  {{ } }}
	{{ if( max_count_index_array.indexOf(0) != -1 ){ }}
		{{ age_20_1_css = "color:#ffcc5a; font-weight:bold;" }}
		{{ age_20_1_background_css = "background-color:rgba(255,228,169,0.7);" }}
	{{ } }}
  {{ if( max_count_index_array.indexOf(1) != -1 ){ }}
		{{ age_20_2_css = "color:#ffcc5a; font-weight:bold;" }}
		{{ age_20_2_background_css = "background-color:rgba(255,228,169,0.7);" }}
  {{ } }}
	{{ if( max_count_index_array.indexOf(2) != -1 ){ }}
		{{ age_20_3_css = "color:#ffcc5a; font-weight:bold;" }}
		{{ age_20_3_background_css = "background-color:rgba(255,228,169,0.7);" }}
  {{ } }}
	{{ if( max_count_index_array.indexOf(3) != -1 ){ }}
		{{ age_30_1_css = "color:#ffcc5a; font-weight:bold;" }}
		{{ age_30_1_background_css = "background-color:rgba(255,228,169,0.7);" }}
  {{ } }}
	{{ if( max_count_index_array.indexOf(4) != -1 ){ }}
		{{ age_30_2_css = "color:#ffcc5a; font-weight:bold;" }}
		{{ age_30_2_background_css = "background-color:rgba(255,228,169,0.7);" }}
  {{ } }}
	{{ if( max_count_index_array.indexOf(5) != -1 ){ }}
		{{ age_30_3_css = "color:#ffcc5a; font-weight:bold;" }}
		{{ age_30_3_background_css = "background-color:rgba(255,228,169,0.7);" }}
  {{ } }}
	{{ if( max_count_index_array.indexOf(6) != -1 ){ }}
		{{ etc_css = "color:#ffcc5a; font-weight:bold;" }}
		{{ etc_background_css = "background-color:rgba(255,228,169,0.7);" }}
	{{ } }}
	<table cellspacing="0" cellpadding="1" class="graph" style="padding:10px; border-bottom:1px solid #dbdbdb;">
		<tbody>
			<tr style="{{=age_20_1_background_css}}">
				<td class="vote-result-td">
					<span class="vote-result-bar-left" style="width:{{= Math.round(age_20_1_left_ratio) }}%; background-color:{{= (age_20_1_left_ratio >= age_20_1_right_ratio) ? '#ffcc5a;' : '#cbcbcb' }};">&nbsp;</span>
					<span class="vote-result-num-left" style="float:right; margin-right:3px; font-size:11px; padding-top:1px; {{= (age_20_1_left_ratio >= age_20_1_right_ratio) ? 'color:#ffcc5a;' : 'color:#cbcbcb;' }}">{{= (detail_vote_count.left.age_20_1_count ==0) ? "-" : detail_vote_count.left.age_20_1_count+"명"}}</span>
				</td>
				<td class="vote-result-td-title" style="{{= age_20_1_css }}">
					20초
				</td>
				<td class="vote-result-td">
					<span class="vote-result-bar-right" style="width:{{= Math.round(age_20_1_right_ratio) }}%; background-color:{{= (age_20_1_left_ratio <= age_20_1_right_ratio) ? '#ffcc5a;' : '#cbcbcb' }};">&nbsp;</span>
					<span class="vote-result-num-right" style="float:left; margin-left:3px; font-size:11px; padding-top:1px; {{= (age_20_1_left_ratio <= age_20_1_right_ratio) ? 'color:#ffcc5a;' : 'color:#cbcbcb;' }}">{{= (detail_vote_count.right.age_20_1_count ==0) ? "-" : detail_vote_count.right.age_20_1_count+"명"}}</span>
				</td>
			</tr>
			<tr style="{{=age_20_2_background_css}}">
				<td class="vote-result-td">
					<span class="vote-result-bar-left" style="width:{{= Math.round(age_20_2_left_ratio) }}%; background-color:{{= (age_20_2_left_ratio >= age_20_2_right_ratio) ? '#ffcc5a;' : '#cbcbcb' }};">&nbsp;</span>
					<span class="vote-result-num-left" style="float:right; margin-right:3px; font-size:11px; padding-top:1px; {{= (age_20_2_left_ratio >= age_20_2_right_ratio) ? 'color:#ffcc5a;' : 'color:#cbcbcb;' }}">{{= (detail_vote_count.left.age_20_2_count ==0) ? "-" : detail_vote_count.left.age_20_2_count+"명"}}</span>
				</td>
				<td class="vote-result-td-title" style="{{= age_20_2_css }}">
					20중
				</td>
				<td class="vote-result-td">
					<span class="vote-result-bar-right" style="width:{{= Math.round(age_20_2_right_ratio) }}%; background-color:{{= (age_20_2_left_ratio <= age_20_2_right_ratio) ? '#ffcc5a;' : '#cbcbcb' }};">&nbsp;</span>
					<span class="vote-result-num-right" style="float:left; margin-left:3px; font-size:11px; padding-top:1px; {{= (age_20_2_left_ratio <= age_20_2_right_ratio) ? 'color:#ffcc5a;' : 'color:#cbcbcb;' }}">{{= (detail_vote_count.right.age_20_2_count ==0) ? "-" : detail_vote_count.right.age_20_2_count+"명"}}</span>
				</td>
			</tr>
			<tr style="{{=age_20_3_background_css}}">
				<td class="vote-result-td">
					<span class="vote-result-bar-left" style="width:{{= Math.round(age_20_3_left_ratio) }}%; background-color:{{= (age_20_3_left_ratio >= age_20_3_right_ratio) ? '#ffcc5a;' : '#cbcbcb' }};">&nbsp;</span>
					<span class="vote-result-num-left" style="float:right; margin-right:3px; font-size:11px; padding-top:1px; {{= (age_20_3_left_ratio >= age_20_3_right_ratio) ? 'color:#ffcc5a;' : 'color:#cbcbcb;' }}">{{= (detail_vote_count.left.age_20_3_count ==0) ? "-" : detail_vote_count.left.age_20_3_count+"명"}}</span>
				</td>
				<td class="vote-result-td-title" style="{{= age_20_3_css }}">
					20후
				</td>
				<td class="vote-result-td">
					<span class="vote-result-bar-right" style="width:{{= Math.round(age_20_3_right_ratio) }}%; background-color:{{= (age_20_3_left_ratio <= age_20_3_right_ratio) ? '#ffcc5a;' : '#cbcbcb' }};">&nbsp;</span>
					<span class="vote-result-num-right" style="float:left; margin-left:3px; font-size:11px; padding-top:1px; {{= (age_20_3_left_ratio <= age_20_3_right_ratio) ? 'color:#ffcc5a;' : 'color:#cbcbcb;' }}">{{= (detail_vote_count.right.age_20_3_count ==0) ? "-" : detail_vote_count.right.age_20_3_count+"명"}}</span>
				</td>
			</tr>
			<tr style="{{=age_30_1_background_css}}">
				<td class="vote-result-td">
					<span class="vote-result-bar-left" style="width:{{= Math.round(age_30_1_left_ratio) }}%; background-color:{{= (age_30_1_left_ratio >= age_30_1_right_ratio) ? '#ffcc5a;' : '#cbcbcb' }};">&nbsp;</span>
					<span class="vote-result-num-left" style="float:right; margin-right:3px; font-size:11px; padding-top:1px; {{= (age_30_1_left_ratio >= age_30_1_right_ratio) ? 'color:#ffcc5a;' : 'color:#cbcbcb;' }}">{{= (detail_vote_count.left.age_30_1_count ==0) ? "-" : detail_vote_count.left.age_30_1_count+"명"}}</span>
				</td>
				<td class="vote-result-td-title" style="{{= age_30_1_css }}">
					30초
				</td>
				<td class="vote-result-td">
					<span class="vote-result-bar-right" style="width:{{= Math.round(age_30_1_right_ratio) }}%; background-color:{{= (age_30_1_left_ratio <= age_30_1_right_ratio) ? '#ffcc5a;' : '#cbcbcb' }};">&nbsp;</span>
					<span class="vote-result-num-right" style="float:left; margin-left:3px; font-size:11px; padding-top:1px; {{= (age_30_1_left_ratio <= age_30_1_right_ratio) ? 'color:#ffcc5a;' : 'color:#cbcbcb;' }}">{{= (detail_vote_count.right.age_30_1_count ==0) ? "-" : detail_vote_count.right.age_30_1_count+"명"}}</span>
				</td>
			</tr>
			<tr style="{{=age_30_2_background_css}}">
				<td class="vote-result-td">
					<span class="vote-result-bar-left" style="width:{{= Math.round(age_30_2_left_ratio) }}%; background-color:{{= (age_30_2_left_ratio >= age_30_2_right_ratio) ? '#ffcc5a;' : '#cbcbcb' }};">&nbsp;</span>
					<span class="vote-result-num-left" style="float:right; margin-right:3px; font-size:11px; padding-top:1px; {{= (age_30_2_left_ratio >= age_30_2_right_ratio) ? 'color:#ffcc5a;' : 'color:#cbcbcb;' }}">{{= (detail_vote_count.left.age_30_2_count ==0) ? "-" : detail_vote_count.left.age_30_2_count+"명"}}</span>
				</td>
				<td class="vote-result-td-title" style="{{= age_30_2_css }}">
					30중
				</td>
				<td class="vote-result-td">
					<span class="vote-result-bar-right" style="width:{{= Math.round(age_30_2_right_ratio) }}%; background-color:{{= (age_30_2_left_ratio <= age_30_2_right_ratio) ? '#ffcc5a;' : '#cbcbcb' }};">&nbsp;</span>
					<span class="vote-result-num-right" style="float:left; margin-left:3px; font-size:11px; padding-top:1px; {{= (age_30_2_left_ratio <= age_30_2_right_ratio) ? 'color:#ffcc5a;' : 'color:#cbcbcb;' }}">{{= (detail_vote_count.right.age_30_2_count ==0) ? "-" : detail_vote_count.right.age_30_2_count+"명"}}</span>
				</td>
			</tr>
			<tr style="{{=age_30_3_background_css}}">
				<td class="vote-result-td">
					<span class="vote-result-bar-left" style="width:{{= Math.round(age_30_3_left_ratio) }}%; background-color:{{= (age_30_3_left_ratio >= age_30_3_right_ratio) ? '#ffcc5a;' : '#cbcbcb' }};">&nbsp;</span>
					<span class="vote-result-num-left" style="float:right; margin-right:3px; font-size:11px; padding-top:1px; {{= (age_30_3_left_ratio >= age_30_3_right_ratio) ? 'color:#ffcc5a;' : 'color:#cbcbcb;' }}">{{= (detail_vote_count.left.age_30_3_count ==0) ? "-" : detail_vote_count.left.age_30_3_count+"명"}}</span>
				</td>
				<td class="vote-result-td-title" style="{{= age_30_3_css }}">
					30후
				</td>
				<td class="vote-result-td">
					<span class="vote-result-bar-right" style="width:{{= Math.round(age_30_3_left_ratio) }}%; background-color:{{= (age_30_3_left_ratio <= age_30_3_right_ratio) ? '#ffcc5a;' : '#cbcbcb' }};">&nbsp;</span>
					<span class="vote-result-num-right" style="float:left; margin-left:3px; font-size:11px; padding-top:1px; {{= (age_30_3_left_ratio <= age_30_3_right_ratio) ? 'color:#ffcc5a;' : 'color:#cbcbcb;' }}">{{= (detail_vote_count.right.age_30_3_count ==0) ? "-" : detail_vote_count.right.age_30_3_count+"명"}}</span>
				</td>
			</tr>
			<tr style="{{=etc_background_css}}">
				<td class="vote-result-td">
					<span class="vote-result-bar-left" style="width:{{= Math.round(etc_left_ratio) }}%; background-color:{{= (etc_left_ratio >= etc_right_ratio) ? '#ffcc5a;' : '#cbcbcb' }};">&nbsp;</span>
					<span class="vote-result-num-left" style="float:right; margin-right:3px; font-size:11px; padding-top:1px; {{= (etc_left_ratio >= etc_right_ratio) ? 'color:#ffcc5a;' : 'color:#cbcbcb;' }}">{{= (detail_vote_count.left.etc_count ==0) ? "-" : detail_vote_count.left.etc_count+"명"}}</span>
				</td>
				<td class="vote-result-td-title" style="{{= etc_css }}">
					기타
				</td>
				<td class="vote-result-td">
					<span class="vote-result-bar-right" style="width:{{= Math.round(etc_right_ratio) }}%; background-color:{{= (etc_left_ratio <= etc_right_ratio) ? '#ffcc5a;' : '#cbcbcb' }};">&nbsp;</span>
					<span class="vote-result-num-right" style="float:left; margin-left:3px; font-size:11px; padding-top:1px; {{= (etc_left_ratio <= etc_right_ratio) ? 'color:#ffcc5a;' : 'color:#cbcbcb;' }}">{{= (detail_vote_count.right.etc_count ==0) ? "-" : detail_vote_count.right.etc_count+"명"}}</span>
				</td>
			</tr>
		</tbody>
	</table>
</script>

<script type="text/template" id="ask-deal-table-template">
  <div style="padding:10px 10px 0px 10px;">
    {{ var blank_field = '<p class="output_field" style="color:#9d9ea1;">-</p>' }}
    {{ if (ask.left_ask_deal.title != "" && ask.right_ask_deal.title != "" ){ }}
      <div class="table_div">
        <div class="ask_text_field left_input output_field" style="font-weight:bold;">
          <p class="output_field">{{= ask.left_ask_deal.title }}</p>
          <div class="tooltip_area">
            <div class="tooltip_arrow bottom"></div>
            <div class="tooltip_content">{{= ask.left_ask_deal.title }}</div>
          </div>
        </div>
        <div class="ask_text_field right_input output_field" style="font-weight:bold;">
          <p class="output_field">{{= ask.right_ask_deal.title }}</p>
          <div class="tooltip_area">
            <div class="tooltip_arrow bottom"></div>
            <div class="tooltip_content">{{= ask.right_ask_deal.title }}</div>
          </div>
        </div>
        <span class="input_icon center_input"><i class="fa fa-cube"></i></span>
      </div>
    {{ } }}
    {{ if (ask.left_ask_deal.brand != "" || ask.right_ask_deal.brand != "" ){ }}
      <div class="table_div">
        <div class="ask_text_field left_input output_field">
          {{ if (ask.left_ask_deal.brand == "") { }} {{= blank_field }} {{ } else { }}<p class="output_field">{{= ask.left_ask_deal.brand }}</p>{{ } }}
        </div>
        <div class="ask_text_field right_input output_field">
          {{ if (ask.right_ask_deal.brand == "") { }} {{= blank_field }} {{ } else { }}<p class="output_field">{{= ask.right_ask_deal.brand }}</p>{{ } }}
        </div>
        <span class="input_icon center_input"><i class="fa fa-tag"></i></span>
      </div>
    {{ } }}
    {{ if (ask.left_ask_deal.price != null || ask.right_ask_deal.price != null ){ }}
      <div class="table_div">
        <div class="ask_text_field left_input output_field">
          {{ if (ask.left_ask_deal.price == null) { }} {{= blank_field }} {{ } else { }}<p class="output_field">{{= numberWithCommas(ask.left_ask_deal.price) }}원</p>{{ } }}
        </div>
        <div class="ask_text_field right_input output_field">
          {{ if (ask.right_ask_deal.price == null) { }} {{= blank_field }} {{ } else { }}<p class="output_field">{{= numberWithCommas(ask.right_ask_deal.price) }}원</p>{{ } }}
        </div>
        <span class="input_icon center_input"><i class="fa fa-won"></i></span>
      </div>
    {{ } }}
    {{ if (ask.left_ask_deal.link != "" || ask.right_ask_deal.link != "" ){ }}
      <div class="table_div">
        <div class="ask_text_field left_input output_field">
          {{ if (ask.left_ask_deal.link == "") { }} {{= blank_field }} {{ } else { }}
            <p class="output_field">
              {{ var aLink = document.createElement("a") }}
              {{ aLink.href = ask.left_ask_deal.link }}
              <a href="{{= ask.left_ask_deal.link }}" target="_blank" style="color:#ee6e01;"><i class="fa fa-external-link" style="color: #ee6e01; font-size: 12px; font-weight: bold;"></i>&nbsp;{{= aLink.host }}</a>
            </p>
          {{ } }}
        </div>
        <div class="ask_text_field right_input output_field">
          {{ if (ask.right_ask_deal.link == "") { }} {{= blank_field }} {{ } else { }}
            <p class="output_field">
              {{ var bLink = document.createElement("a") }}
              {{ bLink.href = ask.right_ask_deal.link }}
              <a href="{{= ask.right_ask_deal.link }}" target="_blank" style="color:#ee6e01;"><i class="fa fa-external-link" style="color: #ee6e01; font-size: 12px; font-weight: bold;"></i>&nbsp;{{= bLink.host }}</a>
            <p>
          {{ } }}
        </div>
        <span class="input_icon center_input"><i class="fa fa-link"></i></span>
      </div>
    {{ } }}
    {{ if (ask.spec1 != "" || ask.spec2 != "" || ask.spec3 != "" || ask.left_ask_deal.spec1 != "" || ask.left_ask_deal.spec2 != "" || ask.left_ask_deal.spec3 != "" || ask.right_ask_deal.spec1 != "" || ask.right_ask_deal.spec2 != "" || ask.right_ask_deal.spec3 != "") { }}
      <div class="table_div" style="border:1px solid #dbdbdb; border-radius:5px; overflow:hidden;">
        <table class="deal_spec_detail" cellspacing="0" cellpadding="0" style="width:100%;">
          {{ if (ask.spec1 != "" || ask.left_ask_deal.spec1 != "" || ask.right_ask_deal.spec1 != "" ){ }}
            <tr>
              <td style="width:40%;">
                {{ if (ask.left_ask_deal.spec1 == "") { }} {{= blank_field }} {{ } else { }}<p class="output_field">{{= ask.left_ask_deal.spec1 }}</p>{{ } }}
              </td>
              <td style="width:20%; background-color:#f4f4f4; border-left:1px solid #dbdbdb; border-right:1px solid #dbdbdb;">
                {{ if (ask.spec1 == "") { }} {{= blank_field }} {{ } else { }}<p class="output_field">{{= ask.spec1 }}</p>{{ } }}
              </td>
              <td style="width:40%;">
                {{ if (ask.right_ask_deal.spec1 == "") { }} {{= blank_field }} {{ } else { }}<p class="output_field">{{= ask.right_ask_deal.spec1 }}</p>{{ } }}
              </td>
            </tr>
          {{ } }}
          {{ if (ask.spec2 != "" || ask.left_ask_deal.spec2 != "" || ask.right_ask_deal.spec2 != "" ){ }}
            <tr>
              <td style="width:40%; border-top:1px solid #dbdbdb;">
                {{ if (ask.left_ask_deal.spec2 == "") { }} {{= blank_field }} {{ } else { }}<p class="output_field">{{= ask.left_ask_deal.spec2 }}</p>{{ } }}
              </td>
              <td style="width:20%; background-color:#f4f4f4; border-left:1px solid #dbdbdb; border-right:1px solid #dbdbdb; border-top:1px solid #dbdbdb;">
                {{ if (ask.spec2 == "") { }} {{= blank_field }} {{ } else { }}<p class="output_field">{{= ask.spec2 }}</p>{{ } }}
              </td>
              <td style="width:40%; border-top:1px solid #dbdbdb;">
                {{ if (ask.right_ask_deal.spec2 == "") { }} {{= blank_field }} {{ } else { }}<p class="output_field">{{= ask.right_ask_deal.spec2 }}</p>{{ } }}
              </td>
            </tr>
          {{ } }}
          {{ if (ask.spec3 != "" || ask.left_ask_deal.spec3 != "" || ask.right_ask_deal.spec3 != "" ){ }}
            <tr>
              <td style="width:40%; border-top:1px solid #dbdbdb;">
                {{ if (ask.left_ask_deal.spec3 == "") { }} {{= blank_field }} {{ } else { }}<p class="output_field">{{= ask.left_ask_deal.spec3 }}</p>{{ } }}
              </td>
              <td style="width:20%; background-color:#f4f4f4; border-left:1px solid #dbdbdb; border-right:1px solid #dbdbdb; border-top:1px solid #dbdbdb;">
                {{ if (ask.spec3 == "") { }} {{= blank_field }} {{ } else { }}<p class="output_field">{{= ask.spec3 }}</p>{{ } }}
              </td>
              <td style="width:40%; border-top:1px solid #dbdbdb;">
                {{ if (ask.right_ask_deal.spec3 == "") { }} {{= blank_field }} {{ } else { }}<p class="output_field">{{= ask.right_ask_deal.spec3 }}</p>{{ } }}
              </td>
            </tr>
          {{ } }}
        </table>
      </div>
    {{ } }}
  </div>
</script>

<script type="text/template" id="ask-comment-template">
  {{ var already_vote = $.grep(my_votes, function(obj) { return obj.ask_id === ask.id }) }}
  {{ if (ask.user_id == current_user_id) { }}
    <div id="ask_{{=ask.id}}_comment_title" class="table_div comment_title my_vote" onclick="comment_title_open({{=ask.id}}); return false;" style="margin:0;">
      <span style="width:100%;">어떤 의견이 달렸을까요?&nbsp;<i class="fa fa-users" style="font-size:16px;"></i></span>
      <span style="position:absolute; top:0; left:10px; width:40px;">
        <i class="fa fa-comment" style="font-size:16px;"></i>
        <span id="left_ask_deal_comment_count_{{=ask.id}}" style="display:inline-block;">{{=ask.left_ask_deal.comment_count}}</span>
      </span>
      <span style="position:absolute; top:0; right:10px; width:40px;">
        <span id="right_ask_deal_comment_count_{{=ask.id}}" style="display:inline-block;">{{=ask.right_ask_deal.comment_count}}</span>&nbsp;
        <i class="fa fa-comment fa-flip-horizontal" style="font-size:16px;"></i>
      </span>
    </div>
  {{ } else if (already_vote.length != 0) { }}
    <div id="ask_{{=ask.id}}_comment_title" class="table_div comment_title already_vote" onclick="comment_title_open({{=ask.id}}); return false;" style="margin:0;">
      <span style="width:100%;">당신의 의견을 남겨주세요&nbsp;<i class="fa fa-keyboard-o" style="font-size:16px;"></i></span>
      <span style="position:absolute; top:0; left:10px; width:40px;">
        <i class="fa fa-comment" style="font-size:16px;"></i>
        <span id="left_ask_deal_comment_count_{{=ask.id}}" style="display:inline-block;">{{=ask.left_ask_deal.comment_count}}</span>
      </span>
      <span style="position:absolute; top:0; right:10px; width:40px;">
        <span id="right_ask_deal_comment_count_{{=ask.id}}" style="display:inline-block;">{{=ask.right_ask_deal.comment_count}}</span>&nbsp;
        <i class="fa fa-comment fa-flip-horizontal" style="font-size:16px;"></i>
      </span>
    </div>
  {{ } else if (already_vote.length == 0) { }}
    <div id="ask_{{=ask.id}}_comment_title" class="table_div comment_title" style="margin:0;">
      <span style="width:100%;">투표에 먼저 참여해주세요&nbsp;<i class="fa fa-hand-o-up" style="font-size:16px;"></i></span>
      <span style="position:absolute; top:0; left:10px; width:40px;">
        <i class="fa fa-comment" style="font-size:16px;"></i>
        <span id="left_ask_deal_comment_count_{{=ask.id}}" style="display:inline-block;">{{=ask.left_ask_deal.comment_count}}</span>
      </span>
      <span style="position:absolute; top:0; right:10px; width:40px;">
        <span id="right_ask_deal_comment_count_{{=ask.id}}" style="display:inline-block;">{{=ask.right_ask_deal.comment_count}}</span>&nbsp;
        <i class="fa fa-comment fa-flip-horizontal" style="font-size:16px;"></i>
      </span>
    </div>
  {{ } }}
  <div id="ask_{{=ask.id}}_comment_list" class="table_div" style="position:relative; background-color:rgba(153, 134, 116, 0.1); padding:5px 0; margin:0; min-height:200px; border-top:1px solid #dbdbdb;">
    {{ var origin_comments = $.grep(ask.comments, function(obj) { return (obj.ask_id == ask.id && obj.comment_id == null) }) }}
    <p style="position: absolute; top: 50%; left: 50%; color: #9d9ea1; font-size: 13px; width: 200px; margin-top: -16px; margin-left: -100px; display:{{= ask.left_ask_deal.comment_count + ask.right_ask_deal.comment_count == 0 ? 'block' : 'none' }};" id="no_comment_{{=ask.id}}">아직 남겨진 의견이 없네요.<br>소중한 한마디 부탁드립니다:)</p>
    {{ if(current_user_id == 0 && ask.user_id != current_user_id && already_vote.length == 0){ }}
      <div id="visitor_comment_overlay_{{=ask.id}}" style="position:absolute; top:0; left:0; width:100%; height:100%; background-color:black; opacity:0.92;">
        <p style="position:relative; top:50%; margin:-75px 0 0 0; color:#fff; font-size:15px; text-align:center; line-height:2; opacity:1;">
          <span style="background-color:#ee6e01; border-radius:3px; padding:3px 5px 1px;">VASKIT회원</span>이 되시면<br>모든 의견을 자유롭게 볼 수 있어요!<br><br>
          <span style="background-color:#4b3d3d; border-radius:3px; padding:3px 5px 1px;">비회원</span>은 투표에 참여한 후에만<br>의견을 확인하실 수 있답니다 :)
        </p>
      </div>
    {{ }else{ }}
      {{ for(var i=0; i < origin_comments.length; i++) {  }}
        {{ var comment = origin_comments[i] }}
        {{= askCommentListTemplate({ask:ask, comment:comment}) }}
      {{ } }}
    {{ } }}
  </div>
  {{ if(ask.user_id == current_user_id){ }}
    {{ ask_deal_id = ask.left_ask_deal_id }}
    {{ ask_deal_text = "left" }}
  {{ } else if(already_vote.length == 0){ }}
    {{ ask_deal_id = ask.left_ask_deal_id }}
    {{ ask_deal_text = "center" }}
  {{ }else if(ask.left_ask_deal_id == already_vote[0].ask_deal_id){ }}
    {{ ask_deal_id = ask.left_ask_deal_id }}
    {{ ask_deal_text = "left" }}
  {{ }else{ }}
    {{ ask_deal_id = ask.right_ask_deal_id }}
    {{ ask_deal_text = "right" }}
  {{ } }}
  <div id="new_comment" class="table_div" style="background-color:rgba(153, 134, 116, 0.1); background-color:#ededed; border-top:1px solid #dbdbdb; padding:10px 0px; margin-bottom:0;">
    <a id="ask_deal_id_change_{{=ask.id}}_right" onclick="ask_deal_id_change({{=ask.id}}, {{=ask.left_ask_deal_id}}, {{=ask.right_ask_deal_id}}); return false;" href="#" style="display:inline-block; position:absolute; top:50%; right:0%; margin-top:-20px; margin-right:{{= ask_deal_text == 'right' ? '-50px' : '10px' }}; width:40px; height:40px; line-height:40px; text-align:center; color:#9d9ea1; font-size:16px; transition:all .5s;"><i class="fa fa-angle-double-right"></i></a>
    <a id="ask_deal_id_change_{{=ask.id}}_left" onclick="ask_deal_id_change({{=ask.id}}, {{=ask.left_ask_deal_id}}, {{=ask.right_ask_deal_id}}); return false;" href="#" style="display:inline-block; position:absolute; top:50%; left:0%; margin-top:-20px; margin-left:{{= ask_deal_text == 'left' ? '-50px' : '10px' }}; width:40px; height:40px; line-height:40px; text-align:center; color:#9d9ea1; font-size:16px; transition:all .5s;"><i class="fa fa-angle-double-left"></i></a>
    <div id="comment_input_box_{{=ask.id}}" style="border:1px solid #dbdbdb; border-bottom:2px solid #dbdbdb; padding:9px 10px; background-color:#fff; width:60%; margin:{{= ask_deal_text == 'left' ? '0 auto 0 10px' : ( ask_deal_text == 'right' ? '0 10px 0 auto' : '0 auto') }}; transition:all .5s;">
        <img id="attached_comment_image_{{=ask.id}}" src="" style="max-width:100%; margin-bottom:10px; display:none;">
        <div id="attached_edit_{{=ask.id}}" style="position:relative; margin-top:-50px; margin-bottom:10px; width:100%; height:40px; line-height:40px; text-align:center; font-size:12px; background-color:rgba(0,0,0,0.6); color:#fff; display:none;">
          <a href="#" onclick="$('#comment_image_upload_{{=ask.id}}').click(); return false;" style="position:relative; width:50%; height:100%; display:block; color:#fff; float:left;">변경하기</a>
          <a href="#" onclick="comment_image_delete({{=ask.id}}); return false;" style="position:relative; width:50%; height:100%; display:block; color:#fff; float:right;">삭제하기</a>
        </div>
      <% if current_user %>
        {{ if (ask.user_id == current_user_id) { }}
          <textarea id="comment_input_{{=ask.id}}" placeholder="<%= current_user.string_id %>님! 많은 고민해결사님들께 한마디 남겨주세요!" style="display:block; padding:0px; width:100%; min-width:100%; max-width:100%; min-height:100px; box-sizing:border-box; border:none; color:#383838; background-color:#fff; border-radius:0; font-size:13px; line-height:20px; text-align:{{=ask_deal_text}};"></textarea>
        {{ } else if(already_vote.length == 0) { }}
          <textarea id="comment_input_{{=ask.id}}" placeholder="<%= current_user.string_id %>님! 투표에 먼저 참여해주세요!" style="display:block; padding:0px; width:100%; min-width:100%; max-width:100%; min-height:100px; box-sizing:border-box; border:none; color:#383838; background-color:#fff; border-radius:0; font-size:13px; line-height:20px; text-align:{{=ask_deal_text}};"></textarea>
        {{ } else { }}
          <textarea id="comment_input_{{=ask.id}}" placeholder="고민해결사 <%= current_user.string_id %>님! 한마디 부탁해요!" style="display:block; padding:0px; width:100%; min-width:100%; max-width:100%; min-height:100px; box-sizing:border-box; border:none; color:#383838; background-color:#fff; border-radius:0; font-size:13px; line-height:20px; text-align:{{=ask_deal_text}};"></textarea>
        {{ } }}
      <% else %>
        <textarea id="comment_input_{{=ask.id}}" placeholder="회원가입하시고 의견을 남겨주세요!" style="display:block; padding:0px; width:100%; min-width:100%; max-width:100%; min-height:100px; box-sizing:border-box; border:none; color:#383838; background-color:#fff; border-radius:0; font-size:13px; line-height:20px; text-align:{{=ask_deal_text}};"></textarea>
      <% end %>
      <div id="comment_text_counter_{{=ask.id}}" style="margin:0px 5px; height: 15px; text-align: right; font-size: 11px; color:#9d9ea1; display:none;">0 글자</div>
      <div id="comment_input_cover_{{=ask.id}}" style="margin-top: -100px; height: 100px;" onclick="$('#comment_input_{{=ask.id}}').focus(); $(this).hide();"></div>
      <div style="display:none;">
        <input type="file" name="comment_image" id="comment_image_upload_{{=ask.id}}" accept="image/*" onchange="comment_image_upload({{=ask.id}}); return false;">
        <input type="hidden" name="comment_image_id" id="comment_image_id_{{=ask.id}}">
      </div>
      <a id="comment_image_btn_{{=ask.id}}" href="#" style="display:block; width:100%; height:40px; margin-top:10px; background-color:#fff; color:#666; border:1px solid #dbdbdb; box-sizing:border-box; text-align:center; line-height:40px; font-size:12px; border-radius:0; transition:all .5s;">
        <i class="fa fa-image"></i>&nbsp;이미지 첨부하기
      </a>
      <a id="send_comment_btn_{{=ask.id}}" class="comment_update_btn" href="#" onclick="send_comment({{=ask.id}}, {{=ask_deal_id}}); return false;" style="display:block; width:100%; height:40px; margin-top:10px; background-color:#dbdbdb; color:#fff; text-align:center; line-height:40px; font-size:12px; border-radius:0; transition:all .5s;">
        댓글 남기기
      </a>
      <div class="tooltip_area" style="width:60%;">
        <div class="tooltip_arrow bottom"></div>
        <div class="tooltip_content" style="text-align:left; line-height:1.5;">
          <i class="fa fa-image" style="width:15px; text-align:center;"></i> 이미지를 첨부해보아요<br>
          <i class="fa fa-link" style="width:15px; text-align:center;"></i> URL 링크를 공유해보아요<br>
          <i class="fa fa-level-down fa-rotate-90" style="height:15px; margin:0 6px 0 3px;"></i> 컨트롤+엔터로 전송해보아요<br>
          <i class="fa fa-angle-double-left"></i> <i class="fa fa-angle-double-right"></i> 댓글 방향을 바꿀 수 있어요
        </div>
      </div>
    </div>
  </div>
</script>

<script type="text/template" id="ask-comment-list-template">
  {{ var already_like = $.grep(my_like_comment, function(obj) { return obj.comment_id === comment.id }) }}
	{{ var reply_comments = $.grep(ask.comments, function(obj) {return (obj.comment_id == comment.id && obj.is_deleted == false)}) }}
  {{ if (comment.is_deleted == false || reply_comments.length > 0){ }}
  	{{ if (ask.left_ask_deal_id == comment.ask_deal_id){ }}
      <div id="comment_{{= comment.id }}" class="table_div" style="width:100%; text-align:left; margin:0; padding:5px 0;">
        {{ if (comment.is_deleted == false) { }}
          <div id="comment_content_{{=comment.id}}" style="text-align:left;">
            {{ if (comment.user_id == 1) { }}
            <div style="position:relative; margin:0 0 0 10px; padding:10px 10px 5px 15px; width:60%; display:inline-block; text-align:left; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #dbdbdb; border-bottom:2px solid #dbdbdb; vertical-align:bottom; overflow:hidden;">
              <span style="position:absolute; top:0; left:0; display:block; width:5px; height:100%; background-color:rgba(75, 61, 61, 0.8);"></span>
            {{ } else if (comment.user_id == current_user_id) { }}
            <div style="position:relative; margin:0 0 0 10px; padding:10px 10px 5px 15px; width:60%; display:inline-block; text-align:left; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #dbdbdb; border-bottom:2px solid #dbdbdb; vertical-align:bottom; overflow:hidden;">
              <span style="position:absolute; top:0; left:0; display:block; width:5px; height:100%; background-color:rgba(153, 134, 116, 0.7);"></span>
            {{ } else if (comment.user_id == ask.user_id) { }}
            <div style="position:relative; margin:0 0 0 10px; padding:10px 10px 5px 15px; width:60%; display:inline-block; text-align:left; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #dbdbdb; border-bottom:2px solid #dbdbdb; vertical-align:bottom; overflow:hidden;">
              <span style="position:absolute; top:0; left:0; display:block; width:5px; height:100%; background-color:rgba(238, 110, 1, 0.7);"></span>
            {{ } else { }}
            <div style="position:relative; margin:0 0 0 10px; padding:10px 10px 5px; width:60%; display:inline-block; text-align:left; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #dbdbdb; border-bottom:2px solid #dbdbdb; vertical-align:bottom; overflow:hidden;">
            {{ } }}
              {{ if (comment.image_file_name != null) { }}
                <img id="comment_image_{{=comment.id}}" src="{{= get_image_url(comment, 'comments', 'normal') }}" style="max-width:100%; margin:0 auto 10px 0;" onerror="imgError(this);">
              {{ }else{ }}
                <img id="comment_image_{{=comment.id}}" src="" style="max-width:100%; margin:0 auto 10px 0; display:none;">
              {{ } }}
  						<span class="comment_content" style="display:block;">{{=comment.content.replace(new RegExp('<', 'g'), '&lt;').replace(new RegExp('\r?\n', 'g'), '<br>')}}</span>
              <div class="table_div" style="margin:5px 0 0; padding:5px 5px 0; border-top:1px solid #dbdbdb; font-size:12px;">
                <div style="display:inline-block; float:left; text-align:left;">
                  {{ if (comment.user_id == 1) { }}
                    <span style="float:left; margin-right:5px; color:#4b3d3d; font-weight:bold;">{{=comment.user.string_id}}</span>
                  {{ } else { }}
                    <span style="float:left; margin-right:5px; color:#998674;">{{=comment.user.string_id}}</span>
                  {{ } }}
                  <div style="float:left;">
                    {{ if ( comment.user_id == current_user_id ){ }}
                      <a id="comment_modify_btn_{{=comment.id}}" class="comment_modify_btn" href="#" onclick="comment_modify({{=comment.id}}); return false;" style="margin-right:5px; color:#dbdbdb;"><i class="fa fa-pencil"></i></a>
                      <a id="comment_delete_btn_{{=comment.id}}" href="#" onclick="comment_del({{=ask.id}}, {{=comment.id}}, true); return false;" style="margin-right:0px; color:#dbdbdb;"><i class="fa fa-trash"></i></a>
                    {{ }else{ }}
                      <a id="comment_report_btn_{{=comment.id}}" href="#" onclick="show_report_popup('comment', {{=comment.id}}); return false;" style="margin-right:0px; color:#dbdbdb;"><i class="fa fa-ban"></i></a>
                    {{ } }}
                  </div>
                </div>
                <div style="display:inline-block; float:right; text-align:right;">
                  {{ if (comment.user_id == 1) { }}
                    <span style="float:right; margin-left:5px; font-size:11px; font-weight:bold; color:#4b3d3d;"><i class="fa fa-star"></i></span>
                  {{ } else if (comment.user_id == current_user_id) { }}
                    <span style="float:right; margin-left:5px; font-size:11px; font-weight:bold; color:#998674;">ME</span>
                  {{ } else if (comment.user_id == ask.user_id) { }}
                    <span style="float:right; margin-left:5px; font-size:11px; font-weight:bold; color:#f18b33;">ASKER</span>
                  {{ } else { }}
                    <span style="float:right; margin-left:5px; font-size:11px; font-weight:bold; opacity:0.8; color:{{= comment.user.gender ? '#0389ed' : '#ea065e'}};">{{=get_user_ages(comment.user.birthday)}}</span>
                  {{ } }}
                  <span style="float:right; margin-left:0px; font-size:11px; color:#9d9ea1;">{{= get_past_time(comment.created_at)}}</span>
                </div>
              </div>
  					</div>
            <div id="comment_menu_{{=comment.id}}" style="position:relative; display:inline-block; text-align:left; font-size:12px;">
              <a href="#" onclick="comment_like({{=comment.id}}); return false;" style="display:block; padding:0 5px 10px 0; color:{{= already_like.length == 1 ? '#ee6e01' : '#9d9ea1'}};">
                <i id="comment_{{=comment.id}}_like_icon" class="fa {{= already_like.length == 1 ? 'fa-heart' : 'fa-heart-o'}}" style="color:{{= already_like.length == 1 ? '#ee6e01' : '#9d9ea1'}}; margin-left:1px;"></i>
                <span id="comment_{{=comment.id}}_like_count">{{=comment.like_count}}</span>
              </a>
              <a id="comment_reply_btn_{{=comment.id}}" class="comment_reply_btn" href="#" onclick="comment_reply({{=ask.id}}, {{=comment.id}}); return false;" style="display:block; padding:0 5px 10px 0; color:#666;">
                <i class="fa fa-reply fa-rotate-180" style="margin:1px 3px 0px 2px; font-size:10px; vertical-align:text-top;"></i>답글
              </a>
            </div>
  				</div>
          <div id="comment_modify_box_{{=comment.id}}" style="text-align:left; display:none;">
            <div style="position:relative; margin:0 0 0 10px; padding:9px 10px; width:60%; display:inline-block; text-align:left; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #ee6e01; border-bottom:2px solid #ee6e01; vertical-align:bottom;">
              {{ if (comment.image_file_name != null) { }}
                <img id="modify_comment_image_{{=comment.id}}" src="{{= get_image_url(comment, 'comments', 'normal') }}" style="max-width:100%; margin:0 auto 10px 0;" onerror="imgError(this);">
              {{ }else{ }}
                <img id="modify_comment_image_{{=comment.id}}" src="" style="max-width:100%; margin:0 auto 10px 0; display:none;">
              {{ } }}
              <div id="modify_edit_{{=comment.id}}" style="position:relative; margin-top:-50px; margin-bottom:10px; width:100%; height:40px; line-height:40px; text-align:center; font-size:12px; background-color:rgba(0,0,0,0.6); color:#fff; display:{{=comment.image_file_name != null ? 'block' : 'none'}};">
                <a href="#" onclick="$('#modify_comment_image_upload_{{=comment.id}}').click(); return false;" style="position:relative; width:50%; height:100%; display:block; color:#fff; float:left;">변경하기</a>
                <a href="#" onclick="modify_comment_image_delete({{=comment.id}}); return false;" style="position:relative; width:50%; height:100%; display:block; color:#fff; float:right;">삭제하기</a>
              </div>
              <textarea id="comment_modify_input_{{=comment.id}}" placeholder="의견을 입력해주세요" rows="1" style="display:block; padding:0px; width:100%; min-width:100%; max-width:100%; height:auto; min-height:20px; overflow:hidden; box-sizing:border-box; border:none; color:#383838; background-color:#fff; border-radius:0; font-size:13px; line-height:20px; text-align:left;">{{=comment.content}}</textarea>
              <div id="comment_modify_text_counter_{{=comment.id}}" style="margin:0px 5px; height: 15px; text-align: right; font-size: 11px; color:#9d9ea1; display:none;">0 글자</div>
              <div style="display:none;">
                <input type="file" name="modify_comment_image" id="modify_comment_image_upload_{{=comment.id}}" accept="image/*" onchange="modify_comment_image_upload({{=comment.id}}); return false;">
                <input type="hidden" name="modify_comment_image_id" id="modify_comment_image_id_{{=comment.id}}">
              </div>
              <a id="modify_comment_image_btn_{{=comment.id}}" href="#" onclick="$('#modify_comment_image_upload_{{=comment.id}}').click(); return false;" style="display:{{=comment.image_file_name != null ? 'none' : 'block'}}; width:100%; height:40px; margin-top:10px; background-color:#fff; color:#666; border:1px solid #dbdbdb; box-sizing:border-box; text-align:center; line-height:40px; font-size:12px; border-radius:0; transition:all .5s;">
                <i class="fa fa-image"></i>&nbsp;이미지 첨부하기
              </a>
              <a id="comment_update_btn_{{=comment.id}}" class="comment_update_btn" href="#" onclick="comment_update({{=comment.id}}); return false;" style="display:block; width:100%; height:40px; margin-top:10px; background-color:#dbdbdb; color:#fff; text-align:center; line-height:40px; font-size:12px; border-radius:0; transition:all .5s;">
                수정하기
              </a>
            </div>
            <a id="comment_modify_cancel_btn_{{=comment.id}}" class="comment_modify_cancel_btn" href="#" onclick="comment_modify_cancel({{=comment.id}}); return false;" style="padding:10px; margin-bottom:10px; color:#ee6e01; font-size:12px; display:inline-block;">취소</a>
          </div>
        {{ } else if (reply_comments.length > 0) { }}
          <div id="comment_content_{{=comment.id}}" style="text-align:left;">
            <div style="position:relative; margin:0 10px 0 10px; padding:10px; background-color:#f0f2f4; color:#9d9ea1; width:60%; display:inline-block; font-size:13px; line-height:20px; word-break:break-all; border:1px solid #dbdbdb; border-bottom:2px solid #dbdbdb; vertical-align:bottom;">
              삭제된 댓글입니다.
            </div>
          </div>
        {{ } }}
      </div>
  		<div id="comment_{{=comment.id}}_reply_list">
  			{{ for(var i=0; i < reply_comments.length; i++) { }}
  				{{ var reply_comment = reply_comments[i] }}
  				{{= replyCommentListTemplate({ask:ask, comment:reply_comment}) }}
  			{{ } }}
  		</div>
      <div id="reply_comment_box_{{=comment.id}}" style="text-align:left; padding:5px 0; display:none;">
        <span><i class="fa fa-reply fa-rotate-180" style="font-size:10px; vertical-align:top; margin:10px 5px 0px 15px; color:#666;"></i></span>
        <div style="position:relative; margin:0 0 0 0px; padding:9px 10px; width:60%; display:inline-block; text-align:left; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #ee6e01; border-bottom:2px solid #ee6e01; vertical-align:bottom;">
          <img id="attached_reply_comment_image_{{=comment.id}}" src="" style="max-width:100%; margin:0 auto 10px 0; display:none;">
          <div id="attached_reply_edit_{{=comment.id}}" style="position:relative; margin-top:-50px; margin-bottom:10px; width:100%; height:40px; line-height:40px; text-align:center; font-size:12px; background-color:rgba(0,0,0,0.6); color:#fff; display:none;">
            <a href="#" onclick="$('#reply_comment_image_upload_{{=comment.id}}').click(); return false;" style="position:relative; width:50%; height:100%; display:block; color:#fff; float:left;">변경하기</a>
            <a href="#" onclick="reply_comment_image_delete({{=comment.id}}); return false;" style="position:relative; width:50%; height:100%; display:block; color:#fff; float:right;">삭제하기</a>
          </div>
          <textarea id="reply_comment_input_{{=comment.id}}" placeholder="{{=comment.user.string_id}}님의 의견에 한 마디 남겨주시겠어요?" style="display:block; padding:0px; width:100%; min-width:100%; max-width:100%; height:auto; overflow:hidden; box-sizing:border-box; border:none; color:#383838; background-color:#fff; border-radius:0px; font-size:13px; line-height:20px; text-align:left;"></textarea>
          <div id="reply_comment_text_counter_{{=comment.id}}" style="margin:0px 5px; height: 15px; text-align: right; font-size: 11px; color:#9d9ea1; display:none;">0 글자</div>
          <div id="reply_comment_input_cover_{{=comment.id}}" style="margin-top: -40px; height: 40px;" onclick="$('#reply_comment_input_{{=comment.id}}').focus(); $(this).hide();"></div>
          <div style="display:none;">
            <input type="file" name="reply_comment_image" id="reply_comment_image_upload_{{=comment.id}}" accept="image/*" onchange="reply_comment_image_upload({{=comment.id}}); return false;">
            <input type="hidden" name="reply_comment_image_id" id="reply_comment_image_id_{{=comment.id}}">
          </div>
          <a id="reply_comment_image_btn_{{=comment.id}}" href="#" onclick="$('#reply_comment_image_upload_{{=comment.id}}').click(); return false;" style="display:block; width:100%; height:40px; margin-top:10px; background-color:#fff; color:#666; border:1px solid #dbdbdb; box-sizing:border-box; text-align:center; line-height:40px; font-size:12px; border-radius:0; transition:all .5s;">
            <i class="fa fa-image"></i>&nbsp;이미지 첨부하기
          </a>
          <a id="send_reply_comment_btn_{{=comment.id}}" class="comment_update_btn" href="#" onclick="send_reply_comment({{=ask.id}}, {{=ask.left_ask_deal_id}}, {{=comment.id}}, true); return false;" style="display:block; width:100%; height:40px; margin-top:10px; background-color:#dbdbdb; color:#fff; text-align:center; line-height:40px; font-size:12px; border-radius:0px; transition:all .5s;">
            답글 남기기
          </a>
        </div>
        <a id="comment_reply_cancel_btn_{{=comment.id}}" class="comment_reply_cancel_btn" href="#" onclick="comment_reply_cancel({{=comment.id}}); return false;" style="padding:10px; margin-bottom:10px; color:#ee6e01; font-size:12px; display:inline-block;">취소</a>
      </div>
  	{{ }else{ }}
      <div id="comment_{{= comment.id }}" class="table_div" style="width:100%; text-align:right; margin:0; padding:5px 0;">
        {{ if (comment.is_deleted == false) { }}
          <div id="comment_content_{{=comment.id}}" style="text-align:right;">
            <div id="comment_menu_{{=comment.id}}" style="position:relative; display:inline-block; text-align:right; font-size:12px;">
              <a href="#" onclick="comment_like({{=comment.id}}); return false;" style="display:block; padding:0 0 10px 5px; color:{{= already_like.length == 1 ? '#ee6e01' : '#9d9ea1'}};">
                <span id="comment_{{=comment.id}}_like_count">{{=comment.like_count}}</span>
                <i id="comment_{{=comment.id}}_like_icon" class="fa {{= already_like.length == 1 ? 'fa-heart' : 'fa-heart-o'}}" style="color:{{= already_like.length == 1 ? '#ee6e01' : '#9d9ea1'}}; margin-right:1px;"></i>
              </a>
              <a id="comment_reply_btn_{{=comment.id}}" class="comment_reply_btn" href="#" onclick="comment_reply({{=ask.id}}, {{=comment.id}}); return false;" style="display:block; padding:0 0 10px 5px; color:#666;">
                답글<i class="fa fa-reply fa-flip-vertical" style="margin:1px 2px 0px 3px; font-size:10px; vertical-align:text-top;"></i>
              </a>
            </div>
            {{ if (comment.user_id == 1) { }}
            <div style="position:relative; margin:0 10px 0 0; padding:10px 15px 5px 10px; width:60%; display:inline-block; text-align:right; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #dbdbdb; border-bottom:2px solid #dbdbdb; vertical-align:bottom; overflow:hidden;">
              <span style="position:absolute; top:0; right:0; display:block; width:5px; height:100%; background-color:rgba(75, 61, 61, 0.8);"></span>
            {{ } else if (comment.user_id == current_user_id) { }}
            <div style="position:relative; margin:0 10px 0 0; padding:10px 15px 5px 10px; width:60%; display:inline-block; text-align:right; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #dbdbdb; border-bottom:2px solid #dbdbdb; vertical-align:bottom; overflow:hidden;">
              <span style="position:absolute; top:0; right:0; display:block; width:5px; height:100%; background-color:rgba(153, 134, 116, 0.7);"></span>
            {{ } else if (comment.user_id == ask.user_id) { }}
            <div style="position:relative; margin:0 10px 0 0; padding:10px 15px 5px 10px; width:60%; display:inline-block; text-align:right; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #dbdbdb; border-bottom:2px solid #dbdbdb; vertical-align:bottom; overflow:hidden;">
              <span style="position:absolute; top:0; right:0; display:block; width:5px; height:100%; background-color:rgba(238, 110, 1, 0.7);"></span>
            {{ } else { }}
            <div style="position:relative; margin:0 10px 0 0; padding:10px 10px 5px; width:60%; display:inline-block; text-align:right; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #dbdbdb; border-bottom:2px solid #dbdbdb; vertical-align:bottom; overflow:hidden;">
            {{ } }}
              {{ if (comment.image_file_name != null) { }}
                <img id="comment_image_{{=comment.id}}" src="{{= get_image_url(comment, 'comments', 'normal') }}" style="max-width:100%; margin:0 0 10px auto;" onerror="imgError(this);">
              {{ }else{ }}
                <img id="comment_image_{{=comment.id}}" src="" style="max-width:100%; margin:0 0 10px auto; display:none;">
              {{ } }}
              <span class="comment_content" style="display:block;">{{=comment.content.replace(new RegExp('<', 'g'), '&lt;').replace(new RegExp('\r?\n', 'g'), '<br>')}}</span>
              <div class="table_div" style="margin:5px 0 0; padding:5px 5px 0; border-top:1px solid #dbdbdb; font-size:12px;">
                <div style="display:inline-block; float:right; text-align:right;">
                  {{ if (comment.user_id == 1) { }}
                    <span style="float:right; margin-left:5px; color:#4b3d3d; font-weight:bold;">{{=comment.user.string_id}}</span>
                  {{ } else { }}
                    <span style="float:right; margin-left:5px; color:#998674;">{{=comment.user.string_id}}</span>
                  {{ } }}
                  <div style="float:right;">
                    {{ if ( comment.user_id == current_user_id ){ }}
                      <a id="comment_delete_btn_{{=comment.id}}" href="#" onclick="comment_del({{=ask.id}}, {{=comment.id}}, false); return false;" style="margin-left:0px; color:#dbdbdb;"><i class="fa fa-trash"></i></a>
                      <a id="comment_modify_btn_{{=comment.id}}" class="comment_modify_btn" href="#" onclick="comment_modify({{=comment.id}}); return false;" style="margin-left:5px; color:#dbdbdb;"><i class="fa fa-pencil"></i></a>
                    {{ }else{ }}
                      <a id="comment_report_btn_{{=comment.id}}" href="#" onclick="show_report_popup('comment', {{=comment.id}}); return false;" style="margin-left:0px; color:#dbdbdb;"><i class="fa fa-ban"></i></a>
                    {{ } }}
                  </div>
                </div>
                <div style="display:inline-block; float:left; text-align:left;">
                  {{ if (comment.user_id == 1) { }}
                    <span style="float:left; margin-right:5px; font-size:11px; font-weight:bold; color:#4b3d3d;"><i class="fa fa-star"></i></span>
                  {{ } else if (comment.user_id == current_user_id) { }}
                    <span style="float:left; margin-right:5px; font-size:11px; font-weight:bold; color:#998674;">ME</span>
                  {{ } else if (comment.user_id == ask.user_id) { }}
                    <span style="float:left; margin-right:5px; font-size:11px; font-weight:bold; color:#f18b33;">ASKER</span>
                  {{ } else { }}
                    <span style="float:left; margin-right:5px; font-size:11px; font-weight:bold; opacity:0.8; color:{{= comment.user.gender ? '#0389ed' : '#ea065e'}};">{{=get_user_ages(comment.user.birthday)}}</span>
                  {{ } }}
                  <span style="float:left; margin-right:0px; font-size:11px; color:#9d9ea1;">{{= get_past_time(comment.created_at)}}</span>
                </div>
              </div>
            </div>
          </div>
          <div id="comment_modify_box_{{=comment.id}}" style="text-align:right; display:none;">
            <a id="comment_modify_cancel_btn_{{=comment.id}}" class="comment_modify_cancel_btn" href="#" onclick="comment_modify_cancel({{=comment.id}}); return false;" style="padding:10px; margin-bottom:10px; color:#ee6e01; font-size:12px; display:inline-block;">취소</a>
            <div style="position:relative; margin:0 10px 0 0; padding:9px 10px; width:60%; display:inline-block; text-align:right; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #ee6e01; border-bottom:2px solid #ee6e01; vertical-align:bottom;">
              {{ if (comment.image_file_name != null) { }}
                <img id="modify_comment_image_{{=comment.id}}" src="{{= get_image_url(comment, 'comments', 'normal') }}" style="max-width:100%; margin:0 0 10px auto;" onerror="imgError(this);">
              {{ }else{ }}
                <img id="modify_comment_image_{{=comment.id}}" src="" style="max-width:100%; margin:0 0 10px auto; display:none;">
              {{ } }}
              <div id="modify_edit_{{=comment.id}}" style="position:relative; margin-top:-50px; margin-bottom:10px; width:100%; height:40px; line-height:40px; text-align:center; font-size:12px; background-color:rgba(0,0,0,0.6); color:#fff; display:{{=comment.image_file_name != null ? 'block' : 'none'}};">
                <a href="#" onclick="$('#modify_comment_image_upload_{{=comment.id}}').click(); return false;" style="position:relative; width:50%; height:100%; display:block; color:#fff; float:left;">변경하기</a>
                <a href="#" onclick="modify_comment_image_delete({{=comment.id}}); return false;" style="position:relative; width:50%; height:100%; display:block; color:#fff; float:right;">삭제하기</a>
              </div>
              <textarea id="comment_modify_input_{{=comment.id}}" placeholder="의견을 입력해주세요" rows="1" style="display:block; padding:0px; width:100%; min-width:100%; max-width:100%; height:auto; min-height:20px; overflow:hidden; box-sizing:border-box; border:none; color:#383838; background-color:#fff; border-radius:0; font-size:13px; line-height:20px; text-align:right;">{{=comment.content}}</textarea>
              <div id="comment_modify_text_counter_{{=comment.id}}" style="margin:0px 5px; height: 15px; text-align: right; font-size: 11px; color:#9d9ea1; display:none;">0 글자</div>
              <div style="display:none;">
                <input type="file" name="modify_comment_image" id="modify_comment_image_upload_{{=comment.id}}" accept="image/*" onchange="modify_comment_image_upload({{=comment.id}}); return false;">
                <input type="hidden" name="modify_comment_image_id" id="modify_comment_image_id_{{=comment.id}}">
              </div>
              <a id="modify_comment_image_btn_{{=comment.id}}" href="#" onclick="$('#modify_comment_image_upload_{{=comment.id}}').click(); return false;" style="display:{{=comment.image_file_name != null ? 'none' : 'block'}}; width:100%; height:40px; margin-top:10px; background-color:#fff; color:#666; border:1px solid #dbdbdb; box-sizing:border-box; text-align:center; line-height:40px; font-size:12px; border-radius:0; transition:all .5s;">
                <i class="fa fa-image"></i>&nbsp;이미지 첨부하기
              </a>
              <a id="comment_update_btn_{{=comment.id}}" class="comment_update_btn" href="#" onclick="comment_update({{=comment.id}}); return false;" style="display:block; width:100%; height:40px; margin-top:10px; background-color:#dbdbdb; color:#fff; text-align:center; line-height:40px; font-size:12px; border-radius:0; transition:all .5s;">
                수정하기
              </a>
            </div>
          </div>
        {{ } else if (reply_comments.length > 0) { }}
          <div id="comment_content_{{=comment.id}}" style="text-align:right;">
            <div style="position:relative; margin:0 10px 0 10px; padding:10px; background-color:#f0f2f4; color:#9d9ea1; width:60%; display:inline-block; font-size:13px; line-height:20px; word-break:break-all; border:1px solid #dbdbdb; border-bottom:2px solid #dbdbdb; vertical-align:bottom;">
              삭제된 댓글입니다.
            </div>
          </div>
        {{ } }}
      </div>
  		<div id="comment_{{=comment.id}}_reply_list">
  			{{ for(var i=0; i < reply_comments.length; i++) {  }}
  				{{ var reply_comment = reply_comments[i] }}
  				{{= replyCommentListTemplate({ask:ask, comment:reply_comment}) }}
  			{{ } }}
  		</div>
      <div id="reply_comment_box_{{=comment.id}}" style="text-align:right; padding:5px 0; display:none;">
        <a id="comment_reply_cancel_btn_{{=comment.id}}" class="comment_reply_cancel_btn" href="#" onclick="comment_reply_cancel({{=comment.id}}); return false;" style="padding:10px; margin-bottom:10px; color:#ee6e01; font-size:12px; display:inline-block;">취소</a>
        <div style="position:relative; margin:0 0 0 0px; padding:9px 10px; width:60%; display:inline-block; text-align:right; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #ee6e01; border-bottom:2px solid #ee6e01; vertical-align:bottom;">
          <img id="attached_reply_comment_image_{{=comment.id}}" src="" style="max-width:100%; margin:0 0 10px auto; display:none;">
          <div id="attached_reply_edit_{{=comment.id}}" style="position:relative; margin-top:-50px; margin-bottom:10px; width:100%; height:40px; line-height:40px; text-align:center; font-size:12px; background-color:rgba(0,0,0,0.6); color:#fff; display:none;">
            <a href="#" onclick="$('#reply_comment_image_upload_{{=comment.id}}').click(); return false;" style="position:relative; width:50%; height:100%; display:block; color:#fff; float:left;">변경하기</a>
            <a href="#" onclick="reply_comment_image_delete({{=comment.id}}); return false;" style="position:relative; width:50%; height:100%; display:block; color:#fff; float:right;">삭제하기</a>
          </div>
          <textarea id="reply_comment_input_{{=comment.id}}" placeholder="{{=comment.user.string_id}}님의 의견에 한 마디 남겨주시겠어요?" style="display:block; padding:0px; width:100%; min-width:100%; max-width:100%; height:auto; overflow:hidden; box-sizing:border-box; border:none; color:#383838; background-color:#fff; border-radius:0px; font-size:13px; line-height:20px; text-align:right;"></textarea>
          <div id="reply_comment_text_counter_{{=comment.id}}" style="margin:0px 5px; height: 15px; text-align: right; font-size: 11px; color:#9d9ea1; display:none;">0 글자</div>
          <div id="reply_comment_input_cover_{{=comment.id}}" style="margin-top: -40px; height: 40px;" onclick="$('#reply_comment_input_{{=comment.id}}').focus(); $(this).hide();"></div>
          <div style="display:none;">
            <input type="file" name="comment_image" id="reply_comment_image_upload_{{=comment.id}}" accept="image/*" onchange="reply_comment_image_upload({{=comment.id}}); return false;">
            <input type="hidden" name="comment_image_id" id="reply_comment_image_id_{{=comment.id}}">
          </div>
          <a id="reply_comment_image_btn_{{=comment.id}}" href="#" onclick="$('#reply_comment_image_upload_{{=comment.id}}').click(); return false;" style="display:block; width:100%; height:40px; margin-top:10px; background-color:#fff; color:#666; border:1px solid #dbdbdb; box-sizing:border-box; text-align:center; line-height:40px; font-size:12px; border-radius:0; transition:all .5s;">
            <i class="fa fa-image"></i>&nbsp;이미지 첨부하기
          </a>
          <a id="send_reply_comment_btn_{{=comment.id}}" class="comment_update_btn" href="#" onclick="send_reply_comment({{=ask.id}}, {{=ask.right_ask_deal_id}}, {{=comment.id}}, false); return false;" style="display:block; width:100%; height:40px; margin-top:10px; background-color:#dbdbdb; color:#fff; text-align:center; line-height:40px; font-size:12px; border-radius:0px; transition:all .5s;">
            답글 남기기
          </a>
        </div>
        <span><i class="fa fa-reply fa-flip-vertical" style="font-size:10px; vertical-align:top; margin:10px 15px 0px 5px; color:#666;"></i></span>
      </div>
  	{{ } }}
  {{ } }}
</script>

<script type="text/template" id="reply-comment-list-template">
	{{ var already_like = $.grep(my_like_comment, function(obj) { return obj.comment_id === comment.id }) }}
  {{ if (comment.is_deleted == false) { }}
  	{{ if (ask.left_ask_deal_id == comment.ask_deal_id){ }}
      <div id="comment_{{= comment.id }}" class="table_div" style="width:100%; text-align:left; margin:0; padding:5px 0;">
        <div id="comment_content_{{=comment.id}}" style="text-align:left;">
          <span><i class="fa fa-reply fa-rotate-180" style="font-size:10px; vertical-align:top; margin:10px 5px 0px 15px; color:#666;"></i></span>
          {{ if (comment.user_id == 1) { }}
          <div style="position:relative; margin:0 0 0 0px; padding:10px 10px 5px 15px; width:60%; display:inline-block; text-align:left; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #dbdbdb; border-bottom:2px solid #dbdbdb; vertical-align:bottom; overflow:hidden;">
            <span style="position:absolute; top:0; left:0; display:block; width:5px; height:100%; background-color:rgba(75, 61, 61, 0.8);"></span>
          {{ } else if (comment.user_id == current_user_id) { }}
          <div style="position:relative; margin:0 0 0 0px; padding:10px 10px 5px 15px; width:60%; display:inline-block; text-align:left; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #dbdbdb; border-bottom:2px solid #dbdbdb; vertical-align:bottom; overflow:hidden;">
            <span style="position:absolute; top:0; left:0; display:block; width:5px; height:100%; background-color:rgba(153, 134, 116, 0.7);"></span>
          {{ } else if (comment.user_id == ask.user_id) { }}
          <div style="position:relative; margin:0 0 0 0px; padding:10px 10px 5px 15px; width:60%; display:inline-block; text-align:left; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #dbdbdb; border-bottom:2px solid #dbdbdb; vertical-align:bottom; overflow:hidden;">
            <span style="position:absolute; top:0; left:0; display:block; width:5px; height:100%; background-color:rgba(238, 110, 1, 0.7);"></span>
          {{ } else { }}
          <div style="position:relative; margin:0 0 0 0px; padding:10px 10px 5px; width:60%; display:inline-block; text-align:left; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #dbdbdb; border-bottom:2px solid #dbdbdb; vertical-align:bottom; overflow:hidden;">
          {{ } }}
            {{ if (comment.image_file_name != null) { }}
              <img id="comment_image_{{=comment.id}}" src="{{= get_image_url(comment, 'comments', 'normal') }}" style="max-width:100%; margin:0 auto 10px 0;" onerror="imgError(this);">
            {{ }else{ }}
              <img id="comment_image_{{=comment.id}}" src="" style="max-width:100%; margin:0 auto 10px 0; display:none;">
            {{ } }}
            <span class="comment_content" style="display:block;">{{=comment.content.replace(new RegExp('<', 'g'), '&lt;').replace(new RegExp('\r?\n', 'g'), '<br>')}}</span>
            <div class="table_div" style="margin:5px 0 0; padding:5px 5px 0; border-top:1px solid #dbdbdb; font-size:12px;">
              <div style="display:inline-block; float:left; text-align:left;">
                {{ if (comment.user_id == 1) { }}
                  <span style="float:left; margin-right:5px; color:#4b3d3d; font-weight:bold;">{{=comment.user.string_id}}</span>
                {{ } else { }}
                  <span style="float:left; margin-right:5px; color:#998674;">{{=comment.user.string_id}}</span>
                {{ } }}
                <div style="float:left;">
                  {{ if ( comment.user_id == current_user_id ){ }}
                    <a id="comment_modify_btn_{{=comment.id}}" class="comment_modify_btn" href="#" onclick="comment_modify({{=comment.id}}); return false;" style="margin-right:5px; color:#dbdbdb;"><i class="fa fa-pencil"></i></a>
                    <a id="comment_delete_btn_{{=comment.id}}" href="#" onclick="comment_del({{=ask.id}}, {{=comment.id}}, true); return false;" style="margin-right:0px; color:#dbdbdb;"><i class="fa fa-trash"></i></a>
                  {{ }else{ }}
                    <a id="comment_report_btn_{{=comment.id}}" href="#" onclick="show_report_popup('comment', {{=comment.id}}); return false;" style="margin-right:0px; color:#dbdbdb;"><i class="fa fa-ban"></i></a>
                  {{ } }}
                </div>
              </div>
              <div style="display:inline-block; float:right; text-align:right;">
                {{ if (comment.user_id == 1) { }}
                  <span style="float:right; margin-left:5px; font-size:11px; font-weight:bold; color:#4b3d3d;"><i class="fa fa-star"></i></span>
                {{ } else if (comment.user_id == current_user_id) { }}
                  <span style="float:right; margin-left:5px; font-size:11px; font-weight:bold; color:#998674;">ME</span>
                {{ } else if (comment.user_id == ask.user_id) { }}
                  <span style="float:right; margin-left:5px; font-size:11px; font-weight:bold; color:#f18b33;">ASKER</span>
                {{ } else { }}
                  <span style="float:right; margin-left:5px; font-size:11px; font-weight:bold; opacity:0.8; color:{{= comment.user.gender ? '#0389ed' : '#ea065e'}};">{{=get_user_ages(comment.user.birthday)}}</span>
                {{ } }}
                <span style="float:right; margin-left:0px; font-size:11px; color:#9d9ea1;">{{= get_past_time(comment.created_at)}}</span>
              </div>
            </div>
          </div>
          <div id="comment_menu_{{=comment.id}}" style="position:relative; display:inline-block; text-align:left; font-size:12px;">
            <a href="#" onclick="comment_like({{=comment.id}}); return false;" style="display:block; padding:0 5px 10px 0; color:{{= already_like.length == 1 ? '#ee6e01' : '#9d9ea1'}};">
              <i id="comment_{{=comment.id}}_like_icon" class="fa {{= already_like.length == 1 ? 'fa-heart' : 'fa-heart-o'}}" style="color:{{= already_like.length == 1 ? '#ee6e01' : '#9d9ea1'}}; margin-left:1px;"></i>
              <span id="comment_{{=comment.id}}_like_count">{{=comment.like_count}}</span>
            </a>
          </div>
        </div>
        <div id="comment_modify_box_{{=comment.id}}" style="text-align:left; display:none;">
          <span><i class="fa fa-reply fa-rotate-180" style="font-size:10px; vertical-align:top; margin:10px 5px 0px 15px; color:#666;"></i></span>
          <div style="position:relative; margin:0 0 0 0px; padding:9px 10px; width:60%; display:inline-block; text-align:left; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #ee6e01; border-bottom:2px solid #ee6e01; vertical-align:bottom;">
            {{ if (comment.image_file_name != null) { }}
              <img id="modify_comment_image_{{=comment.id}}" src="{{= get_image_url(comment, 'comments', 'normal') }}" style="max-width:100%; margin:0 auto 10px 0;" onerror="imgError(this);">
            {{ }else{ }}
              <img id="modify_comment_image_{{=comment.id}}" src="" style="max-width:100%; margin:0 auto 10px 0; display:none;">
            {{ } }}
            <div id="modify_edit_{{=comment.id}}" style="position:relative; margin-top:-50px; margin-bottom:10px; width:100%; height:40px; line-height:40px; text-align:center; font-size:12px; background-color:rgba(0,0,0,0.6); color:#fff; display:{{=comment.image_file_name != null ? 'block' : 'none'}};">
              <a href="#" onclick="$('#modify_comment_image_upload_{{=comment.id}}').click(); return false;" style="position:relative; width:50%; height:100%; display:block; color:#fff; float:left;">변경하기</a>
              <a href="#" onclick="modify_comment_image_delete({{=comment.id}}); return false;" style="position:relative; width:50%; height:100%; display:block; color:#fff; float:right;">삭제하기</a>
            </div>
            <textarea id="comment_modify_input_{{=comment.id}}" placeholder="의견을 입력해주세요" rows="1" style="display:block; padding:0px; width:100%; min-width:100%; max-width:100%; height:auto; min-height:20px; overflow:hidden; box-sizing:border-box; border:none; color:#383838; background-color:#fff; border-radius:0; font-size:13px; line-height:20px; text-align:left;">{{=comment.content}}</textarea>
            <div id="comment_modify_text_counter_{{=comment.id}}" style="margin:0px 5px; height: 15px; text-align: right; font-size: 11px; color:#9d9ea1; display:none;">0 글자</div>
            <div style="display:none;">
              <input type="file" name="modify_comment_image" id="modify_comment_image_upload_{{=comment.id}}" accept="image/*" onchange="modify_comment_image_upload({{=comment.id}}); return false;">
              <input type="hidden" name="modify_comment_image_id" id="modify_comment_image_id_{{=comment.id}}">
            </div>
            <a id="modify_comment_image_btn_{{=comment.id}}" href="#" onclick="$('#modify_comment_image_upload_{{=comment.id}}').click(); return false;" style="display:{{=comment.image_file_name != null ? 'none' : 'block'}}; width:100%; height:40px; margin-top:10px; background-color:#fff; color:#666; border:1px solid #dbdbdb; box-sizing:border-box; text-align:center; line-height:40px; font-size:12px; border-radius:0; transition:all .5s;">
              <i class="fa fa-image"></i>&nbsp;이미지 첨부하기
            </a>
            <a id="comment_update_btn_{{=comment.id}}" class="comment_update_btn" href="#" onclick="comment_update({{=comment.id}}); return false;" style="display:block; width:100%; height:40px; margin-top:10px; background-color:#dbdbdb; color:#fff; text-align:center; line-height:40px; font-size:12px; border-radius:0; transition:all .5s;">
              수정하기
            </a>
          </div>
          <a id="comment_modify_cancel_btn_{{=comment.id}}" class="comment_modify_cancel_btn" href="#" onclick="comment_modify_cancel({{=comment.id}}); return false;" style="padding:10px; margin-bottom:10px; color:#ee6e01; font-size:12px; display:inline-block;">취소</a>
        </div>
      </div>
  	{{ }else{ }}
      <div id="comment_{{=comment.id}}" class="table_div" style="width:100%; text-align:right; margin:0; padding:5px 0;">
        <div id="comment_content_{{=comment.id}}" style="text-align:right;">
          <div id="comment_menu_{{=comment.id}}" style="position:relative; display:inline-block; text-align:right; font-size:12px;">
            <a href="#" onclick="comment_like({{=comment.id}}); return false;" style="display:block; padding:0 0 10px 5px; color:{{= already_like.length == 1 ? '#ee6e01' : '#9d9ea1'}};">
              <span id="comment_{{=comment.id}}_like_count">{{=comment.like_count}}</span>
              <i id="comment_{{=comment.id}}_like_icon" class="fa {{= already_like.length == 1 ? 'fa-heart' : 'fa-heart-o'}}" style="color:{{= already_like.length == 1 ? '#ee6e01' : '#9d9ea1'}}; margin-right:1px;"></i>
            </a>
          </div>
          {{ if (comment.user_id == 1) { }}
          <div style="position:relative; margin:0 0px 0 0; padding:10px 15px 5px 10px; width:60%; display:inline-block; text-align:right; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #dbdbdb; border-bottom:2px solid #dbdbdb; vertical-align:bottom; overflow:hidden;">
            <span style="position:absolute; top:0; right:0; display:block; width:5px; height:100%; background-color:rgba(75, 61, 61, 0.9);"></span>
          {{ } else if (comment.user_id == current_user_id) { }}
          <div style="position:relative; margin:0 0px 0 0; padding:10px 15px 5px 10px; width:60%; display:inline-block; text-align:right; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #dbdbdb; border-bottom:2px solid #dbdbdb; vertical-align:bottom; overflow:hidden;">
            <span style="position:absolute; top:0; right:0; display:block; width:5px; height:100%; background-color:rgba(153, 134, 116, 0.7);"></span>
          {{ } else if (comment.user_id == ask.user_id) { }}
          <div style="position:relative; margin:0 0px 0 0; padding:10px 15px 5px 10px; width:60%; display:inline-block; text-align:right; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #dbdbdb; border-bottom:2px solid #dbdbdb; vertical-align:bottom; overflow:hidden;">
            <span style="position:absolute; top:0; right:0; display:block; width:5px; height:100%; background-color:rgba(238, 110, 1, 0.7);"></span>
          {{ } else { }}
          <div style="position:relative; margin:0 0px 0 0; padding:10px 10px 5px; width:60%; display:inline-block; text-align:right; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #dbdbdb; border-bottom:2px solid #dbdbdb; vertical-align:bottom; overflow:hidden;">
          {{ } }}
            {{ if (comment.image_file_name != null) { }}
              <img id="comment_image_{{=comment.id}}" src="{{= get_image_url(comment, 'comments', 'normal') }}" style="max-width:100%; margin:0 0 10px auto;" onerror="imgError(this);">
            {{ }else{ }}
              <img id="comment_image_{{=comment.id}}" src="" style="max-width:100%; margin:0 0 10px auto; display:none;">
            {{ } }}
            <span class="comment_content" style="display:block;">{{=comment.content.replace(new RegExp('<', 'g'), '&lt;').replace(new RegExp('\r?\n', 'g'), '<br>')}}</span>
            <div class="table_div" style="margin:5px 0 0; padding:5px 5px 0; border-top:1px solid #dbdbdb; font-size:12px;">
              <div style="display:inline-block; float:right; text-align:right;">
                {{ if (comment.user_id == 1) { }}
                  <span style="float:right; margin-left:5px; color:#4b3d3d; font-weight:bold;">{{=comment.user.string_id}}</span>
                {{ } else { }}
                  <span style="float:right; margin-left:5px; color:#998674;">{{=comment.user.string_id}}</span>
                {{ } }}
                <div style="float:right;">
                  {{ if ( comment.user_id == current_user_id ){ }}
                    <a id="comment_delete_btn_{{=comment.id}}" href="#" onclick="comment_del({{=ask.id}}, {{=comment.id}}, false); return false;" style="margin-left:0px; color:#dbdbdb;"><i class="fa fa-trash"></i></a>
                    <a id="comment_modify_btn_{{=comment.id}}" class="comment_modify_btn" href="#" onclick="comment_modify({{=comment.id}}); return false;" style="margin-left:5px; color:#dbdbdb;"><i class="fa fa-pencil"></i></a>
                  {{ }else{ }}
                    <a id="comment_report_btn_{{=comment.id}}" href="#" onclick="show_report_popup('comment', {{=comment.id}}); return false;" style="margin-left:0px; color:#dbdbdb;"><i class="fa fa-ban"></i></a>
                  {{ } }}
                </div>
              </div>
              <div style="display:inline-block; float:left; text-align:left;">
                {{ if (comment.user_id == 1) { }}
                  <span style="float:left; margin-right:5px; font-size:11px; font-weight:bold; color:#4b3d3d;"><i class="fa fa-star"></i></span>
                {{ } else if (comment.user_id == current_user_id) { }}
                  <span style="float:left; margin-right:5px; font-size:11px; font-weight:bold; color:#998674;">ME</span>
                {{ } else if (comment.user_id == ask.user_id) { }}
                  <span style="float:left; margin-right:5px; font-size:11px; font-weight:bold; color:#f18b33;">ASKER</span>
                {{ } else { }}
                  <span style="float:left; margin-right:5px; font-size:11px; font-weight:bold; opacity:0.8; color:{{= comment.user.gender ? '#0389ed' : '#ea065e'}};">{{=get_user_ages(comment.user.birthday)}}</span>
                {{ } }}
                <span style="float:left; margin-right:0px; font-size:11px; color:#9d9ea1;">{{= get_past_time(comment.created_at)}}</span>
              </div>
            </div>
          </div>
          <span><i class="fa fa-reply fa-flip-vertical" style="font-size:10px; vertical-align:top; margin:10px 15px 0px 5px; color:#666;"></i></span>
        </div>
        <div id="comment_modify_box_{{=comment.id}}" style="text-align:right; display:none;">
          <a id="comment_modify_cancel_btn_{{=comment.id}}" class="comment_modify_cancel_btn" href="#" onclick="comment_modify_cancel({{=comment.id}}); return false;" style="padding:10px; margin-bottom:10px; color:#ee6e01; font-size:12px; display:inline-block;">취소</a>
          <div style="position:relative; margin:0 0px 0 0; padding:9px 10px; width:60%; display:inline-block; text-align:right; background-color:#fff; font-size:13px; line-height:20px; color:#383838; word-break:break-all; border:1px solid #ee6e01; border-bottom:2px solid #ee6e01; vertical-align:bottom;">
            {{ if (comment.image_file_name != null) { }}
              <img id="modify_comment_image_{{=comment.id}}" src="{{= get_image_url(comment, 'comments', 'normal') }}" style="max-width:100%; margin:0 0 10px auto;" onerror="imgError(this);">
            {{ }else{ }}
              <img id="modify_comment_image_{{=comment.id}}" src="" style="max-width:100%; margin:0 0 10px auto; display:none;">
            {{ } }}
            <div id="modify_edit_{{=comment.id}}" style="position:relative; margin-top:-50px; margin-bottom:10px; width:100%; height:40px; line-height:40px; text-align:center; font-size:12px; background-color:rgba(0,0,0,0.6); color:#fff; display:{{=comment.image_file_name != null ? 'block' : 'none'}};">
              <a href="#" onclick="$('#modify_comment_image_upload_{{=comment.id}}').click(); return false;" style="position:relative; width:50%; height:100%; display:block; color:#fff; float:left;">변경하기</a>
              <a href="#" onclick="modify_comment_image_delete({{=comment.id}}); return false;" style="position:relative; width:50%; height:100%; display:block; color:#fff; float:right;">삭제하기</a>
            </div>
            <textarea id="comment_modify_input_{{=comment.id}}" placeholder="의견을 입력해주세요" rows="1" style="display:block; padding:0px; width:100%; min-width:100%; max-width:100%; height:auto; min-height:20px; overflow:hidden; box-sizing:border-box; border:none; color:#383838; background-color:#fff; border-radius:0; font-size:13px; line-height:20px; text-align:right;">{{=comment.content}}</textarea>
            <div id="comment_modify_text_counter_{{=comment.id}}" style="margin:0px 5px; height: 15px; text-align: right; font-size: 11px; color:#9d9ea1; display:none;">0 글자</div>
            <div style="display:none;">
              <input type="file" name="modify_comment_image" id="modify_comment_image_upload_{{=comment.id}}" accept="image/*" onchange="modify_comment_image_upload({{=comment.id}}); return false;">
              <input type="hidden" name="modify_comment_image_id" id="modify_comment_image_id_{{=comment.id}}">
            </div>
            <a id="modify_comment_image_btn_{{=comment.id}}" href="#" onclick="$('#modify_comment_image_upload_{{=comment.id}}').click(); return false;" style="display:{{=comment.image_file_name != null ? 'none' : 'block'}}; width:100%; height:40px; margin-top:10px; background-color:#fff; color:#666; border:1px solid #dbdbdb; box-sizing:border-box; text-align:center; line-height:40px; font-size:12px; border-radius:0; transition:all .5s;">
              <i class="fa fa-image"></i>&nbsp;이미지 첨부하기
            </a>
            <a id="comment_update_btn_{{=comment.id}}" class="comment_update_btn" href="#" onclick="comment_update({{=comment.id}}); return false;" style="display:block; width:100%; height:40px; margin-top:10px; background-color:#dbdbdb; color:#fff; text-align:center; line-height:40px; font-size:12px; border-radius:0; transition:all .5s;">
              수정하기
            </a>
          </div>
          <span><i class="fa fa-reply fa-flip-vertical" style="font-size:10px; vertical-align:top; margin:10px 15px 0px 5px; color:#666;"></i></span>
        </div>
  		</div>
  	{{ } }}
  {{ } }}
</script>

<script type="text/template" id="ask-detail-btn-template">
  {{ if (is_card_opened) { }}
    <a id="ask_{{=ask.id}}_detail_off" class="card_detail" href="#" onclick="back_button(); return false;">
      <span style="font-size:12px;"><i class="fa fa-angle-double-up">&nbsp;</i>상세 닫기</span>
    </a>
  {{ }else{ }}
    <a id="ask_{{=ask.id}}_detail_on" class="card_detail" href="#" onclick="card_detail_on({{=ask.id}}); return false;">
      {{ var comments = $.grep(ask.comments, function(obj) { return obj.is_deleted === false }) }}
      {{ if (comments.length > 0) { }}
      <div id="ask_{{=ask.id}}_comment_preview" class="table_div comment_preview" style="margin-bottom:0; border-bottom:1px solid #f4f4f4; height:30px; overflow:hidden;">
        <ul style="width:100%; margin:0; padding:0; list-style:none;">
          {{ //for(var i=0; i < comments.length; i++) {  }}
            {{ //var comment = comments[i] }}
            {{ var comment = comments[comments.length-1] }}
            {{= askCommentPreviewTemplate({ask:ask, comment:comment}) }}
          {{ //} }}
        </ul>
      </div>
      {{ } }}
      <div>
        <span style="float:left; margin-left:15px;"><i class="fa fa-comment" style="font-size:15px; margin-right:3px;"></i>{{=ask.left_ask_deal.comment_count}}</span>
        <span style="font-size:12px;"><i class="fa fa-angle-double-down">&nbsp;</i>상세 열기</span>
        <span style="float:right; margin-right:15px;">{{=ask.right_ask_deal.comment_count}}<i class="fa fa-comment fa-flip-horizontal" style="font-size:15px; margin-left:3px;"></i></span>
      </div>
    </a>
  {{ } }}
</script>

<script type="text/template" id="ask-comment-preview-template">
	{{ if (ask.left_ask_deal_id == comment.ask_deal_id){ }}
		<li style="font-size:13px; color:#666; line-height:30px; height:30px; overflow:hidden; text-align:left;">
			<span style="display:block; padding:0 15px;">
				<span style="background-color:ghostwhite; padding:3px 5px 2px; border-radius:5px;">{{=comment.content.length > 20 ? comment.content.replace(new RegExp('<', 'g'), '&lt;').substring(0,20)+'&middot;&middot;&middot;' : comment.content.replace(new RegExp('<', 'g'), '&lt;')}}{{=comment.image_file_name == null ? '' : '<i class="fa fa-image" style="margin:0 5px; transform:rotateZ(10deg);"></i>'}}</span>
			</span>
		</li>
	{{ }else{ }}
		<li style="font-size:13px; color:#666; line-height:30px; height:30px; overflow:hidden; text-align:right;">
			<span style="display:block; padding:0 15px;">
				<span style="background-color:ghostwhite; padding:3px 5px 2px; border-radius:5px;">{{=comment.image_file_name == null ? '' : '<i class="fa fa-image" style="margin:0 5px; transform:rotateZ(-10deg);"></i>'}}{{=comment.content.length > 20 ? comment.content.replace(new RegExp('<', 'g'), '&lt;').substring(0,20)+'&middot;&middot;&middot;' : comment.content.replace(new RegExp('<', 'g'), '&lt;')}}</span>
			</span>
		</li>
	{{ } }}
</script>

<script>
	<% if flash[:ask_create] %>
		notify('<%=flash[:ask_create]%>'.replace('\n','<br>'));
	<% end %>

	var current_user_id = 0;
 	<% if current_user %>
 		current_user_id = <%= current_user.id %>;
 	<% end %>

	var asks = <%= raw @asks.to_json %>;
  var ask;

  var my_like_ask = <%= raw @my_like_ask.to_json %>,
	    my_votes = <%= raw @my_votes.to_json %>,
	    my_vote_count = <%= @my_votes.length %>,
      my_like_comment = <%= raw @my_like_comment.to_json %>;

	var askTemplate = _.template($('#ask-template').html()),
      askMenuTemplate = _.template($('#ask-menu-template').html()),
      askDealTemplate = _.template($('#ask-deal-template').html());
      detailVoteCountTemplate = _.template($('#detail-vote-count-template').html()),
      askDealTableTemplate = _.template($('#ask-deal-table-template').html()),
      askCommentTemplate = _.template($('#ask-comment-template').html()),
      askCommentListTemplate = _.template($('#ask-comment-list-template').html()),
      replyCommentListTemplate = _.template($('#reply-comment-list-template').html()),
      askCommentPreviewTemplate = _.template($('#ask-comment-preview-template').html()),
      askDetailBtnTemplate = _.template($('#ask-detail-btn-template').html());

	<% unless @ranking_asks.blank? %>
		var ranking_asks = <%= raw @ranking_asks.to_json %>;
		for(var i=ranking_asks.length; i > 0; i--) {
			asks.unshift(ranking_asks[i-1]);
		}
	<% end %>

  var currentPage = 1;
  $("#asks").append("<div id='page"+(currentPage-1)+"' style='margin:15px 0px;'></div>");
  !(function ask_load(){
    for(var i=0; i < asks.length; i++) {
      var ask = asks[i]
      $("#page"+(currentPage-1)).append(askTemplate({ask: ask}));
      hash_tagging(ask.message, $("#ask_"+ask.id+"_message_text"));
      link_tagging(ask.message, $("#ask_"+ask.id+"_message_text"));
      abbreviate_msg(ask.message, ask.id);
      hover_action(ask.id);
      // var comments = $.grep(ask.comments, function(obj) { return obj.is_deleted === false });
      // if (comments.length > 0) $('#ask_'+ask.id+'_comment_preview').vTicker('init', {pause:2500, mousePause:false});
    }
  })();

  if (currentPage == 1) {
    ga('send', 'event', '유저별/첫페이지 로딩 횟수', 'first_page_loading_per_user', current_user_id.toString(), 1);
  }
	var is_more_asks = true;
  var more_load = true;

  if (asks.length < <%= Ask::ASK_PER %>) {
    is_more_asks = false;
    more_load = false;
    $("#endless_loading").remove();
    $("#end_of_contents").show();
  };

  !(function ask_hide(){
	  var didScroll;
	  var lastScrollTop = 0;
    var vp_page = {};
    var vp_content = {};

		$(window).scroll(function(event){
			didScroll = true;
		});

    setInterval(function() {
      if (didScroll && !is_card_opened && asks.length >= <%= Ask::ASK_PER %>) {
        hasScrolled();
        didScroll = false;
      }
    }, 100);

	  function hasScrolled() {
	      var st = $(this).scrollTop();
        var vp = $(this).height();
	      if (st > lastScrollTop){
          if (window.location.pathname == "/" && nearBottomOfPage() && is_more_asks && more_load) { // 크롬에서 javascript 코드를 캐시하는거 같아서 url 분석해서 ask인 경우에만 작동하도록 변경
            for (var i=0; i<currentPage; i++){
              if ($("#page"+i).position().top < st + vp + vp) {
                vp_page[i] = "on";
              }
              if ($("#page"+i).position().top + $("#page"+i).height() < Math.max(st - vp, 0)) {
                vp_page[i] = "off";
              }
            }

      	    $.ajax({
      	        url: window.location.href,
      	        data: {'page': currentPage + 1},
      	        dataType: "json",
      	        type: 'GET',
      	        error: function(){
      	          notify('<i class="fa fa-exclamation-triangle"></i> 네트워크 오류');
      	        },
      	        success: function(data){
      	          var more_asks = data.asks;
      	        	$.merge(asks, more_asks);

      	        	if ( more_asks.length == 0 ) {
      	        		is_more_asks = false;
                    more_load = false;
      	        		$("#endless_loading").remove();
                    $("#end_of_contents").show();
                    currentPage -= 1;
      	        	} else {
                    more_load = true;
      	        		if( more_asks.length < <%= Ask::ASK_PER %> ){
      	        			is_more_asks = false;
                      more_load = false;
      	        			$("#endless_loading").remove();
                      $("#end_of_contents").show();
      	        		}
                    $("#asks").append("<div id='page"+currentPage+"' style='margin:15px 0px;'></div>");
      	        		for(var i=0; i < more_asks.length; i++) {
          						var ask = more_asks[i];
                      $("#page"+currentPage).append(askTemplate({ask: ask}));
      								hash_tagging(ask.message, $("#ask_"+ask.id+"_message_text"));
                      link_tagging(ask.message, $("#ask_"+ask.id+"_message_text"));
      								abbreviate_msg(ask.message, ask.id);
                      hover_action(ask.id);
                      // var comments = $.grep(ask.comments, function(obj) { return obj.is_deleted === false });
                      // if (comments.length > 0) $('#ask_'+ask.id+'_comment_preview').vTicker('init', {pause:2500, mousePause:false});
          					}
      	        	}
                  currentPage ++;
                  ga('send', 'event', '유저별/엔들리스 로딩 횟수', 'endless_loading_per_user', current_user_id.toString(), 1);
                  ga('send', 'event', '엔들리스 로딩 페이지', 'endless_loading_page', currentPage.toString(), 1);
      	        },
      	        beforeSend: function(){
                  more_load = false;
                },
                complete: function(){
                }
      		  });
          } else if (more_load) {
            for (var i=0; i<currentPage; i++){
              if ($("#page"+i).position().top < st + vp + vp) {
                vp_page[i] = "on";
              }
              if ($("#page"+i).position().top + $("#page"+i).height() < Math.max(st - vp, 0)) {
                vp_page[i] = "off";
              }
            }
          }
	      } else if (st < lastScrollTop) {
          for (var i=0; i<currentPage; i++){
            if ($("#page"+i).position().top + $("#page"+i).height() > Math.max(st - vp, 0)) {
              vp_page[i] = "on";
            }
            if ($("#page"+i).position().top > st + vp + vp) {
              vp_page[i] = "off";
            }
          }
	      }

        for (var i=0; i<currentPage; i++) {
          if (vp_page[i] == "off" && $("#page"+i).html() != "") {
            $("#page"+i).height($("#page"+i).height());
            vp_content[i] = $("#page"+i).html();
            $("#page"+i).empty();
          }
          if (vp_page[i] == "on" && $("#page"+i).html() == "") {
            $("#page"+i).height("inherit");
            $("#page"+i).html(vp_content[i]);
          }
        }

	      lastScrollTop = st;
	  }
	})();

	function abbreviate_msg(origin_string, ask_id) {
		var msg = $("#ask_"+ask_id+"_message_text");
		var msg_short = $("#ask_"+ask_id+"_message_text_shorten");
		var msg_more = $("#ask_"+ask_id+"_message_more");
		if (origin_string.length > 80) {
			msg.hide();
			msg_short.show();
			msg_short.html(origin_string.substring(0,80).replace(new RegExp('<', 'g'), '&lt;').replace(new RegExp('\r?\n', 'g'), '<br>').replace(/(<br>)+/g,"<br>")+"&nbsp;&middot;&middot;&middot;");
			hash_tagging(origin_string.substring(0,80), msg_short);
      link_tagging(origin_string.substring(0,80), msg_short);
			msg_more.show();
		};
	}

	function vote_ask_deal(ask_id, ask_deal_id, is_left){
	 	if (current_user_id == 0 && my_vote_count > 4){
	 		visitor_notify("더 많은 투표는 회원만 가능합니다");
	 	} else {
	 		$.ajax({
		        url: "/votes.json",
		        type: 'POST',
		        data: {'ask_id': ask_id, 'ask_deal_id': ask_deal_id, 'is_left':is_left },
		        dataType: 'json',
		        error: function(){
		          notify('<i class="fa fa-exclamation-triangle"></i> 네트워크 오류');
		        },
		        success: function(data){
		        	my_votes.push(data.vote);

	        		var vote_count_span = $("#ask_"+data.ask.id+"_vote_count");
              vote_count_span.prev().animateCssColor("tada","#ee6e01");
	        		vote_count_span.html( parseInt(vote_count_span.html()) + 1 + "표" ).animateCssColor("tada","#ee6e01");
	        		my_vote_count = my_vote_count + 1;

              if (is_card_opened || is_show_opened) {
                show_detail_vote_count(ask_id);
                $("#ask_"+ask_id+"_comment").html(askCommentTemplate({ask: data.ask}));
                for (i=0; i<data.ask.comments.length; i++) {
                  var comment = data.ask.comments[i];
                  link_tagging(comment.content, $('#comment_content_'+comment.id+' .comment_content'), true);
                };
                comment_input_setting(data.ask.id);
                $("#visitor_comment_overlay_"+ask_id).remove();
              }

              var total_count = data.ask.left_ask_deal.vote_count + data.ask.right_ask_deal.vote_count;
              var left_ratio = Math.round(data.ask.left_ask_deal.vote_count/total_count * 80);
              var right_ratio = Math.round(data.ask.right_ask_deal.vote_count/total_count * 80);

              setTimeout(function(){
                $('#ask_deal_'+data.ask.id).html(askDealTemplate({my_votes: my_votes, ask:data.ask}));
                $(".card_image_overlay_"+ask_id).animateCss("fadeIn");
                $(".card_image_overlay_"+ask_id).find("i").animateCss("rubberBand");
                graph_animation(ask_id, left_ratio, right_ratio);
                hover_action(ask_id);
                mini_comment(ask_id);
              }, 750);
		        },
		        beforeSend: function(){
              if (is_left) {
                $(".card_image_hover_"+ask_id+".left_card_image_hover").show().animateCss("slideInUp");
                $(".vote_btn_"+ask_id+".left_btn").css("background-color","#ffcc5a").html("탁월한 선택 <i class='fa fa-heart animated tada'></i>");
                $(".vote_btn_"+ask_id+".right_btn").css("background-color","#9d9ea1").html("...졌다 T_T");
              } else {
                $(".card_image_hover_"+ask_id+".right_card_image_hover").show().animateCss("slideInUp");
                $(".vote_btn_"+ask_id+".right_btn").css("background-color","#ffcc5a").html("탁월한 선택 <i class='fa fa-heart animated tada'></i>");
                $(".vote_btn_"+ask_id+".left_btn").css("background-color","#9d9ea1").html("...졌다 T_T");
              }
		        },
		        complete: function(){
		        }
			});
	 	}
	}

	function show_detail_vote_count(ask_id) {
    $("#detail_vote_count_"+ask_id).css({"height":"50px"});
    var ask = $.grep(asks, function(obj) { return obj.id === ask_id })[0];
    var already_vote = $.grep(my_votes, function(obj) { return obj.ask_id === ask_id });
    if ((is_card_opened || is_show_opened) && (already_vote.length != 0 || ask.user_id == current_user_id)) {
      $.ajax({
        url: "/asks/"+ask_id+"/show_detail.json",
        type: "GET",
        data: {'id': ask_id},
        dataType: 'json',
        error: function(){
          notify('<i class="fa fa-exclamation-triangle"></i> 네트워크 오류');
        },
        success: function(data){
          $("#detail_vote_count_"+ask_id).animate({"height":"195px"},750).html(detailVoteCountTemplate({detail_vote_count: data.detail_vote_count}));
        },
        beforeSend: function(){
          var loading = '<i class="fa fa-circle-o-notch fa-spin" style="font-size:15px; line-height:50px;"></i>';
          $("#detail_vote_count_"+ask_id).html(loading);
        },
        complete: function(){
        }
      });
    } else {
      var not_yet = '<span class="animated pulse" style="display:block; font-size:13px; font-weight:bold; line-height:50px; background-color:cornsilk;" onclick="notify(\'투표에 먼저 참여해주세요!\'); $(\'html, body\').animate({scrollTop:0},250); return false;"><i class="fa fa-bar-chart" style="color:#ee6e01;"></i> 누가 투표했을까요?</span>'
      $("#detail_vote_count_"+ask_id).html(not_yet);
    }
	}

  function card_detail_on(ask_id) {
    history.pushState(null, null, "/asks/"+ask_id);
		is_more_asks = false;
		is_card_opened = true;
		opened_ask_id = ask_id;
    card_open_st = $(window).scrollTop();

		$("#endless_loading").hide();
    $("#end_of_contents").hide();
    $("#movie_info").hide();
    $("#asks").hide();
    $("#ask_detail").show().html($("#ask_"+ask_id));

    var ask = $.grep(asks, function(obj) { return obj.id === ask_id })[0];
    $("#mini_new_comment_"+ask_id).slideUp(200);
    show_detail_vote_count(ask_id);
    tooltip_box(ask_id);
    $("#ask_"+ask_id+"_message_more").click();
    $("#ask_"+ask_id+"_comment").html(askCommentTemplate({ask: ask}));
    for (i=0; i<ask.comments.length; i++) {
      var comment = ask.comments[i];
      link_tagging(comment.content, $('#comment_content_'+comment.id+' .comment_content'), true);
    };
    comment_input_setting(ask_id);
    $("#ask_"+ask_id+"_detail_btn").html(askDetailBtnTemplate({ask: ask}));

    $("#search").hide();
    $("#search_dummy").hide();
    $(".home-float-btn-area").hide();

    $("html, body").animate({scrollTop:0},250,function(){
      $("#detail_vote_count_"+ask_id).show();
      $("#ask_deal_"+ask_id+"_table, #ask_"+ask_id+"_comment").slideDown(500);
    });

    main_header_button();

    ga('send', 'event', '질문별/상세화면 오픈 횟수', 'detail_view_opened', ask_id.toString(), 1);
    ga('send', 'event', '유저별/상세화면 오픈 횟수', 'detail_view_per_user', current_user_id.toString(), 1);
	}

  function card_detail_off(ask_id) {
    var ask = $.grep(asks, function(obj) { return obj.id === ask_id })[0];
    is_more_asks = true;
    is_card_opened = false;
    $("#endless_loading").show();
    if (!more_load) $("#end_of_contents").show();
    $("#movie_info").show();
    $("#asks").show();
    $("#ask_box_"+ask_id).html($("#ask_"+ask_id));
    $("#ask_detail").empty();

    $("#detail_vote_count_"+ask_id+", #ask_deal_"+ask_id+"_table, #ask_"+ask_id+"_comment").slideUp(500, function(){
      $("#detail_vote_count_"+ask_id).css("height","50px").html("").hide();
      $("#ask_deal_"+ask_id+"_table").hide();
      $("#ask_"+ask_id+"_comment").html("").hide();
    });
    if ($("#ask_"+ask_id+"_message_text_shorten").text().indexOf("·") != -1) {
      $("#ask_"+ask_id+"_message_text").hide();
      $("#ask_"+ask_id+"_message_text_shorten").show();
      $("#ask_"+ask_id+"_message_more").show();
    }
    $("#ask_"+ask_id+"_detail_btn").html(askDetailBtnTemplate({ask: ask}));

    $("#search").show();
    $("#search_dummy").show();
    $(".home-float-btn-area").show();

    window.scrollTo(0,card_open_st);

    main_header_button();
  }

  function ask_like(ask_id){
		<% if current_user %>
			$.ajax({
		        url: "/asks/"+ask_id+"/like.json",
		        type: 'POST',
		        data: {'blank': 'blank'},
		        dataType: 'json',
		        error: function(){
	            notify('<i class="fa fa-exclamation-triangle"></i> 네트워크 오류');
		        },
		        success: function(data){
	            var ask_like_icon = $("#ask_"+ask_id+"_like_icon");
              var like_count_span = $("#ask_"+ask_id+"_like_count");
		        	if (data.already_like){
                my_like_ask.pop(data.ask_like);
	              ask_like_icon.removeClass("fa-heart").addClass("fa-heart-o").animateCss("bounceIn");
                like_count_span.html( parseInt(like_count_span.html()) - 1 + "공감" );
		        	} else {
                my_like_ask.push(data.ask_like);
	              ask_like_icon.removeClass("fa-heart-o").addClass("fa-heart").animateCss("bounceIn");
                like_count_span.prev().animateCssColor("tada","#ee065e");
                like_count_span.html( parseInt(like_count_span.html()) + 1 + "공감" ).animateCssColor("tada","#ee065e");
		        	}
		        },
		        beforeSend: function(){
		        },
		        complete: function(){
		        }
			});
		<% else %>
			visitor_notify("관심 질문 등록은 회원만 가능합니다");
		<% end %>
	}

  function mini_comment(ask_id) {
    if (!(is_card_opened || is_show_opened)) {
      $("#mini_new_comment_"+ask_id).delay(500).slideDown(200);
      setTimeout(function(){
        $("#mini_comment_input_box_"+ask_id).css("transform","rotateX(0deg)").css("-webkit-transform","rotateX(0deg)");
        $("#mini_comment_notify_"+ask_id).css("transform","rotateX(180deg)").css("-webkit-transform","rotateX(180deg)");
      },1500);

      var keyPressed = [];
      var this_vote = $.grep(my_votes, function(obj) { return obj.ask_id === ask_id });

      $("#mini_comment_input_"+ask_id).on("click",function(){
        if (current_user_id == 0){
          $(this).blur();
          visitor_notify("의견 작성은 회원만 가능합니다");
        } else {
          $(this).focus();
        }
      }).keydown(function(e) {
        keyPressed[e.keyCode] = true;
        if (keyPressed[13] && (keyPressed[17] || keyPressed[91])) {
          e.preventDefault();
          $("#mini_send_comment_btn_"+ask_id).click();
          keyPressed = [];
        }
      }).keyup(function(e) {
        keyPressed[e.keyCode] = false;
        if( $(this).val().length > 0 ) {
          $("#mini_send_comment_btn_"+ask_id).css('background-color','#f18b33');
        } else {
          $("#mini_send_comment_btn_"+ask_id).css('background-color','#dbdbdb');
        }
      });
    }
  }

  function mini_ask_deal_id_change(ask_id, left_ask_deal_id, right_ask_deal_id, is_left){
		if (is_left){
      $("#mini_ask_deal_id_change_"+ask_id).find("i").addClass("fa-flip-horizontal");
      $("#mini_comment_input_"+ask_id).css("textAlign","right").focus();
      $("#mini_ask_deal_id_change_"+ask_id).attr("onclick", "mini_ask_deal_id_change("+ask_id+", "+left_ask_deal_id+", "+right_ask_deal_id+", false); return false;");
      $("#mini_send_comment_btn_"+ask_id).attr("onclick", "mini_send_comment("+ask_id+", "+right_ask_deal_id+", false); return false;");
		} else {
      $("#mini_ask_deal_id_change_"+ask_id).find("i").removeClass("fa-flip-horizontal");
      $("#mini_comment_input_"+ask_id).css("textAlign","left").focus();
      $("#mini_ask_deal_id_change_"+ask_id).attr("onclick", "mini_ask_deal_id_change("+ask_id+", "+left_ask_deal_id+", "+right_ask_deal_id+", true); return false;");
			$("#mini_send_comment_btn_"+ask_id).attr("onclick", "mini_send_comment("+ask_id+", "+left_ask_deal_id+", true); return false;");
		}
	}

  function mini_send_comment(ask_id, ask_deal_id, is_left){
			var content = $("#mini_comment_input_"+ask_id).val();
			if( content == "" || content == null ){
				notify('의견을 입력해주세요');
				return;
      } else if (content.length > 250) {
        notify('250자 이상은 입력이 불가능합니다');
        return;
      } else {
        $.ajax({
          url: "/comments.json",
          type: 'POST',
          data: {'content': content, 'ask_id':ask_id, 'ask_deal_id':ask_deal_id},
          dataType: 'json',
          async: false,  // 코멘트 중복 전송을 방지
          error: function(){
            notify('<i class="fa fa-exclamation-triangle"></i> 네트워크 오류');
          },
          success: function(data){
            var ask = $.grep(asks, function(obj) { return obj.id === ask_id })[0];
            if (data.message = "success"){
              ask.comments.push(data.comment);
              if (is_left) {
                ask.left_ask_deal.comment_count += 1;
              } else {
                ask.right_ask_deal.comment_count += 1;
              }
              $("#mini_comment_input_box_"+ask_id).css("transform","rotateX(180deg)").css("-webkit-transform","rotateX(180deg)");
              $("#mini_comment_notify_"+ask_id).text("복 받으실 거에요!").css("transform","rotateX(0deg)").css("-webkit-transform","rotateX(0deg)");
              $("#mini_new_comment_"+ask_id).delay(1000).slideUp(500);
              $("#ask_"+ask_id+"_detail_btn").html(askDetailBtnTemplate({ask: ask}));
              $("#ask_"+ask_id+"_comment_preview ul").animateCss("bounceInDown");
            }else{
              visitor_notify("의견 작성은 회원만 가능합니다");
            }
          },
          beforeSend: function(){
          },
          complete: function(){
          }
        });
      }
	}

  function comment_title_open(ask_id) {
    $("html, body").animate({scrollTop:$(document).height()},200);
    $("#comment_input_"+ask_id).focus();
  }

  function comment_text_count(comment_box) {
    var inputLength = comment_box.val().length;
    var textCounter = comment_box.next();
    textCounter.html(inputLength+" 글자");
		if (inputLength > 250) {
      textCounter.show().css('color','#ee6e01');
      textCounter.html("<i class='fa fa-exclamation-triangle'></i> 250자 이상은 입력이 불가능합니다");
		} else if (inputLength > 200) {
      textCounter.fadeIn(500).css('color','#9d9ea1');
		} else if (inputLength <= 200) {
      textCounter.fadeOut(500);
    }
  }

	function comment_input_setting(ask_id) {
    var keyPressed = [];
    var ask = $.grep(asks, function(obj) { return obj.id === ask_id })[0];
		var this_vote = $.grep(my_votes, function(obj) { return obj.ask_id === ask_id });

		$("#comment_input_"+ask_id).on("focus",function(){
			if (current_user_id == 0){
				$(this).blur();
				visitor_notify("의견 작성은 회원만 가능합니다");
			} else if ( this_vote.length == 0 && current_user_id != ask.user.id ){
				$(this).blur();
				notify("투표에 먼저 참여해주세요!");
				$("html, body").animate({scrollTop:0},250);
			} else {
        if ($(this).val() == "") $(this).val('\r').selectRange(0,0);
        $(this).parent().find(".tooltip_area").css("transform","scale(1) translateY(10%)");
        $("#comment_input_box_"+ask_id).css("borderColor","#ee6e01");
        $("#ask_deal_id_change_"+ask_id+"_left").css("color","#ee6e01");
        $("#ask_deal_id_change_"+ask_id+"_right").css("color","#ee6e01");
			}
    }).on('input',function(e){
      $(this).css({'height':'auto','overflow-y':'hidden'}).height(this.scrollHeight);
      comment_text_count($(this));
    }).on('blur',function(){
      $(this).parent().find(".tooltip_area").css("transform","scale(0) translateY(-100%)");
      $("#comment_input_box_"+ask_id).css("borderColor","#dbdbdb");
      $("#ask_deal_id_change_"+ask_id+"_left").css("color","#9d9ea1");
      $("#ask_deal_id_change_"+ask_id+"_right").css("color","#9d9ea1");
      var height = $(this).height();
      $("#comment_input_cover_"+ask_id).css({'height':height, 'marginTop':-height}).show();
    }).keydown(function(e) {
      keyPressed[e.keyCode] = true;
      if (keyPressed[13] && (keyPressed[17] || keyPressed[91])) {
        e.preventDefault();
        $("#send_comment_btn_"+ask_id).click();
        keyPressed = [];
      }
    }).keyup(function(e) {
      keyPressed[e.keyCode] = false;
      if( $(this).val().length > 1 ) {
        $("#send_comment_btn_"+ask_id).css('background-color','#f18b33');
        $(this).parent().find(".tooltip_area").css("transform","scale(0) translateY(-100%)");
      } else {
        if ($("#comment_image_id_"+ask_id).val() == "") $("#send_comment_btn_"+ask_id).css('background-color','#dbdbdb');
        $(this).parent().find(".tooltip_area").css("transform","scale(1) translateY(10%)");
      }
		});

    $("#comment_image_btn_"+ask_id).on("click",function(){
      if (current_user_id == 0){
				visitor_notify("의견 작성은 회원만 가능합니다");
        return false;
			} else if ( this_vote.length == 0 && current_user_id != ask.user.id ){
				notify("투표에 먼저 참여해주세요!");
				$("html, body").animate({scrollTop:0},250);
        return false;
			} else {
        $("#comment_image_upload_"+ask_id).click();
        return false;
			}
    });
	}

  function comment_image_upload(ask_id){
    var fileObj = $("#comment_image_upload_"+ask_id);
    $.each( $("#comment_image_upload_"+ask_id)[0].files, function( i, file ) {
      var formData = new FormData();
      formData.append('File', file);
      $.ajax({
        type: "POST",
        url: "/preview_images.json",
        data: formData,
        contentType: false,
        processData: false,
        error: function(){
          notify('<i class="fa fa-exclamation-triangle"></i> 네트워크 오류');
        },
        success: function (data) {
          $("#comment_image_id_"+ask_id).val(data.id);
          $("#attached_comment_image_"+ask_id).attr("src",data.image_url).show().animateCss("bounceIn");
          $("#attached_edit_"+ask_id).show();
          $("#comment_image_btn_"+ask_id).hide();
          $("#send_comment_btn_"+ask_id).css('background-color','#f18b33');
        },
        beforeSend: function(){
          progressStart();
        },
        complete: function(){
          progressEnd();
          fileObj.replaceWith(fileObj.clone(true));
        }
      }).fail(function (data) {}).done(function () {});
    });
	}

  function comment_image_delete(ask_id){
    $("#comment_image_id_"+ask_id).val("");
    $("#attached_comment_image_"+ask_id).animateCssHide("bounceOut");
    $("#attached_edit_"+ask_id).hide();
    $("#comment_image_btn_"+ask_id).show();
    if ($("#comment_input_"+ask_id).val() == "") $("#send_comment_btn_"+ask_id).css('background-color','#dbdbdb');
  }

	function send_comment(ask_id, ask_deal_id){
			var content = $("#comment_input_"+ask_id).val().replace(/\s*$/, "");
      var image_id = $("#comment_image_id_"+ask_id).val();
			if( (content == "" || content == null) && image_id == "" ){
				notify('의견을 입력해주세요');
				return;
			} else if (content.length > 250) {
        notify('250자 이상은 입력이 불가능합니다');
        return;
      } else {
        $.ajax({
          url: "/comments.json",
          type: 'POST',
          data: {'content': content, 'ask_id':ask_id, 'ask_deal_id':ask_deal_id, 'image_id': image_id},
          dataType: 'json',
          async: false,  // 코멘트 중복 전송을 방지
          error: function(){
            notify('<i class="fa fa-exclamation-triangle"></i> 네트워크 오류');
          },
          success: function(data){
            if (data.message = "success"){
              var ask = $.grep(asks, function(obj) { return obj.id === ask_id })[0];
              ask.comments.push(data.comment);
              $("#ask_"+ask_id+"_comment_list").append(askCommentListTemplate({ask:data.ask, comment:data.comment}));
              $("#comment_"+data.comment.id).animateCss("bounceInUp");
              link_tagging(data.comment.content, $('#comment_content_'+data.comment.id+' .comment_content'), true);

              $("#comment_image_id_"+ask_id).val("");
              $("#attached_comment_image_"+ask_id).attr("src","").hide();
              $("#attached_edit_"+ask_id).hide();
              $("#comment_image_btn_"+ask_id).show();

              $("#comment_input_"+ask_id).val("");
              $("#comment_text_counter_"+ask_id).hide();
              $("#comment_input_cover_"+ask_id).css({'height':'100px', 'marginTop':'-100px'}).show();

              $("#no_comment_"+ask_id).hide();
              $("#send_comment_btn_"+ask_id).css("background-color","#dbdbdb");
              $("#comment_input_"+ask_id).blur();

              if (ask_deal_text == "left"){
                var left_ask_deal_comment_count = $("#left_ask_deal_comment_count_"+data.comment.ask_id);
                left_ask_deal_comment_count.html( parseInt(left_ask_deal_comment_count.html()) + 1 ).animateCss("tada");
                ask.left_ask_deal.comment_count = ask.left_ask_deal.comment_count + 1;
              }else{
                var right_ask_deal_comment_count = $("#right_ask_deal_comment_count_"+data.comment.ask_id);
                right_ask_deal_comment_count.html( parseInt(right_ask_deal_comment_count.html()) + 1 ).animateCss("tada");
                ask.right_ask_deal.comment_count = ask.right_ask_deal.comment_count + 1;
              }
              $("#comment_input_"+ask_id).height(0);
            }else{
              visitor_notify("의견 작성은 회원만 가능합니다");
            }
          },
          beforeSend: function(){
          },
          complete: function(){
          }
        });
      }
	}

	function comment_like(comment_id){
		<% if current_user %>
			$.ajax({
		        url: "/comments/"+comment_id+"/like.json",
		        type: 'POST',
		        data: {'blank': 'blank'},
		        dataType: 'json',
		        error: function(){
		          notify('<i class="fa fa-exclamation-triangle"></i> 네트워크 오류');
		        },
		        success: function(data){
	            var comment_like_icon = $("#comment_"+comment_id+"_like_icon")
		        	var comment_count_span = $("#comment_"+comment_id+"_like_count");
		        	if (data.already_like){
                my_like_comment.pop(data.comment_like);
		        		comment_count_span.html( parseInt(comment_count_span.html()) - 1 );
	              comment_count_span.css("color","#9d9ea1");
	              comment_like_icon.removeClass("fa-heart").addClass("fa-heart-o").css("color","#9d9ea1").animateCss("bounceIn");
		        	}else{
                my_like_comment.push(data.comment_like);
		        		comment_count_span.html( parseInt(comment_count_span.html()) + 1 );
	              comment_count_span.css("color","#ee6e01");
	              comment_like_icon.removeClass("fa-heart-o").addClass("fa-heart").css("color","#ee6e01").animateCss("bounceIn");
		        	}
		        },
		        beforeSend: function(){
		        },
		        complete: function(){
		        }
			});
		<% else %>
			visitor_notify("의견 추천은 회원만 가능합니다");
		<% end %>
	}

	function comment_del(ask_id, comment_id, is_left){
	  if(confirm("의견을 정말로 삭제하시겠어요?")) {
	    $.ajax({
        url: "/comments/"+comment_id+"/comment_del.json",
        type: 'DELETE',
        data: {'blank': 'blank'},
        dataType: 'json',
        error: function(){
          notify('<i class="fa fa-exclamation-triangle"></i> 네트워크 오류');
        },
        success: function(data){
          var ask = $.grep(asks, function(obj) { return obj.id === ask_id })[0];
          ask.comments.pop(data.comment);
          if (data.status == "success") {
            $("#comment_"+comment_id).animateCssRemove("bounceOutDown");
            $("#comment_"+comment_id+"_reply_list").remove();
            $("#reply_comment_box_"+comment_id).remove();
          } else if (data.status == "reply_exist") {
            $("#comment_content_"+comment_id).nextAll().remove();
            $("#comment_content_"+comment_id).html('<div style="position:relative; margin:0 10px 0 10px; padding:10px; background-color:#f0f2f4; color:#9d9ea1; width:60%; display:inline-block; font-size:13px; line-height:20px; word-break:break-all; border:1px solid #dbdbdb; border-bottom:2px solid #dbdbdb; vertical-align:bottom;">삭제된 댓글입니다.</div>').animateCss("flipInX");
          }
          if (is_left){
            var left_ask_deal_comment_count = $("#left_ask_deal_comment_count_"+ask_id);
            left_ask_deal_comment_count.html( parseInt(left_ask_deal_comment_count.html()) - 1 );
            ask.left_ask_deal.comment_count = ask.left_ask_deal.comment_count - 1;
          }else{
            var right_ask_deal_comment_count = $("#right_ask_deal_comment_count_"+ask_id);
            right_ask_deal_comment_count.html( parseInt(right_ask_deal_comment_count.html()) - 1 );
            ask.right_ask_deal.comment_count = ask.right_ask_deal.comment_count - 1;
          }
          if ( ask.left_ask_deal.comment_count + ask.right_ask_deal.comment_count == 0 ) $("#no_comment_"+ask_id).show().animateCss("bounceInUp");
        },
        beforeSend: function(){
        },
        complete: function(){
        }
      });
    }
	}

  var comment_id_in_progress = null;
  var comment_id_in_progress_type = null;
  var comment_content_origin = null;
  var comment_image_origin = null;
  var comment_image_url = null;
  var modify_content_origin = null;
	function comment_modify(comment_id){
    if (comment_id_in_progress) {
      if (confirm('기존에 작성중인 내용은 삭제됩니다. 진행하시겠어요?')) {
        if (comment_id_in_progress_type == "modify") comment_modify_cancel(comment_id_in_progress);
        if (comment_id_in_progress_type == "reply") comment_reply_cancel(comment_id_in_progress);
        comment_id_in_progress = comment_id;
        comment_id_in_progress_type = "modify";
      } else {
        return false;
      }
    } else {
      comment_id_in_progress = comment_id;
      comment_id_in_progress_type = "modify";
    }

		var comment_content = $("#comment_content_"+comment_id);
    var height = comment_content.find(".comment_content").height();
		var modify_box = $("#comment_modify_box_"+comment_id);
		var modify_input = $("#comment_modify_input_"+comment_id);
		var update_btn = $("#comment_update_btn_"+comment_id);
    var comment_image = $("#modify_comment_image_"+comment_id);

    comment_content_origin = modify_input.val();
    comment_image_origin = comment_image.attr("src");
    comment_image_url = comment_image_origin;
    modify_content_origin = modify_box.html();
		comment_content.hide();
    modify_box.show().animateCss("flipInX");
    modify_input.height(height).focus();

		$("#comment_modify_btn_"+comment_id).hide();
		$("#comment_modify_cancel_btn_"+comment_id).show();

    var keyPressed = [];
    modify_input.keydown(function(e) {
      keyPressed[e.keyCode] = true;
      if (keyPressed[13] && (keyPressed[17] || keyPressed[91])) {
        keyPressed = [];
        e.preventDefault();
        update_btn.click();
      }
    }).keyup(function(e) {
      keyPressed[e.keyCode] = false;
      if( modify_input.val() != comment_content_origin || comment_image_url != comment_image_origin ) {
				update_btn.css('background-color','#f18b33');
			} else {
				update_btn.css('background-color','#dbdbdb');
			};
    }).on('input',function(e){
      $(this).css({'height':'auto','overflow-y':'hidden'}).height(this.scrollHeight);
      comment_text_count($(this));
    });
	}

	function comment_modify_cancel(comment_id){
    comment_id_in_progress = null;
    comment_id_in_progress_type = null;
		var comment_content = $("#comment_content_"+comment_id);
		var modify_box = $("#comment_modify_box_"+comment_id);
		var modify_input = $("#comment_modify_input_"+comment_id);
		var update_btn = $("#comment_update_btn_"+comment_id);

    comment_content.show().animateCss("fadeIn");
    modify_box.hide().html(modify_content_origin);
    modify_input.val(comment_content_origin);
    modify_input.blur();
		update_btn.css("background-color","#dbdbdb");
    comment_content_origin = null;
    comment_image_url = null;
    modify_content_origin = null;

		$("#comment_modify_btn_"+comment_id).show();
		$("#comment_modify_cancel_btn_"+comment_id).hide();
	}

  function modify_comment_image_upload(comment_id){
    var fileObj = $("#modify_comment_image_upload_"+comment_id);
    $.each( $("#modify_comment_image_upload_"+comment_id)[0].files, function( i, file ) {
      var formData = new FormData();
      formData.append('File', file);
      $.ajax({
        type: "POST",
        url: "/preview_images.json",
        data: formData,
        contentType: false,
        processData: false,
        error: function(){
          notify('<i class="fa fa-exclamation-triangle"></i> 네트워크 오류');
        },
        success: function (data) {
          $("#modify_comment_image_id_"+comment_id).val(data.id);
          $("#modify_comment_image_"+comment_id).attr("src",data.image_url).show().animateCss("bounceIn");
          comment_image_url = data.image_url;
          $("#modify_edit_"+comment_id).show();
          $("#modify_comment_image_btn_"+comment_id).hide();
          $("#comment_update_btn_"+comment_id).css('background-color','#f18b33');
        },
        beforeSend: function(){
          progressStart();
        },
        complete: function(){
          progressEnd();
          fileObj.replaceWith(fileObj.clone(true));
        }
      }).fail(function (data) {}).done(function () {});
    });
	}

  function modify_comment_image_delete(comment_id){
    $("#modify_comment_image_id_"+comment_id).val("image_delete");
    $("#modify_comment_image_"+comment_id).animateCssHide("bounceOut");
    comment_image_url = null;
    $("#modify_edit_"+comment_id).hide();
    $("#modify_comment_image_btn_"+comment_id).css("display","block");
    if ($("#comment_modify_input_"+comment_id).val() != "") $("#comment_update_btn_"+comment_id).css('background-color','#f18b33');
  }

	function comment_update(comment_id){
		var comment_content = $("#comment_content_"+comment_id);
		var comment_text = comment_content.find(".comment_content").text();
		var modify_box = $("#comment_modify_box_"+comment_id);
		var modify_input = $("#comment_modify_input_"+comment_id);
		var update_btn = $("#comment_update_btn_"+comment_id);
    var comment_image = $("#modify_comment_image_"+comment_id);

    var content = modify_input.val().replace(/\s*$/, "");
    var image_id = $("#modify_comment_image_id_"+comment_id).val();
    if( (content == "" || content == null) && comment_image_url == null ){
      notify('의견을 입력해주세요');
      return;
    } else if ( content == comment_content_origin && comment_image_url == comment_image_origin ) {
      notify('내용이 수정되지 않았습니다');
      return;
    } else if (content.length > 250) {
      notify('250자 이상은 입력이 불가능합니다');
      return;
    } else {
			$.ajax({
				url: "/comments/"+comment_id+".json",
				type: 'PUT',
				data: {'content': content, 'image_id':image_id},
				dataType: 'json',
				error: function(){
					notify('<i class="fa fa-exclamation-triangle"></i> 네트워크 오류');
				},
				success: function(data){
					comment_content.find(".comment_content").html(content.replace(new RegExp('<', 'g'), '&lt;').replace(new RegExp('\r?\n', 'g'), '<br>'));
          link_tagging(content, $('#comment_content_'+comment_id+' .comment_content'), true);
          comment_content.show().animateCss("flipInX");
					modify_box.hide();
          modify_box.parent().css("borderColor","#dbdbdb");
          modify_input.val(comment_content.find(".comment_content").html().replace(new RegExp('<br>', 'g'), '\n')).blur();
					update_btn.css("background-color","#dbdbdb");

          $("#comment_modify_text_counter_"+comment_id).hide();

          var url = get_image_url(data.comment, 'comments', 'normal');
          if (data.status == "no_image" && data.comment.image_file_name == null) {
            $("#comment_image_"+comment_id).attr("src","").hide();
          } else {
            $("#comment_image_"+comment_id).attr("src",url).show();
          }

					$("#comment_modify_btn_"+comment_id).show();
					$("#comment_modify_cancel_btn_"+comment_id).hide();

          comment_id_in_progress = null;
          comment_id_in_progress_type = null;
          comment_content_origin = null;
          comment_image_origin = null;
          modify_content_origin = null;
				},
				beforeSend: function(){
				},
				complete: function(){
				}
			});
		}
	}

	function comment_reply(ask_id, comment_id){
    if (comment_id_in_progress) {
      if (confirm('기존에 작성중인 내용은 삭제됩니다. 진행하시겠어요?')) {
        if (comment_id_in_progress_type == "modify") comment_modify_cancel(comment_id_in_progress);
        if (comment_id_in_progress_type == "reply") comment_reply_cancel(comment_id_in_progress);
        comment_id_in_progress = comment_id;
        comment_id_in_progress_type = "reply";
      } else {
        return false;
      }
    }

		var this_vote = $.grep(my_votes, function(obj) { return obj.ask_id === ask_id });
		var ask_user_id = $.grep(asks, function(obj) {return obj.id == ask_id})[0].user_id;
		if (current_user_id == 0){
			visitor_notify("의견 작성은 회원만 가능합니다");
		} else if ( this_vote.length == 0 && current_user_id != ask_user_id ) {
			var card_open_st = $("#ask_"+ask_id).offset().top - 110;
			$("html, body").animate({scrollTop:card_open_st},250);
			notify("투표에 먼저 참여해주세요!");
		} else {
      comment_id_in_progress = comment_id;
      comment_id_in_progress_type = "reply";
			var reply_box = $("#reply_comment_box_"+comment_id);
			var reply_input = $("#reply_comment_input_"+comment_id);
			var update_btn = $("#send_reply_comment_btn_"+comment_id);

      reply_box.slideDown(200).animateCss("flipInX");

			$("#comment_reply_btn_"+comment_id).hide();
			$("#comment_reply_cancel_btn_"+comment_id).show();

      var keyPressed = [];
      reply_input.on('focus',function(){
        if ($(this).val() == "") $(this).val('\r').selectRange(0,0);
      }).on('input',function(e){
        $(this).css({'height':'auto','overflow-y':'hidden'}).height(this.scrollHeight);
        comment_text_count($(this));
      }).on('blur',function(){
        var height = $(this).height();
        $("#reply_comment_input_cover_"+comment_id).css({'height':height, 'marginTop':-height}).show();
      }).keydown(function(e) {
        keyPressed[e.keyCode] = true;
        if (keyPressed[13] && (keyPressed[17] || keyPressed[91])) {
          keyPressed = [];
          e.preventDefault();
          update_btn.click();
        }
      }).keyup(function(e) {
        keyPressed[e.keyCode] = false;
        if( reply_input.val().length > 1 ) {
					update_btn.css('background-color','#f18b33');
				} else {
					if ($("#reply_comment_image_id_"+comment_id).val() == "") update_btn.css('background-color','#dbdbdb');
				}
      });

      $("#reply_comment_input_cover_"+comment_id).click();
		}
	}

	function comment_reply_cancel(comment_id){
    comment_id_in_progress = null;
    comment_id_in_progress_type = null;
		var reply_box = $("#reply_comment_box_"+comment_id);
		var reply_input = $("#reply_comment_input_"+comment_id);
		var update_btn = $("#send_reply_comment_btn_"+comment_id);

    reply_box.slideUp(200);
		reply_input.blur().val("").css({"height":"40px"}).unbind();
		update_btn.css("background-color","#dbdbdb");

    $("#reply_comment_image_id_"+comment_id).val("");
    $("#attached_reply_comment_image_"+comment_id).hide();
    $("#attached_reply_edit_"+comment_id).hide();
    $("#reply_comment_image_btn_"+comment_id).show();

		$("#comment_reply_btn_"+comment_id).show();
		$("#comment_reply_cancel_btn_"+comment_id).hide();
	}

  function reply_comment_image_upload(comment_id){
    var fileObj = $("#reply_comment_image_upload_"+comment_id);
    $.each( $("#reply_comment_image_upload_"+comment_id)[0].files, function( i, file ) {
      var formData = new FormData();
      formData.append('File', file);
      $.ajax({
        type: "POST",
        url: "/preview_images.json",
        data: formData,
        contentType: false,
        processData: false,
        error: function(){
          notify('<i class="fa fa-exclamation-triangle"></i> 네트워크 오류');
        },
        success: function (data) {
          $("#reply_comment_image_id_"+comment_id).val(data.id);
          $("#attached_reply_comment_image_"+comment_id).attr("src",data.image_url).show().animateCss("bounceIn");
          $("#attached_reply_edit_"+comment_id).show();
          $("#reply_comment_image_btn_"+comment_id).hide();
          $("#send_reply_comment_btn_"+comment_id).css('background-color','#f18b33');
        },
        beforeSend: function(){
          progressStart();
        },
        complete: function(){
          progressEnd();
          fileObj.replaceWith(fileObj.clone(true));
        }
      }).fail(function (data) {}).done(function () {});
    });
	}

  function reply_comment_image_delete(comment_id){
    $("#reply_comment_image_id_"+comment_id).val("");
    $("#attached_reply_comment_image_"+comment_id).animateCssHide("bounceOut");
    $("#attached_reply_edit_"+comment_id).hide();
    $("#reply_comment_image_btn_"+comment_id).show();
    if ($("#reply_comment_input_"+comment_id).val() == "") $("#send_reply_comment_btn_"+comment_id).css('background-color','#dbdbdb');
  }

	function send_reply_comment(ask_id, ask_deal_id, comment_id, is_left){
		var content = $("#reply_comment_input_"+comment_id).val().replace(/\s*$/, "");
    var image_id = $("#reply_comment_image_id_"+comment_id).val();
		if( (content == "" || content == null) && image_id == "" ){
			notify('의견을 입력해주세요');
			return false;
    } else if (content.length > 250) {
      notify('250자 이상은 입력이 불가능합니다');
      return;
		} else {
      $.ajax({
        url: "/comments.json",
        type: 'POST',
        data: {'content': content, 'ask_id':ask_id, 'ask_deal_id':ask_deal_id, 'comment_id':comment_id, 'image_id':image_id},
        dataType: 'json',
        async: false,  // 코멘트 중복 전송을 방지
        error: function(){
          notify('<i class="fa fa-exclamation-triangle"></i> 네트워크 오류');
        },
        success: function(data){
          if (data.message = "success"){
            var ask = $.grep(asks, function(obj) { return obj.id === ask_id })[0];
            ask.comments.push(data.comment);
            $("#comment_"+comment_id+"_reply_list").append(replyCommentListTemplate({ask:data.ask, comment:data.comment}));
            $("#comment_"+data.comment.id).animateCss("flipInX");
            link_tagging(data.comment.content, $('#comment_content_'+data.comment.id+' .comment_content'), true);

            $("#reply_comment_text_counter_"+comment_id).hide();
            comment_reply_cancel(comment_id);

            if (is_left){
              var left_ask_deal_comment_count = $("#left_ask_deal_comment_count_"+data.comment.ask_id);
              left_ask_deal_comment_count.html( parseInt(left_ask_deal_comment_count.html()) + 1 ).animateCss("tada");
              ask.left_ask_deal.comment_count = ask.left_ask_deal.comment_count + 1;
            }else{
              var right_ask_deal_comment_count = $("#right_ask_deal_comment_count_"+data.comment.ask_id);
              right_ask_deal_comment_count.html( parseInt(right_ask_deal_comment_count.html()) + 1 ).animateCss("tada");
              ask.right_ask_deal.comment_count = ask.right_ask_deal.comment_count + 1;
            }
          }else{
            visitor_notify("의견 작성은 회원만 가능합니다");
          }
          comment_id_in_progress = null;
          comment_id_in_progress_type = null;
        },
        beforeSend: function(){
        },
        complete: function(){
        }
      });
    }
	}

	function ask_deal_id_change(ask_id, left_ask_deal_id, right_ask_deal_id){
    var margin = $("#new_comment").width() - $("#comment_input_box_"+ask_id).outerWidth() - 10;
		if (ask_deal_text == "center") {
      notify("투표에 먼저 참여해주세요!");
      var card_open_st = $("#ask_"+ask_id).offset().top - 110;
      $("html, body").animate({scrollTop:card_open_st},250);
    } else if (ask_deal_text == "left") {
      $("#ask_deal_id_change_"+ask_id+"_right").css("marginRight","-50px");
      $("#ask_deal_id_change_"+ask_id+"_left").css("marginLeft","10px");
      $("#comment_input_box_"+ask_id).css("margin","0 10px 0 "+margin+"px");
      $("#comment_input_"+ask_id).css("textAlign","right").focus();
      ask_deal_text = "right";
      $("#send_comment_btn_"+ask_id).attr("onclick", "send_comment("+ask_id+", "+right_ask_deal_id+"); return false;");
		} else if (ask_deal_text == "right") {
      $("#ask_deal_id_change_"+ask_id+"_right").css("marginRight","10px");
      $("#ask_deal_id_change_"+ask_id+"_left").css("marginLeft","-50px");
      $("#comment_input_box_"+ask_id).css("margin","0 "+margin+"px 0 10px");
      $("#comment_input_"+ask_id).css("textAlign","left").focus();
      ask_deal_text = "left";
			$("#send_comment_btn_"+ask_id).attr("onclick", "send_comment("+ask_id+", "+left_ask_deal_id+"); return false;");
		}
	}

  function show_menu(ask_id) {
    var ask = $.grep(asks, function(obj) { return obj.id === ask_id })[0];
    $("#ask_"+ask_id+"_menu").append(askMenuTemplate({ask: ask})).slideDown("normal");
    $("#ask_"+ask_id+"_category").find(".more_icon").css("transform","rotate(-180deg)").attr("onclick","hide_menu("+ask_id+"); return false;");
    $("#share_icon_"+ask_id).animateCssColor("zoomIn","#ee6e01");
    $(window).one("scroll touchmove", function(){
      hide_menu(ask_id);
    })
  }

  <% if flash[:ask_create] && flash[:ask_id] %>
    show_menu(Number("<%=flash[:ask_id]%>"));
  <% end %>

  function hide_menu(ask_id) {
    $("#ask_"+ask_id+"_menu").delay(150).slideUp("slow", function(){$(this).empty()});
    $("#ask_"+ask_id+"_category").find(".more_icon").css("transform","rotate(0deg)").attr("onclick","show_menu("+ask_id+"); return false;");
  }

  function show_menu_tooltip() {
    var new_tooltip = '<div class="tooltip_area animated pulse"><div class="tooltip_arrow bottom" style="left:20px;"></div><div class="tooltip_content" style="color:#ffcc5a;"><i class="fa fa-heart" style="color:#ee065e;"></i> 여기를 눌러 공유나, 투표취소를 할 수 있어요 :)</div></div>';
    $(".more_icon:eq(0)").parent().prepend(new_tooltip);
    setTimeout(function(){
      $(".more_icon:eq(0)").parent().find(".tooltip_area").fadeOut(300, function(){ $(this).remove() });
    },3000);
  }
  show_menu_tooltip();

  function vote_modify(ask_id){
    $.ajax({
          url: "/votes/vote_cancle.json",
          type: 'POST',
          data: {'ask_id': ask_id},
          dataType: 'json',
          error: function(){
            notify('<i class="fa fa-exclamation-triangle"></i> 네트워크 오류');
          },
          success: function(data){
            var ask = $.grep(asks, function(obj) { return obj.id === ask_id })[0];
            var change_votes = $.grep(my_votes, function(obj) { return obj.ask_id != ask.id });
            my_votes = change_votes;
            $("#ask_deal_"+ask_id).html(askDealTemplate({my_votes: my_votes, ask: ask}));

            var vote_count_span = $("#ask_"+ask.id+"_vote_count");
            vote_count_span.html( parseInt(vote_count_span.html()) - 1 + "표" );

            my_vote_count = my_vote_count - 1;

            show_detail_vote_count(ask_id);
            comment_input_setting(ask_id);
            hover_action(ask_id);
          },
          beforeSend: function(){
            hide_menu(ask_id);
          },
          complete: function(){
          }
    });
  }

</script>
