<%= render :partial => "common_partial/header", :locals => @ask.id ? {:title => "수정하기", :sub_title => "질문을 수정할 수 있습니다", :sub_icon => ""} : {:title => "질문하기", :sub_title => "자유롭게 질문을 작성해보세요!", :sub_icon => ""} %>

<div style="background:#f4f4f4; padding:15px 12px 40px; text-align:left;">
	<%= form_for(@ask) do |f| %>
		<div class="content_box" style="padding:10px; margin-bottom:15px;">
			<div class="table_div">
				<%= f.select :category_id, options_for_select(Category.all.collect {|c| [ c.name, c.id ] }, ["관심사", f.object.category_id]), { include_blank: "어떤 제품/서비스의 구매를 고민중이신가요?" }, :class => "category_select" %>
				<span class="input_icon left_input" onclick="$('#ask_category_id').focus().select(); return false;"><i class="fa fa-filter"></i></span>
			</div>
			<div class="table_div" style="margin-bottom:0px; height:120px;">
				<div id="hashtag_container">
					<%= f.text_area :message, :placeholder => "구매를 고민하고 있는 상황을 알려주세요! #고민고민하지마 #VASKIT", :class => "ask_message_input", :style => "position:absolute;" %>
					<div id="hashtag_backdrop">
						<div id="hashtag_highlights"></div>
					</div>
				</div>
				<span class="input_icon left_input" onclick="$('#ask_message').focus(); return false;" style="height: 120px; line-height: 120px;"><i class="fa fa-hashtag"></i></span>
			</div>
			<div id="text_counter_info" style="float:left; margin:5px 0 0 5px; height: 15px; text-align: center; font-size: 12px; color:#9d9ea1;"><i class="fa fa-info-circle"></i>&nbsp;기본화면에는 80자까지 보여집니다.</div>
			<div id="text_counter" style="float:right; margin:5px 5px 0 0; height: 15px; text-align: center; font-size: 12px; color:#9d9ea1;">0 글자</div>
		</div>

		<div class="content_box" style="padding:10px; margin-bottom:10px;">
			<div class="table_div">
				<a class="ask_search_deal" href="#" onclick="show_search_deal_popup(true); return false;" style="float:left;">
					<i class="fa fa-search" style="color:#ee6e01;"></i>&nbsp;CARD A 검색하기
				</a>
				<a class="ask_search_deal" href="#" onclick="show_search_deal_popup(false); return false;" style="float:right;">
					<i class="fa fa-search" style="color:#ee6e01;"></i>&nbsp;CARD B 검색하기
				</a>
			</div>
			<span class="seperate_line"></span>
			<div id="card_overlay" style="<% if @ask.id %> display:block; <% else %> display:none; <% end %>">
				<div class="table_div" style="border:1px solid #dbdbdb;">
					<a id="left_deal_image_btn" href="#" onclick="left_deal_image_upload(); return false;" style="position:relative; display:block; float:left; width:50%; box-sizing:border-box; overflow:hidden;">
						<img src="<%= @left_ask_deal && @left_ask_deal.image ? @left_ask_deal.image.url(:normal) : "/images/custom/card_image_preview.png" %>" style="display:block; margin:0 auto; width:100%;">
						<div id="card_a_img_overlay" style="position:absolute; top:0; left:0; width:100%; height:100%; background-color:#f4f4f4; text-align:center; color:#666; display:<% if @ask.id %>none<% else %>block<% end %>;">
  						<span style="top:50%; left:50%; margin-top:-50px; margin-left:-50px; position:absolute; font-size:13px; padding:25px 20px 20px; width:100px; height:100px; background-color:#fff; border-radius:60px; box-sizing:border-box;"><i class="fa fa-image" style="font-size:20px; margin-bottom:5px;"></i><br>이미지<br>업로드</span>
						</div>
					</a>
					<a id="right_deal_image_btn" href="#" onclick="right_deal_image_upload(); return false;" style="position:relative; display:block; float:right; width:50%; box-sizing:border-box; overflow:hidden;">
						<img src="<%= @right_ask_deal && @right_ask_deal.image ? @right_ask_deal.image.url(:normal) : "/images/custom/card_image_preview.png" %>" style="display:block; margin:0 auto; width:100%;">
						<div id="card_b_img_overlay" style="position:absolute; top:0; left:0; width:100%; height:100%; background-color:#f4f4f4; text-align:center; color:#666; border-left:1px solid #dbdbdb; display:<% if @ask.id %>none<% else %>block<% end %>;">
							<span style="top:50%; left:50%; margin-top:-50px; margin-left:-50px; position:absolute; font-size:13px; padding:25px 20px 20px; width:100px; height:100px; background-color:#fff; border-radius:60px; box-sizing:border-box;"><i class="fa fa-image" style="font-size:20px; margin-bottom:5px;"></i><br>이미지<br>업로드</span>
						</div>
					</a>
				</div>
				<span class="seperate_line"></span>
				<div class="table_div">
					<%= text_area_tag 'left_deal[title]', @left_ask_deal && @left_ask_deal.title ? @left_ask_deal.title : nil, :placeholder => "제품명*", :class => "ask_text_field left_input", :rows => 1 %>
					<%= text_area_tag 'right_deal[title]', @right_ask_deal && @right_ask_deal.title ? @right_ask_deal.title : nil, :placeholder => "*제품명", :class => "ask_text_field right_input", :rows => 1 %>
					<span class="input_icon center_input" onclick="$('#left_deal_title').focus(); return false;"><i class="fa fa-cube"></i></span>
				</div>
				<div class="table_div">
					<%= text_area_tag 'left_deal[brand]', @left_ask_deal && @left_ask_deal.brand ? @left_ask_deal.brand : nil, :placeholder => "브랜드", :class => "ask_text_field left_input", :rows => 1 %>
					<%= text_area_tag 'right_deal[brand]', @right_ask_deal && @right_ask_deal.brand ? @right_ask_deal.brand : nil, :placeholder => "브랜드", :class => "ask_text_field right_input", :rows => 1 %>
					<span class="input_icon center_input" onclick="$('#left_deal_brand').focus(); return false;"><i class="fa fa-tag"></i></span>
				</div>
				<div class="table_div">
					<%= text_field 'left_deal[price]', @left_ask_deal && @left_ask_deal.price ? @left_ask_deal.price : nil, :placeholder => "판매가격", :class => "ask_text_field left_input", :id => "left_deal_price", :pattern => "[0-9]*", :name => "left_deal[price]" %>
					<%= text_field 'right_deal[price]', @right_ask_deal && @right_ask_deal.price ? @right_ask_deal.price : nil, :placeholder => "판매가격", :class => "ask_text_field right_input", :id => "right_deal_price", :pattern => "[0-9]*", :name => "right_deal[price]" %>
					<span class="input_icon center_input" onclick="$('#left_deal_price').focus(); return false;"><i class="fa fa-won"></i></span>
				</div>
				<div class="table_div">
					<%= text_area_tag 'left_deal[link]', @left_ask_deal && @left_ask_deal.link ? @left_ask_deal.link : nil, :placeholder => "링크", :class => "ask_text_field left_input", :rows => 1 %>
					<%= text_area_tag 'right_deal[link]', @right_ask_deal && @right_ask_deal.link ? @right_ask_deal.link : nil, :placeholder => "링크", :class => "ask_text_field right_input", :rows => 1 %>
					<span class="input_icon center_input" onclick="$('#left_deal_link').focus(); return false;"><i class="fa fa-link"></i></span>
				</div>
				<span class="seperate_line"></span>
				<div class="table_div" style="margin-bottom:0px;">
					<div id="add_info_1" style="display:none;">
						<%= f.text_field :spec1, :placeholder => "제목", :class => "ask_text_field center_input add_info" %>
						<div class="table_div">
							<%= text_area_tag 'left_deal[spec1]', @left_ask_deal && @left_ask_deal.spec1 ? @left_ask_deal.spec1 : nil, :placeholder => "내용", :class => "ask_text_field left_input add_info_left", :rows => 1 %>
							<%= text_area_tag 'right_deal[spec1]', @right_ask_deal && @right_ask_deal.spec1 ? @right_ask_deal.spec1 : nil, :placeholder => "내용", :class => "ask_text_field right_input add_info_right", :rows => 1 %>
							<span class="input_icon center_input" onclick="$('#ask_spec1').focus(); return false;"><i class="fa fa-plus-circle"></i></span>
						</div>
					</div>
					<div id="add_info_2" style="display:none;">
						<%= f.text_field :spec2, :placeholder => "제목", :class => "ask_text_field center_input add_info" %>
						<div class="table_div">
							<%= text_area_tag 'left_deal[spec2]', @left_ask_deal && @left_ask_deal.spec2 ? @left_ask_deal.spec2 : nil, :placeholder => "내용", :class => "ask_text_field left_input add_info_left", :rows => 1 %>
							<%= text_area_tag 'right_deal[spec2]', @right_ask_deal && @right_ask_deal.spec2 ? @right_ask_deal.spec2 : nil, :placeholder => "내용", :class => "ask_text_field right_input add_info_right", :rows => 1 %>
							<span class="input_icon center_input" onclick="$('#ask_spec2').focus(); return false;"><i class="fa fa-plus-circle"></i></span>
						</div>
					</div>
					<div id="add_info_3" style="display:none;">
						<%= f.text_field :spec3, :placeholder => "제목", :class => "ask_text_field center_input add_info" %>
						<div class="table_div" style="margin-bottom:0px;">
							<%= text_area_tag 'left_deal[spec3]', @left_ask_deal && @left_ask_deal.spec3 ? @left_ask_deal.spec3 : nil, :placeholder => "내용", :class => "ask_text_field left_input add_info_left", :rows => 1 %>
							<%= text_area_tag 'right_deal[spec3]', @right_ask_deal && @right_ask_deal.spec3 ? @right_ask_deal.spec3 : nil, :placeholder => "내용", :class => "ask_text_field right_input add_info_right", :rows => 1 %>
							<span class="input_icon center_input" onclick="$('#ask_spec3').focus(); return false;"><i class="fa fa-plus-circle"></i></span>
						</div>
					</div>
					<div id="add_info_btn" onclick="show_more_add_info(); return false;" style="position:relative; height:36px; line-height:36px; margin-top:10px; margin-bottom:5px; border:1px solid #dbdbdb; border-radius:5px; background-color:#fff; color:#9d9ea1; font-size:13px; text-align:center; cursor:pointer;">
		  			<i class="fa fa-plus-circle"></i>&nbsp;추가 정보 입력하기
					</div>
				</div>
				<span class="seperate_line"></span>
			</div>
			<span id="card_overlay_open" class="input_icon left_input" onclick="<% if @ask.id %> hide_card_overlay(); <% else %> show_card_overlay(); <% end %> return false;" style="position:relative; display:block; width: inherit; height: 40px; line-height: 40px; border-right-width: 3px; border-bottom-width: 3px; border-radius: 5px; background-color:<% if @ask.id %>#f4f4f4<% else %>#fff<% end %>; padding-left: 2px; cursor:pointer; font-size:13px; overflow:hidden;">
				<% if @ask.id %>닫기<% else %>직접 입력하기<% end %>&nbsp;<i class="fa <% if @ask.id %> fa-angle-double-up <% else %> fa-angle-double-down <% end %>" style="font-size:15px;"></i>
			</span>
		</div>
		<div style="display:none;">
			<%= file_field_tag 'left_deal[image]', :accept => 'image/*', :multiple => false, :style => "visibility:hidden; width:1px; display:inline;" %>
			<%= hidden_field_tag 'left_deal[image_id]' %>

			<%= file_field_tag 'right_deal[image]', :accept => 'image/*', :multiple => false, :style => "visibility:hidden; width:1px; display:inline;" %>
			<%= hidden_field_tag 'right_deal[image_id]' %>

			<%= hidden_field_tag 'left_deal[deal_id]' %>
			<%= hidden_field_tag 'right_deal[deal_id]' %>
		</div>
	<% end %>
</div>

<div style="position:absolute; bottom:0; color:#9d9ea1; font-size:12px; padding:0px 25px 20px; text-align:left;"><i class="fa fa-asterisk"></i>&nbsp;카테고리, 상황설명, 제품명, 제품이미지는 필수 입력정보입니다.</div>
<div id="ask_submit_btn_area" style="position:fixed; bottom:-40px; width:inherit; box-sizing:border-box; transition:bottom .3s; z-index:1;">
	<% if @ask.id %>
		<a id="ask_submit_btn" href="#" onclick="edit_form(); return false;" class="ask_submit_btn">
			<i class="fa fa-send"></i>&nbsp;질문 수정하기
		</a>
	<% else %>
		<a id="ask_submit_btn" href="#" onclick="submit_form(); return false;" class="ask_submit_btn">
			<i class="fa fa-send"></i>&nbsp;질문 제출하기
		</a>
	<% end %>
</div>

<div id="search_deal_popup" style="width:inherit; z-index:13; position:fixed; top:50px; display:none;">
	<div style="padding:10px;">
		<div id="search_deal_result" style="display:none;">
			<table cellspacing="0" cellpadding="0" style="width:100%; background-color:#fff;">
				<tr>
					<td style="width:50%;">
						<a id="naver_deals_btn" href="#" onclick="show_naver_deals(); return false;" style="font-size:15px; color:#383838; line-height:50px; display:block; background-color:#fff; ">
							<i class="fa fa-shopping-cart" style="color:#666;"></i> 제품 검색결과
						</a>
					</td>
					<td style="width:50%;">
						<a id="naver_images_btn" href="#" onclick="show_naver_images(); return false;" style="font-size:15px; color:#383838; line-height:50px; display:block; border-bottom:1px solid #dbdbdb; border-left:1px solid #dbdbdb;  background-color:#f4f4f4;">
							<i class="fa fa-image" style="color:#666;"></i> 이미지 검색결과
						</a>
					</td>
				</tr>
			</table>
			<div id="search_result_div" style="background-color:#fff; border-top:10px solid #fff; overflow-y:auto; -webkit-overflow-scrolling:touch; min-height:150px; max-height:340px;">
				<div id="naver_deals">
					<p style='margin:0; line-height:300px; color:#9d9ea1; font-size:15px;'><i class='fa fa-search'></i> 제품 검색결과가 없습니다</p>
				</div>
				<div id="naver_images">
					<p style='margin:0; line-height:300px; color:#9d9ea1; font-size:15px;'><i class='fa fa-search'></i> 이미지 검색결과가 없습니다</p>
				</div>
			</div>
		</div>
	</div>
</div>
<div id="deal_search_input" class="table_div" style="position:fixed; top:50%; z-index:15; width:inherit; margin-top:-50px; transition:top .5s; display:none;" ontouchmove="return false;">
	<div style="position:relative; margin:10px; border-bottom:3px solid #fff;">
		<input id="deal_search_keyword" type="text" class="etc_input_box" placeholder="제품명 검색" style="padding:0px 40px 0px 10px; background-color:transparent; color:#fff; font-size:20px; line-height:40px;"/>
		<a id="deal_search_btn" href="#" style="position:absolute; top:3px; right:0; width:40px; height:40px; line-height:40px; display:inline-block; text-align:center; color:#666; font-size:20px; transition:color .3s;"><i class="fa fa-level-down fa-rotate-90"></i></a>
		<a id="deal_search_cancle" href="#" onclick="back_button(); return false;" style="position:absolute; top:3px; right:0; width:40px; height:40px; line-height:40px; text-align:center; color:#fff; font-size:35px; display:none;">&times;</a>
	</div>
</div>

<script type="text/template" id="naver-deal-template">
	<table cellspacing="0" cellpadding="0" style="width:100%;">
		{{ var length = items.length ? items.length : 1 }}
		{{ for(var i=0; i < length; i++) { }}
			{{ var item = length == 1 ? items : items[i] }}
			<tr onclick="select_deal('{{=item.productId}}', {{=is_left}}); return false;">
				<td style="width:50%; height:auto; padding:10px; border-bottom:1px solid #dbdbdb; cursor:pointer;">
					<img src="{{=item.image}}" style="width:100%; height:auto; display:block;" />
				</td>
				<td style="width:50%; height:auto; padding:10px; padding-right:20px; text-align:left; border-bottom:1px solid #dbdbdb; cursor:pointer;">
					<p style="font-size:12px; margin:0; color:#9d9ea1; padding-bottom:5px;">{{= item.mallName }}</p>
					<p style="font-size:15px; margin:0; color:#383838; font-weight:bold;">{{= truncate(item.title) }}</p>
					<p style="font-size:12px; margin:0; color:#ee6e01; text-align:right; padding-top:5px;">{{= numberWithCommas(item.lprice) }}원</p>
				</td>
			</tr>
		{{ } }}
	</table>
	<div style="padding:15px; font-size:13px; color:#666; background-color:#f4f4f4;" onclick='$("#deal_search_keyword").focus();'>
		<b style="color:#18bf2d;">네이버 쇼핑</b> 검색 결과입니다<br>원하시는 결과가 없으면 검색어를 수정해보세요<br><b style="font-weight:bold; display:inline-block; margin-top:9px;"><i class="fa fa-search" style="color:#9d9ea1;"></i> 다시 검색하기</b>
	</div>
</script>

<script type="text/template" id="naver-image-template">
	<div style="padding:10px;">
		{{ var length = image_items.length ? image_items.length : 1 }}
		{{ for(var i=0; i < length; i++) { }}
			{{ var image_item = length == 1 ? image_items : image_items[i] }}
			{{ var thumbnail = image_item.thumbnail.replace("?q=", "?t=470x180&q=") }}
			{{ var link = encodeURI(image_item.link) }}
			{{ if (image_item.sizewidth >= 300 && image_item.sizeheight >= 300) { }}
				<img src="{{=link}}" onclick="select_image('{{=link}}', {{=is_left}}); return false;" style="width:100%; height:auto; display:block; outline:1px solid #dbdbdb; cursor:pointer;" onerror="imgError(this, '{{=thumbnail}}');"/>
				<p style="width:100%; box-sizing:border-box; font-size:12px; margin:0; color:#9d9ea1; padding:5px 5px 15px; text-align:right;">{{=image_item.sizewidth}} &times; {{=image_item.sizeheight}}</p>
			{{ } }}
		{{ } }}
	</div>
	<div style="padding:15px; font-size:13px; color:#666; background-color:#f4f4f4;" onclick='$("#deal_search_keyword").focus();'>
		<b style="color:#18bf2d;">네이버 이미지</b> 검색 결과입니다<br>원하시는 결과가 없으면 검색어를 수정해보세요<br><b style="font-weight:bold; display:inline-block; margin-top:9px;"><i class="fa fa-search" style="color:#9d9ea1;"></i> 다시 검색하기</b>
	</div>
</script>


<script>
	var items;
	var image_items;

	function show_search_deal_popup(is_left){
		history.pushState(null, null, null);
		is_search_deal_opened = true;
		overlay_st = $(window).scrollTop();

		disableScroll();
		$("#menu_bg_full").fadeIn(200);
		$("#search_deal_popup").show();

		$("#deal_search_input").show().animateCss("bounceInUp");
		$("#deal_search_keyword").on("focus", function(){
			$(this).val("");
			$("#deal_search_btn").fadeIn();
			$("#deal_search_cancle").fadeOut();
		}).on("keyup",function(){
			if( $("#deal_search_keyword").val().length > 0 ) {
				$('#deal_search_btn').css('color','#fff');
			} else {
				$('#deal_search_btn').css('color','#666');
			}
		});
		if (!isIOS) $("#deal_search_keyword").focus().select();

		$("#deal_search_btn").attr("onclick", "deal_search("+is_left+"); return false;");
		show_card_overlay();
	}

	$(window).resize(function(){
		var h = $(window).height() - 131;
		$("#search_result_div").css({"minHeight":h, "maxHeight":h});
	}).resize();

	function hide_search_deal_popup(){
		is_search_deal_opened = false;
    window.scrollTo(0,overlay_st);

		enableScroll();
		$("#search_deal_popup").fadeOut();
		$("#menu_bg_full").fadeOut();

		$("#deal_search_input").css({"top":"50%"}).hide();
		$("#deal_search_keyword").unbind("blur").val("");
		$("#search_deal_result").hide();
		$("#naver_deals").html("");
		$("#naver_images").html("");

		$("#deal_search_btn").attr("onclick","").css("color","#666");
		$("#deal_search_btn").show();
		$("#deal_search_cancle").hide();
	}

	function deal_search_by_key(){
		$("#deal_search_btn").click();
	}

	$('#deal_search_keyword').keypress(function(e) {
		if (e.keyCode == '13') {
    	e.preventDefault();
    	deal_search_by_key();
  	}
	}).keydown(function(e) {
		if (e.keyCode == '27') {
			e.preventDefault();
			$(this).val("");
		}
	});

	function show_naver_deals(){
		$("#search_result_div").scrollTop(0);
		$("#naver_deals").show();
		$("#naver_images").hide();
		$("#naver_images_btn").css("border-bottom","1px solid #dbdbdb");
		$("#naver_images_btn").css("border-left","1px solid #dbdbdb");
		$("#naver_images_btn").css("background-color","#f4f4f4");
		$("#naver_deals_btn").css("border-bottom","none");
		$("#naver_deals_btn").css("border-right","none");
		$("#naver_deals_btn").css("background-color","#fff");
	}

	function show_naver_images(){
		$("#search_result_div").scrollTop(0);
		$("#naver_deals").hide();
		$("#naver_images").show();
		$("#naver_deals_btn").css("border-bottom","1px solid #dbdbdb");
		$("#naver_deals_btn").css("border-right","1px solid #dbdbdb");
		$("#naver_deals_btn").css("background-color","#f4f4f4");
		$("#naver_images_btn").css("border-bottom","none");
		$("#naver_images_btn").css("border-left","none");
		$("#naver_images_btn").css("background-color","#fff");
	}

	function deal_search(is_left){
		var deal_search_keyword = $('#deal_search_keyword').val();
		if(deal_search_keyword == "" || deal_search_keyword == undefined){
			notify("검색하실 제품명을 입력해주세요");
		} else {
			$("#deal_search_input").css({"top":50});
			$("#deal_search_keyword").unbind("blur").bind("blur", function(){
				$(this).val(deal_search_keyword);
				$("#deal_search_btn").fadeOut();
				$("#deal_search_cancle").fadeIn();
			}).blur();

			$.ajax({
		        url: '/deals/get_naver_deals/?keyword='+encodeURIComponent(deal_search_keyword),
		        type: 'GET',
		        error: function(){
		          notify('<i class="fa fa-exclamation-triangle"></i> 네트워크 오류');
		        },
		        success: function(data){
							items = data.shop_result.rss.channel.item;
		        	image_items = data.image_result.rss.channel.item;

							$("#search_deal_result").show();
							if (items != null ){
								var naverDealTemplate = _.template( $('#naver-deal-template').html() );
								$('#naver_deals').html(naverDealTemplate({item: items, is_left: is_left}));
							} else {
								$('#naver_deals').html("<p style='margin:0; line-height:300px; color:#9d9ea1; font-size:15px;'><i class='fa fa-search'></i> 제품 검색결과가 없습니다</p>");
							}
							if (image_items != null ){
								var naverImageTemplate = _.template( $('#naver-image-template').html() );
								$('#naver_images').html(naverImageTemplate({image_items: image_items, is_left: is_left}));
							} else {
								$('#naver_images').html("<p style='margin:0; line-height:300px; color:#9d9ea1; font-size:15px;'><i class='fa fa-search'></i> 이미지 검색결과가 없습니다</p>");
							}

							if (items == null && image_items == null) {
								show_naver_deals();
							} else {
								(items == null && image_items != null) ? show_naver_images() : show_naver_deals();
							}
		        },
		        beforeSend: function(){
							progressStart();
	          },
	          complete: function(){
							progressEnd();
	          }
			});
		}
	}

	function select_deal(product_id, is_left){
		if (items.length > 1) {
			var item = $.grep(items, function(obj) { return obj.productId === product_id; })[0];
		} else {
			var item = items;
		}

		$.ajax({
	        url: '/deals/create_by_naver.json',
	        type: 'POST',
	        data: {item: item},
	        error: function(){
	          notify('<i class="fa fa-exclamation-triangle"></i> 네트워크 오류');
	        },
	        success: function(data){
	        	deal = data.deal;
	        	if (is_left){
							show_image_edit_popup(true, data.id, data.image_url, deal.title, deal.brand, deal.price, deal.link, deal.id);
	        	}else{
							show_image_edit_popup(false, data.id, data.image_url, deal.title, deal.brand, deal.price, deal.link, deal.id);
	        	}
	        	$("#naver_images").html("");
	        	$("#naver_deals").html("");
	        	hide_search_deal_popup();

						var scroll_top = $("#card_overlay").offset().top;
						$("html, body").animate({scrollTop:scroll_top-165},500);
					},
					beforeSend: function(){
						progressStart();
					},
					complete: function(){
						ready_to_submit();
					}
		});
	}

	function select_image(image_url, is_left){
		var deal_search_keyword = $('#deal_search_keyword').val();

		$.ajax({
	        url: "/preview_images.json",
	        type: 'POST',
	        data: {image_url: image_url},
	        error: function(){
	          notify('<i class="fa fa-exclamation-triangle"></i> 네트워크 오류');
	        },
	        success: function(data){
	        	if (is_left){
							show_image_edit_popup(true, data.id, data.image_url, deal_search_keyword);
	        	} else {
							show_image_edit_popup(false, data.id, data.image_url, deal_search_keyword);
	        	}
	        	$("#naver_images").html("");
	        	$("#naver_deals").html("");
	        	hide_search_deal_popup();

						var scroll_top = $("#card_overlay").offset().top;
						$("html, body").animate({scrollTop:scroll_top-165},500);
					},
	        beforeSend: function(){
						progressStart();
					},
					complete: function(){
						ready_to_submit();
					}
		});
	}

	function left_deal_image_upload(){
		$("#card_a_img_overlay span i").removeClass("fa-image").addClass("fa-circle-o-notch fa-spin");
		$("#left_deal_image").click();
	};

	function right_deal_image_upload(){
		$("#card_b_img_overlay span i").removeClass("fa-image").addClass("fa-circle-o-notch fa-spin");
		$("#right_deal_image").click();
	};

	$("#left_deal_image").change(function(){
		var fileObj = $(this);
		$.each( $("#left_deal_image")[0].files, function( i, file ) {
			var formData = new FormData();
		    formData.append('File', file);

		    $.ajax({
		       type: "POST",
		       url: "/preview_images.json",
		       data: formData,
		       contentType: false,
		       processData: false,
					 error: function(){
						 notify('<i class="fa fa-exclamation-triangle"></i> 네트워크 오류');
					 },
		       success: function (data) {
						 show_image_edit_popup(true, data.id, data.image_url);
		       },
					 beforeSend: function(){
						 progressStart();
					 },
					 complete: function(){
						 $("#card_a_img_overlay span i").removeClass("fa-circle-o-notch fa-spin").addClass("fa-image");
						 fileObj.replaceWith(fileObj.clone(true));
					 }
		    }).fail(function (data) {}).done(function () {});
		});
	});

	$("#right_deal_image").change(function(){
		var fileObj = $(this);
		$.each( $("#right_deal_image")[0].files, function( i, file ) {
			var formData = new FormData();
		    formData.append('File', file);

		    $.ajax({
		       type: "POST",
		       url: "/preview_images.json",
		       data: formData,
		       contentType: false,
		       processData: false,
					 error: function(){
						 notify('<i class="fa fa-exclamation-triangle"></i> 네트워크 오류');
					 },
		       success: function (data) {
 						 show_image_edit_popup(false, data.id, data.image_url);
		       },
			  	 beforeSend: function(){
						 progressStart();
           },
           complete: function(){
						 $("#card_b_img_overlay span i").removeClass("fa-circle-o-notch fa-spin").addClass("fa-image");
						 fileObj.replaceWith(fileObj.clone(true));
           }
		    }).fail(function (data) {}).done(function () {});
		});
	});

	function show_card_overlay() {
		$("#card_overlay").slideDown(500, function(){
			$("#card_overlay_open").html("닫기&nbsp;<i class='fa fa-angle-double-up' style='font-size:15px;'></i>");
			$("#card_overlay_open").css("background-color","#f4f4f4").attr("onclick","hide_card_overlay(true); return false;");
			is_card_overlay_opened = true;
		});
	}

	function hide_card_overlay() {
		$("#card_overlay").slideUp(500, function(){
			$("#card_overlay_open").html("직접 입력하기&nbsp;<i class='fa fa-angle-double-down' style='font-size:15px;'></i>");
			$("#card_overlay_open").css("background-color","#fff").attr("onclick","show_card_overlay(true); return false;");
			is_card_overlay_opened = false;
		});
	}

	function show_more_add_info() {
		if ( $("#add_info_1:visible").length == 0 ) {
			$("#add_info_1").slideDown(300);
			return;
		} else if ( $("#add_info_2:visible").length == 0 ) {
			$("#add_info_2").slideDown(300);
			return;
		} else {
			$("#add_info_3").slideDown(300);
			$("#add_info_btn").hide();
			return;
		}
	}

	var check_click = 0;

	function submit_form(){
		if ( $("#ask_category_id").val() == "" || $("#ask_category_id").val() == null ){
			notify('제품 카테고리를 설정해주세요');
			$("#ask_category_id").focus().select();
			return;
		}

		if ( $("#ask_message").val() == "" || $("#ask_message").val() == null ){
			notify('고민하고 있는 상황을 입력해주세요');
			$("#ask_message").focus().select();
			return;
		}

		if ( $("#left_deal_image_btn img").attr("src") == "/images/custom/card_image_preview.png"){
			notify('CARD A 이미지를 추가해주세요');
			$("#card_a_img_overlay").css("background-color","#fdf8f3");
			return;
		}

		if ( $("#left_deal_title").val() == "" || $("#left_deal_title").val() == null ){
			notify('CARD A 제품명을 입력해주세요');
			$("#left_deal_title").focus().select();
			return;
		}

		if ( $("#right_deal_image_btn img").attr("src") == "/images/custom/card_image_preview.png"){
			notify('CARD B 이미지를 추가해주세요');
			$("#card_b_img_overlay").css("background-color","#fdf8f3");
			return;
		}

		if ( $("#right_deal_title").val() == "" || $("#right_deal_title").val() == null ){
			notify('CARD B 제품명을 입력해주세요');
			$("#right_deal_title").focus().select();
			return;
		}
		if (check_click == 0) {
			var left_price = $("#left_deal_price").val();
			var right_price = $("#right_deal_price").val();
			$("#left_deal_price").val(uncomma(left_price));
			$("#right_deal_price").val(uncomma(right_price));
			$("#new_ask").submit();
			check_click = check_click + 1;
		} else {
			return;
		}
	}

	function edit_form(){
		if ( $("#ask_category_id").val() == "" || $("#ask_category_id").val() == null ){
			notify('제품 카테고리를 설정해주세요');
			$("#ask_category_id").focus().select();
			return;
		}

		if ( $("#ask_message").val() == "" || $("#ask_message").val() == null ){
			notify('고민하고 있는 상황을 입력해주세요');
			$("#ask_message").focus().select();
			return;
		}

		if ( $("#left_deal_title").val() == "" || $("#left_deal_title").val() == null ){
			notify('CARD A 제품명을 입력해주세요');
			$("#left_deal_title").focus().select();
			return;
		}

		if ( $("#right_deal_title").val() == "" || $("#right_deal_title").val() == null ){
			notify('CARD B 제품명을 입력해주세요');
			$("#right_deal_title").focus().select();
			return;
		}
		var left_price = $("#left_deal_price").val();
		var right_price = $("#right_deal_price").val();
		$("#left_deal_price").val(uncomma(left_price));
		$("#right_deal_price").val(uncomma(right_price));
		$(".edit_ask").submit();
	}

	$("#ask_category_id").find("option:eq(0)").attr("disabled",true);
	$("#ask_category_id").one("focus",function(){ $(this).css("color","#666"); });

	// 입력중 해시태그 강조 추가
	var textarea_font = $("#ask_message").css("font");
	$("#hashtag_highlights").css("font",textarea_font);

	function applyHighlights(text) {
		text = text.replace(/\n$/g, '\n\n').replace(/#([0-9a-zA-Zㄱ-ㅎㅏ-ㅣ가-힣_]*)/g, '<mark>$&</mark>');
		// if (isIE) {
    // 	text = text.replace(/ /g, ' <wbr>');
  	// }
		return text;
	}

	function handleInput() {
		var text = $("#ask_message").val();
		var highlightedText = applyHighlights(text);
		$("#hashtag_highlights").html(highlightedText);
	}

	function handleScroll() {
		var scrollTop = $("#ask_message").scrollTop();
		$("#hashtag_backdrop").scrollTop(scrollTop);
		var scrollLeft = $("#ask_message").scrollLeft();
		$("#hashtag_backdrop").scrollLeft(scrollLeft);
	}

	function bindEvents() {
		$("#ask_message").on({
			'input': handleInput,
			'scroll': handleScroll
		});
	}

	if (isIOS) {
		$("#hashtag_highlights").css({
	    'padding-left': '+=3px',
	    'padding-right': '+=3px'
	  });
	}

	bindEvents();
	handleInput();

	// 금액 필드 콤마찍기
	function comma(str) {
    str = String(str);
    return str.replace(/(\d)(?=(?:\d{3})+(?!\d))/g, '$1,');
	}
	function uncomma(str) {
    str = String(str);
    return str.replace(/[^\d]+/g, '');
	}
	function inputNumberFormat(obj) {
	  obj.value = comma(uncomma(obj.value));
	}

	if (isAndroid || isAndroidApp) {
		$("#left_deal_price, #right_deal_price").attr("type","tel");
	}

	var left_deal_price = <%= @left_ask_deal && @left_ask_deal.price ? @left_ask_deal.price : 'null' %>;
	var right_deal_price = <%= @right_ask_deal && @right_ask_deal.price ? @right_ask_deal.price : 'null' %>;
	$("#left_deal_price").val(left_deal_price).attr("onkeyup","inputNumberFormat(this)");
	$("#right_deal_price").val(right_deal_price).attr("onkeyup","inputNumberFormat(this)");

	// 제출버튼 필수입력필드 입력해야 활성화되도록
	function ready_to_submit() {
    if (
			$("#ask_category_id").val() != null && $("#ask_message").val() != "" &&
			$("#left_deal_image_btn img").attr("src") != "/images/custom/card_image_preview.png" && $("#right_deal_image_btn img").attr("src") != "/images/custom/card_image_preview.png" &&
			$("#left_deal_title").val() != "" && $("#right_deal_title").val() != ""
    ) {
			$("#ask_submit_btn_area").css({"bottom":"0px"});
      $("#ask_submit_btn").css("background-color","#ee6e01");
    } else {
			$("#ask_submit_btn_area").css({"bottom":"-40px"});
      $("#ask_submit_btn").css("background-color","#9d9ea1");
    }
  }

	$("#ask_message").attr("onkeyup","ready_to_submit(); return false;");
	$("#left_deal_title").attr("onkeyup","ready_to_submit(); return false;");
	$("#right_deal_title").attr("onkeyup","ready_to_submit(); return false;");
  $("#new_ask").on("change",function(){ ready_to_submit(); })
	$("#edit_ask").on("change",function(){ ready_to_submit(); })

	// 입력중 텍스트 길이 표시
	$('#ask_message').keyup(function () {
		var inputLength = $(this).val().length;
	 		$('#text_counter').html(inputLength+" 글자");
		if ( inputLength <= 80) {
			$('#text_counter').css('color','#9d9ea1');
			$('#text_counter_info').html('<i class="fa fa-info-circle"></i>&nbsp;기본화면에는 80자까지 보여집니다.');
		} else if ( inputLength > 80) {
			$('#text_counter').css('color','#ee6e01');
			$('#text_counter_info').html('<i class="fa fa-exclamation-triangle"></i>&nbsp;80자를 초과하는 내용은 가려집니다.');
		}
	});

	//
	$(window).bind('beforeunload', function(event){
		return "게시글 작성을 중단하시겠습니까?";
	});
	$(document).on("submit", "form", function(event){
		$(window).off('beforeunload');
	});
	//

</script>

<div id="image_edit_popup_bg" onclick="back_button(); $('#image_edit_submit').focus(); return false;" style="position:fixed;left:-100%; top:-100%; width:300%; height:300%; background-color:rgba(0,0,0,0.9); z-index:12; display:none;"></div>
<div id="image_edit_popup" style="width:inherit; z-index:13; position:fixed; top:0px; overflow-y:auto; -webkit-overflow-scrolling:touch; display:none;" ontouchmove="return false;">
	<div style="padding:20px 10px;" ontouchmove="return false;">
		<div class="table_div" style="margin-bottom:0; padding:0 12px 0; height:40px;" ontouchmove="return false;">
			<a href="#" onclick="back_button(); $('#image_edit_submit').focus(); return false;" style="position:absolute; right:0px; top:0px; width:40px; height:40px; text-align:center;"><span style="display:inline-block; box-sizing:border-box; width:40px; height:40px; color:#fff; font-size:35px;">&times;</span></a>
			<span id="image_edit_info" style="display:block; color:#9d9ea1; font-size:12px; line-height:40px; height:40px; text-align:center; float:left; margin-right:10px;"><i class='fa fa-arrows'></i>&nbsp;이동&nbsp;&nbsp;&nbsp;<i class='fa fa-arrows-alt'></i>&nbsp;확대</span>
			<div id="image_edit_tooltip" class="tooltip_area animated pulse" style="width:calc(100% - 50px); max-width:250px; left:0%; bottom:20%;">
				<div class="tooltip_arrow bottom" style="left:12px; border-top-color:#ffcc5a;"></div>
				<div class="tooltip_content" style="color:#333; background-color:#ffcc5a;"><i class="fa fa-arrows"></i> 터치하여 이동 <i class="fa fa-arrows-alt"></i> 멀티터치/휠로 확대&middot;축소</div>
			</div>
			<span style="display:block; color:#9d9ea1; font-size:12px; line-height:40px; height:40px; text-align:center; float:left;"><i class='fa fa-file-picture-o'></i>&nbsp;<b id="image_edit_w"></b>&nbsp;&times;&nbsp;<b id="image_edit_h"></b></span>
		</div>
		<div id="image_edit_area">
			<img id="image_to_edit" src="/images/custom/card_image_preview.png" alt="" style="width:500px; min-width:100%; max-width:100%;">
		</div>
		<span class="seperate_line" style="background-color:#333;"></span>
		<div class="table_div" style="margin:10px 0;" ontouchmove="return false;">
			<a id="image_edit_submit" href="#" onclick="return false;" style="display:block; box-sizing:border-box; width:100%; height:50px; line-height:50px; font-size:12px; background-color:#fff; text-align:center; padding:0 10px; outline:none; border-radius:3px;">
				<mark id="image_edit_submit_info" style="background-color:transparent; color:#666; display:inline-block; font-size:15px;">이미지 업로드</mark>&nbsp;&nbsp;<i class="fa fa-upload" style="color:#ee6e01; font-size:20px; padding:15px 5px;"></i>
			</a>
		</div>
		<div class="table_div" style="padding:0 10px 0px; text-align:left; height:25px; margin:10px 0;" ontouchmove="return false;">
			<a href="#" onclick="reset_image_cropper(); return false;">
				<span id="image_edit_reset" style="color:#fff; font-size:12px; line-height:28px; display:none;"><i class="fa fa-refresh" style="font-size:14px;"></i>&nbsp;초기화하기</span>
				<span id="image_edit_warning" style="color:#383838; background-color:#ffcc5a; font-size:12px; text-align:center; padding:5px 10px; border-radius:15px; position:absolute; top:0; right:8px; display:none;"><i class="fa fa-exclamation-triangle"></i>&nbsp;이미지 품질이 안 좋아요 <b id="sad_emoji" style="display:inline-block;">:(</b></span>
				<span id="image_edit_danger" style="color:#fff; background-color:#ee6e01; font-size:12px; text-align:center; padding:5px 10px; border-radius:15px; position:absolute; top:0; right:8px; display:none;"><i class="fa fa-ban"></i>&nbsp;이미지 품질이 너무 안 좋습니다 <b id="angry_emoji" style="display:inline-block;"><i class="fa fa-frown-o"></i></b></span>
			</a>
			<span id="image_edit_ok" style="color:#fff; background-color:mediumseagreen; font-size:12px; text-align:center; padding:5px 10px; border-radius:15px; position:absolute; top:0; right:8px;"><i class="fa fa-heart"></i>&nbsp;좋습니다요 <b id="happy_emoji" style="display:inline-block;">:)</b></span>
		</div>
	</div>
</div>

<script type="text/javascript">
	var image_cropper;

	function create_image_cropper() {
		var image = document.getElementById('image_to_edit');
		var container_square_size = $(window).width() > 520 ? 500 : $(window).width() - 20;
		var crop_options = {
			viewMode: 1,
			dragMode: 'move',
			aspectRatio: 1 / 1,
			highlight: false,
			// modal: false,
			guides: false,
			background: false,
			checkOrientation: false,
			// responsive: false,
			restore: false,
			autoCropArea: 1,
			cropBoxMovable: false,
			cropBoxResizable: false,
			minContainerWidth: container_square_size,
			minContainerHeight: container_square_size,
			minCropBoxWidth: container_square_size,
			minCropBoxHeight: container_square_size,
			toggleDragModeOnDblclick: false,
			ready: function() {
				var image_data = this.cropper.getImageData(),
						img_w = image_data.naturalWidth,
						img_h = image_data.naturalHeight;
				var crop_box_data = this.cropper.getCropBoxData(),
						crop_w = crop_box_data.width,
						crop_h = crop_box_data.height;
				var container_data = this.cropper.getContainerData(),
						cont_w = container_data.width,
						cont_h = container_data.height;
				if (img_w > img_h) { // 이미지가 가로로 길 때
					this.cropper.zoomTo(cont_h / img_h);
					this.cropper.setCropBoxData({
						left:0, top:0, width:cont_h, height:cont_h
					});
				} else if (img_w < img_h) { // 이미지가 세로로 길 때
					this.cropper.setCanvasData({
						left:0, top: -((cont_h - crop_h)/2), width:cont_w, height:cont_w
					});
					this.cropper.setCropBoxData({
						left:0, top:0, width:cont_w, height:cont_w
					});
				} else {
					this.cropper.setCropBoxData({
						left:0, top:0
					});
				}
				$("#image_edit_submit").focus();
				$(".cropper-container").css({"width":container_square_size, "height":container_square_size, "max-width":container_square_size, "max-height":container_square_size});
			},
			crop: function() {
				var w = Math.round(this.cropper.getData().width);
				var h = Math.round(this.cropper.getData().height);
				$("#image_edit_w").html(w);
				$("#image_edit_h").html(h);
				if (w < 100 || h < 100) {
					$("#image_edit_reset").fadeIn();
					$("#image_edit_ok").hide();
					$("#image_edit_warning").hide();
					$("#image_edit_danger").fadeIn();
					$("#angry_emoji").animateCss("rubberBand");
					$(".cropper-face").css({"opacity":"0.6", "background-color":"#ee6e01"});
					$(".cropper-view-box").css({"outline-color":"#ee6e01"});
				} else if (w < 300 || h < 300) {
					$("#image_edit_reset").fadeIn();
					$("#image_edit_ok").hide();
					$("#image_edit_warning").fadeIn();
					$("#image_edit_danger").hide();
					$("#sad_emoji").animateCss("wobble");
					$(".cropper-face").css({"opacity":"0.4", "background-color":"#ffe4a9"});
					$(".cropper-view-box").css({"outline-color":"#ffcc5a"});
				} else {
					$("#image_edit_reset").fadeOut();
					$("#image_edit_ok").fadeIn();
					$("#image_edit_warning").fadeOut();
					$("#image_edit_danger").fadeOut();
					$("#happy_emoji").animateCss("jello");
					$(".cropper-face").css({"opacity":"0", "background-color":"#fff"});
					$(".cropper-view-box").css({"outline-color":"#fff"});
				};
			},
			cropend: function() {
				$("#image_edit_submit_info").next("i").animateCss("jello");
			}
		}
		image_cropper = new Cropper(image, crop_options);
	};

	function show_image_edit_popup(is_left, preview_image_id, image_url, title, brand, price, link, deal_id) {
		disableScroll();
		$("#image_edit_popup_bg").show().animateCss("fadeIn");

		$("#image_to_edit").attr("src",image_url);

		$("#image_edit_submit, #image_edit_ok").attr("onclick","image_edit_submit("+is_left+", "+preview_image_id+", '"+title+"', '"+brand+"', "+price+", '"+link+"', "+deal_id+"); return false;");
		create_image_cropper();

		is_search_deal_opened ? history.replaceState(null, null, null) : history.pushState(null, null, null);
		is_image_edit_opened = true;
    overlay_st = $(window).scrollTop();

		$("#image_to_edit").one("load", function(){
			$("#image_edit_popup").show().animateCss("bounceInDown");
			progressEnd();
		});

		$(window).bind("resize", function(){
			var container_square_size = $(window).width() > 520 ? 500 : $(window).width() - 20;
			$(".cropper-container").animate({"width":container_square_size, "height":container_square_size, "max-width":container_square_size, "max-height":container_square_size},10,function(){
				image_cropper.setCropBoxData({
					left:0, top:0
				});
			});
		}).resize();
	}

	function hide_image_edit_popup() {
		enableScroll();
		$("#image_edit_popup").hide();
		$("#image_edit_popup_bg").hide();
		image_cropper.clear().reset().destroy();
		$("#image_to_edit").attr("src","/images/custom/card_image_preview.png");
		$("#image_edit_submit, #image_edit_ok").attr("onclick","return false;");

		is_image_edit_opened = false;
		window.scrollTo(0,overlay_st);
	}

	var image_edit_area = document.getElementById('image_edit_area');
	var image_edit_area_hammer = new Hammer(image_edit_area);
	image_edit_area_hammer.on("doubletap", function(){
		resize_image_cropper();
	});

	function resize_image_cropper() {
		var res = 300;
		var img_w = image_cropper.getImageData().naturalWidth;
		var img_h = image_cropper.getImageData().naturalHeight;
		var cont_w = image_cropper.getContainerData().width;
		var cont_h = image_cropper.getContainerData().height;
		var w = image_cropper.getData().width;
		var h = image_cropper.getData().height;

		if (img_w > img_h && img_h >= res) {
			if (h != res) {
				image_cropper.zoomTo(cont_h/res);
				var canv_w = image_cropper.getCanvasData().width;
				var canv_h = image_cropper.getCanvasData().height;
				var crop_w = image_cropper.getCropBoxData().width;
				var crop_h = image_cropper.getCropBoxData().height;
				image_cropper.setCanvasData({left:-(canv_w-crop_w)/2,top:-(canv_h-crop_h)/2});
			} else {
				image_cropper.zoomTo(cont_h/img_h);
				var canv_w = image_cropper.getCanvasData().width;
				var crop_w = image_cropper.getCropBoxData().width;
				image_cropper.setCanvasData({left:-(canv_w-crop_w)/2,top:0});
			}
		} else if (img_w < img_h && img_w >= res) {
			if (w != res) {
				image_cropper.zoomTo(cont_w/res);
				var canv_w = image_cropper.getCanvasData().width;
				var canv_h = image_cropper.getCanvasData().height;
				var crop_w = image_cropper.getCropBoxData().width;
				var crop_h = image_cropper.getCropBoxData().height;
				image_cropper.setCanvasData({left:-(canv_w-crop_w)/2,top:-(canv_h-crop_h)/2});
			} else {
				image_cropper.zoomTo(cont_w/img_w);
				var canv_h = image_cropper.getCanvasData().height;
				var crop_h = image_cropper.getCropBoxData().height;
				image_cropper.setCanvasData({left:0,top:-(canv_h-crop_h)/2});
			}
		} else if (img_w == img_h && img_w >= res) {
			if (w != res) {
				image_cropper.zoomTo(cont_w/res);
				var canv_w = image_cropper.getCanvasData().width;
				var canv_h = image_cropper.getCanvasData().height;
				var crop_w = image_cropper.getCropBoxData().width;
				var crop_h = image_cropper.getCropBoxData().height;
				image_cropper.setCanvasData({left:-(canv_w-crop_w)/2,top:-(canv_h-crop_h)/2});
			} else {
				image_cropper.zoomTo(cont_w/img_w);
				var canv_h = image_cropper.getCanvasData().height;
				var crop_h = image_cropper.getCropBoxData().height;
				image_cropper.setCanvasData({left:0,top:-(canv_h-crop_h)/2});
			}
		} else {
			notify("권장 해상도보다 작습니다");
		}
		$('#image_edit_submit').focus();
	}

	function reset_image_cropper() {
		if (confirm("이미지 편집을 초기화하시겠어요?")) {
			var image_data = image_cropper.getImageData(),
					img_w = image_data.naturalWidth,
					img_h = image_data.naturalHeight;
			var crop_box_data = image_cropper.getCropBoxData(),
					crop_w = crop_box_data.width,
					crop_h = crop_box_data.height;
			var container_data = image_cropper.getContainerData(),
					cont_w = container_data.width,
					cont_h = container_data.height;
			image_cropper.reset();
			if (img_w > img_h) { // 이미지가 가로로 길 때
				image_cropper.zoomTo(cont_h / img_h);
				image_cropper.setCropBoxData({
					left:0, top:0, width:cont_h, height:cont_h
				});
			} else if (img_w < img_h) { // 이미지가 세로로 길 때
				image_cropper.setCropBoxData({
					left:0, top:0
				});
				image_cropper.setCanvasData({
					left:0, top: -((cont_h - crop_h)/2), width:cont_w, height:cont_w
				});
			} else {
				image_cropper.setCropBoxData({
					left:0, top:0
				});
			}
			$('#image_edit_submit').focus();
		}
	}

	function image_edit_submit(is_left, preview_image_id, title, brand, price, link, deal_id) {
		var crop_data = image_cropper.getData();
		var x = crop_data.x,
				y = crop_data.y,
				w = crop_data.width,
				h = crop_data.height;

		if ($("#image_edit_warning:visible").length > 0) {
			if (!confirm("이미지 품질이 낮습니다\n계속하시겠어요?")) return false;
		} else if ($("#image_edit_danger:visible").length > 0) {
			alert("이미지 품질이 너무 낮습니다\n이미지를 수정하거나 교체해주세요!");
			return false;
		}

		hide_image_edit_popup();

		$.ajax({
	        url: "/preview_images/crop.json",
	        type: 'POST',
	        data: {preview_image_id: preview_image_id, crop_x: x, crop_y: y, crop_w: w, crop_h: h},
	        error: function(){
	          notify('<i class="fa fa-exclamation-triangle"></i> 네트워크 오류');
	        },
	        success: function(data){
						if (is_left) {
							$("#left_deal_image_btn img").attr("src",data.image_url);
							$("#card_a_img_overlay").fadeOut(200);
							$("#left_deal_image_id").val(preview_image_id);

							if (deal_id == undefined) {
								if (title != "undefined" && $("#left_deal_title").val() == '') $("#left_deal_title").val(title);
							} else {
								title == "null" ? $("#left_deal_title").val('') : $("#left_deal_title").val(title);
								brand == "null" ? $("#left_deal_brand").val('') : $("#left_deal_brand").val(brand);
								price == null ? $("#left_deal_price").val('') : $("#left_deal_price").val(price);
								link == "null" ? $("#left_deal_link").val('') : $("#left_deal_link").val(link);
								$("#left_deal_deal_id").val(deal_id);
							}
						} else {
							$("#right_deal_image_btn img").attr("src",data.image_url);
							$("#card_b_img_overlay").fadeOut(200);
							$("#right_deal_image_id").val(preview_image_id);

							if (deal_id == undefined) {
								if (title != "undefined" && $("#right_deal_title").val() == '') $("#right_deal_title").val(title);
							} else {
								title == "null" ? $("#right_deal_title").val('') : $("#right_deal_title").val(title);
								brand == "null" ? $("#right_deal_brand").val('') : $("#right_deal_brand").val(brand);
								price == null ? $("#right_deal_price").val('') : $("#right_deal_price").val(price);
								link == "null" ? $("#right_deal_link").val('') : $("#right_deal_link").val(link);
								$("#right_deal_deal_id").val(deal_id);
							}
						};
					},
	        beforeSend: function(){
						progressStart();
					},
					complete: function(){
						progressEnd();
						ready_to_submit();
					}
		});
	}
</script>
